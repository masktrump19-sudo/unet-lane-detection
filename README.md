# U-Netè½¦é“çº¿æ£€æµ‹ç®—æ³•

> åŸºäºæ·±åº¦å­¦ä¹ çš„æ™ºèƒ½è½¦è½¦é“çº¿è¯­ä¹‰åˆ†å‰²ç³»ç»Ÿï¼Œè§£å†³ä¼ ç»ŸHSVæ–¹æ³•åœ¨å…‰ç…§å˜åŒ–å’Œç™½å¹³è¡¡æ¼‚ç§»ä¸‹çš„æ£€æµ‹å¤±æ•ˆé—®é¢˜ã€‚

[![License](https://img.shields.io/badge/License-MIT-blue.svg)]()
[![Platform](https://img.shields.io/badge/Platform-RK3588-green.svg)]()
[![ROS](https://img.shields.io/badge/ROS-Noetic-orange.svg)]()

---

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®ç®€ä»‹](#é¡¹ç›®ç®€ä»‹)
- [æ•ˆæœå±•ç¤º](#æ•ˆæœå±•ç¤º)
- [ä¸ä¼ ç»ŸHSVæ–¹æ³•å¯¹æ¯”](#ä¸ä¼ ç»Ÿhsvæ–¹æ³•å¯¹æ¯”)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ•°æ®é›†å‡†å¤‡](#æ•°æ®é›†å‡†å¤‡)
- [æ¨¡å‹è®­ç»ƒ](#æ¨¡å‹è®­ç»ƒ)
- [æ¨¡å‹éƒ¨ç½²](#æ¨¡å‹éƒ¨ç½²)
- [ROSèŠ‚ç‚¹ä½¿ç”¨](#rosèŠ‚ç‚¹ä½¿ç”¨)
- [æ€§èƒ½æŒ‡æ ‡](#æ€§èƒ½æŒ‡æ ‡)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—)
- [è‡´è°¢](#è‡´è°¢)
- [è®¸å¯è¯](#è®¸å¯è¯)

---

## é¡¹ç›®ç®€ä»‹

### èƒŒæ™¯ä¸åŠ¨æœº

åœ¨æ™ºèƒ½è½¦ç«èµ›ï¼ˆå¦‚å…¨å›½å¤§å­¦ç”Ÿæ™ºèƒ½æ±½è½¦ç«èµ›ï¼‰ä¸­ï¼Œ**è½¦é“çº¿æ£€æµ‹**æ˜¯å®ç°è‡ªä¸»å¾ªè¿¹çš„æ ¸å¿ƒæŠ€æœ¯ã€‚ä¼ ç»Ÿæ–¹æ¡ˆæ™®éé‡‡ç”¨**HSVé¢œè‰²é˜ˆå€¼åˆ†å‰²**æ–¹æ³•ï¼š

```python
# ä¼ ç»ŸHSVæ–¹æ³•çš„å…¸å‹ä»£ç 
hsv_white_lower = [0, 0, 185]    # ç™½è‰²ä¸‹é™
hsv_white_upper = [180, 40, 255]  # ç™½è‰²ä¸Šé™
mask = cv2.inRange(hsv_image, lower, upper)
```

ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å­˜åœ¨**è‡´å‘½ç¼ºé™·**ï¼š

| é—®é¢˜ | è¡¨ç° | åæœ |
|-----|------|-----|
| **ç™½å¹³è¡¡æ¼‚ç§»** | æ‘„åƒå¤´è‡ªåŠ¨ç™½å¹³è¡¡å¯¼è‡´ç”»é¢æ•´ä½“åè“/åé»„ | ç™½è‰²è½¦é“çº¿é¢œè‰²è¶…å‡ºé˜ˆå€¼èŒƒå›´ï¼Œæ£€æµ‹å¤±è´¥ |
| **å…‰ç…§æ•æ„Ÿ** | å¼ºå…‰/å¼±å…‰/ä¾§å…‰ä¸‹é¢œè‰²å‘ˆç°ä¸ä¸€è‡´ | éœ€è¦é¢‘ç¹æ‰‹åŠ¨è°ƒå‚ï¼Œæ¯”èµ›ä¸­æ— æ³•é€‚åº” |
| **å‚æ•°è„†å¼±** | HSVé˜ˆå€¼æ˜¯"ç¡¬ç¼–ç "çš„å›ºå®šå€¼ | æ¢åœºåœ°ã€æ¢æ—¶é—´æ®µéƒ½å¯èƒ½éœ€è¦é‡æ–°æ ‡å®š |

**æˆ‘çš„äº²èº«ç»å†**ï¼šåœ¨æ¯”èµ›è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæ˜æ˜ä¸Šåˆè°ƒå¥½çš„å‚æ•°ï¼Œä¸‹åˆå…‰çº¿å˜åŒ–åå°±å®Œå…¨å¤±æ•ˆï¼Œè½¦è¾†é¢‘ç¹å†²å‡ºèµ›é“ã€‚æ‘„åƒå¤´çš„è‡ªåŠ¨ç™½å¹³è¡¡æ›´æ˜¯"å¸®å€’å¿™"ï¼Œè®©åŸæœ¬ç¨³å®šçš„æ£€æµ‹å˜å¾—ä¸å¯é¢„æµ‹ã€‚

#### ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼šU-Netè¯­ä¹‰åˆ†å‰²

ä¸å…¶å‘Šè¯‰æœºå™¨"ç™½è‰²=è½¦é“çº¿"è¿™æ ·è„†å¼±çš„è§„åˆ™ï¼Œä¸å¦‚**è®©æœºå™¨è‡ªå·±å­¦ä¹ ä»€ä¹ˆæ˜¯è½¦é“çº¿**ã€‚

é€šè¿‡æ ‡æ³¨å¤§é‡è®­ç»ƒæ•°æ®ï¼ŒU-Netæ¨¡å‹å­¦åˆ°çš„æ˜¯ï¼š
- âœ… è½¦é“çº¿çš„**å½¢çŠ¶ç‰¹å¾**ï¼ˆç»†é•¿çº¿æ¡ï¼‰
- âœ… è½¦é“çº¿çš„**çº¹ç†ç‰¹å¾**ï¼ˆä¸èƒŒæ™¯çš„è¾¹ç¼˜å·®å¼‚ï¼‰
- âœ… è½¦é“çº¿çš„**ä½ç½®ç‰¹å¾**ï¼ˆé€šå¸¸åœ¨åœ°é¢ç‰¹å®šåŒºåŸŸï¼‰
- âœ… è½¦é“çº¿çš„**ä¸Šä¸‹æ–‡ç‰¹å¾**ï¼ˆä¸¤ä¾§æ˜¯èµ›é“èƒŒæ™¯ï¼‰

è¿™äº›ç‰¹å¾åœ¨å…‰ç…§å˜åŒ–ã€é¢œè‰²æ¼‚ç§»æ—¶ä¾ç„¶å­˜åœ¨ï¼Œå› æ­¤æ£€æµ‹æ›´åŠ é²æ£’ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å…‰ç…§è‡ªé€‚åº”**ï¼šè®­ç»ƒæ•°æ®æ¶µç›–å¤šç§å…‰ç…§æ¡ä»¶ï¼Œæ¨¡å‹è‡ªåŠ¨å­¦ä¼šé€‚åº”
- âœ… **ç™½å¹³è¡¡é²æ£’**ï¼šä¸ä¾èµ–é¢œè‰²é˜ˆå€¼ï¼Œé¢œè‰²æ¼‚ç§»ä¸å½±å“æ£€æµ‹
- âœ… **å®æ—¶æ¨ç†**ï¼šRK3588 NPUåŠ é€Ÿï¼Œè¾¾åˆ° **30+ FPS** å®æ—¶æ€§èƒ½
- âœ… **ROSé›†æˆ**ï¼šæä¾›å³æ’å³ç”¨çš„ROSèŠ‚ç‚¹ï¼Œè¾“å‡ºäºŒå€¼åŒ–æ©ç è¯é¢˜
- âœ… **ç«¯åˆ°ç«¯æ–¹æ¡ˆ**ï¼šä»æ•°æ®æ ‡æ³¨ã€æ¨¡å‹è®­ç»ƒåˆ°NPUéƒ¨ç½²çš„å®Œæ•´æµç¨‹
- âœ… **INT8é‡åŒ–**ï¼šæ¨¡å‹ä½“ç§¯å°ï¼Œæ¨ç†é€Ÿåº¦å¿«ï¼Œç²¾åº¦æŸå¤±å¯æ§

### é€‚ç”¨åœºæ™¯

| åœºæ™¯ | æè¿° | ç‰¹ç‚¹ |
|-----|------|-----|
| **æ™ºèƒ½è½¦ç«èµ›** | è“è‰²åº•å¸ƒ + ç™½è‰²è½¦é“çº¿èµ›é“ | æœ¬é¡¹ç›®çš„ä¸»è¦ç›®æ ‡åœºæ™¯ |
| **å®¤å†…AGV** | å·¥å‚/ä»“åº“åœ°é¢å¯¼å¼•çº¿æ£€æµ‹ | éœ€è¦é€‚åº”å¤æ‚å…‰ç…§ç¯å¢ƒ |
| **æ•™è‚²æœºå™¨äºº** | å·¡çº¿å°è½¦ã€ROSæ•™å­¦å¹³å° | éœ€è¦ç¨³å®šå¯é çš„æ£€æµ‹æ–¹æ¡ˆ |
| **è‡ªå®šä¹‰åœºæ™¯** | ä»»ä½•éœ€è¦çº¿æ¡æ£€æµ‹çš„åº”ç”¨ | å¯é€šè¿‡é‡æ–°è®­ç»ƒé€‚é… |

### æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æŠ€æœ¯æ ˆæ¦‚è§ˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¡¬ä»¶å¹³å°    â”‚  RK3588 (6 TOPS NPU)                     â”‚
â”‚  æ“ä½œç³»ç»Ÿ    â”‚  Ubuntu 20.04                            â”‚
â”‚  ä¸­é—´ä»¶      â”‚  ROS Noetic                              â”‚
â”‚  è®­ç»ƒæ¡†æ¶    â”‚  PyTorch                                 â”‚
â”‚  éƒ¨ç½²æ¡†æ¶    â”‚  RKNN-Toolkit2                           â”‚
â”‚  ç½‘ç»œç»“æ„    â”‚  U-Net (ç¼–ç å™¨-è§£ç å™¨)                    â”‚
â”‚  é‡åŒ–æ–¹å¼    â”‚  INT8 é‡åŒ–                               â”‚
â”‚  è¾“å…¥åˆ†è¾¨ç‡  â”‚  224 Ã— 224 Ã— 3                           â”‚
â”‚  è¾“å‡ºæ ¼å¼    â”‚  224 Ã— 224 Ã— 1 (äºŒå€¼æ©ç )                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•ˆæœå±•ç¤º

### æ£€æµ‹æ•ˆæœå¯¹æ¯”

ä¸‹å›¾å±•ç¤ºäº†ä¼ ç»ŸHSVæ–¹æ³•ä¸U-Netæ–¹æ³•çš„æ£€æµ‹æ•ˆæœå¯¹æ¯”ï¼š

| åŸå§‹å›¾åƒ | HSVæ–¹æ³•ç»“æœ | U-Netæ–¹æ³•ç»“æœ |
|:--------:|:-----------:|:-------------:|
| ![åŸå›¾](assets/demo/normal_raw.jpg) | ![HSV](assets/demo/normal_hsv.jpg) | ![UNet](assets/demo/normal_unet.jpg) |

### æ•ˆæœè¯´æ˜

| åœºæ™¯ | HSVæ–¹æ³•è¡¨ç° | U-Netæ–¹æ³•è¡¨ç° |
|:-----|:-----------|:--------------|
| æ­£å¸¸å…‰ç…§ | âœ… æ£€æµ‹æ­£å¸¸ | âœ… æ£€æµ‹æ­£å¸¸ |
| å¼ºå…‰ç…§å°„ | âš ï¸ éƒ¨åˆ†è¿‡æ›åŒºåŸŸä¸¢å¤± | âœ… ç¨³å®šæ£€æµ‹ |
| ç™½å¹³è¡¡åé»„ | âŒ å¤§é¢ç§¯æ£€æµ‹å¤±è´¥ | âœ… ç¨³å®šæ£€æµ‹ |
| ç™½å¹³è¡¡åè“ | âŒ å‡ ä¹å®Œå…¨å¤±æ•ˆ | âœ… ç¨³å®šæ£€æµ‹ |
| é˜´å½±é®æŒ¡ | âš ï¸ é˜´å½±åŒºåŸŸä¸¢å¤± | âœ… åŸºæœ¬å®Œæ•´ |

### è§†é¢‘æ¼”ç¤º

#### ğŸ¥ æ£€æµ‹æ•ˆæœæ¼”ç¤º

https://github.com/user-attachments/assets/result.mp4

> ğŸ“¹ æ¼”ç¤ºè§†é¢‘å±•ç¤ºäº†U-Netè½¦é“çº¿æ£€æµ‹çš„å®æ—¶æ•ˆæœ

### é¸Ÿç°å›¾å¯è§†åŒ–

ç³»ç»Ÿè¾“å‡ºçš„é¸Ÿç°å›¾ï¼ˆé€†é€è§†å˜æ¢åï¼‰æ•ˆæœï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åŸå§‹æ‘„åƒå¤´è§†è§’                â”‚
â”‚                                        â”‚
â”‚         /              \               â”‚
â”‚        /   è½¦é“çº¿       \              â”‚
â”‚       /                  \             â”‚
â”‚      /____________________\            â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ é€†é€è§†å˜æ¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é¸Ÿç°å›¾è§†è§’                   â”‚
â”‚                                        â”‚
â”‚      |                    |            â”‚
â”‚      |     è½¦é“çº¿         |            â”‚
â”‚      |                    |            â”‚
â”‚      |____________________|            â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| æœªä½¿ç”¨IPM | ä½¿ç”¨IPMå |
|:--------:|:-----------:|
| ![éIPM](assets/demo/No_IPM.png) | ![IPM](assets/demo/IPM.jpg) |

> é¸Ÿç°å›¾å˜æ¢å¯ä»¥æ¶ˆé™¤é€è§†å½±å“ï¼Œä½¿è½¦é“çº¿å¹³è¡Œï¼Œä¾¿äºåç»­å¤„ç†

---

## ä¸ä¼ ç»ŸHSVæ–¹æ³•å¯¹æ¯”

### æ–¹æ³•åŸç†å¯¹æ¯”

#### ä¼ ç»ŸHSVé¢œè‰²é˜ˆå€¼æ–¹æ³•

**åŸç†**ï¼šå°†å›¾åƒä»BGRé¢œè‰²ç©ºé—´è½¬æ¢åˆ°HSVé¢œè‰²ç©ºé—´ï¼Œé€šè¿‡è®¾å®šé¢œè‰²é˜ˆå€¼èŒƒå›´æ¥åˆ†å‰²ç›®æ ‡åŒºåŸŸã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HSVæ–¹æ³•å¤„ç†æµç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸå§‹å›¾åƒ (BGR)                                            â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“                                                    â”‚
â”‚   cv2.cvtColor(BGR â†’ HSV)                                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚   â”‚  HSVé˜ˆå€¼åˆ¤æ–­ (ç¡¬ç¼–ç )               â”‚                   â”‚
â”‚   â”‚  H: 0~180   (è‰²è°ƒ)                  â”‚                   â”‚
â”‚   â”‚  S: 0~40    (é¥±å’Œåº¦)                â”‚                   â”‚
â”‚   â”‚  V: 185~255 (äº®åº¦)                  â”‚                   â”‚
â”‚   â”‚                                     â”‚                   â”‚
â”‚   â”‚  if (H,S,V) in range â†’ ç™½è‰²(255)    â”‚                   â”‚
â”‚   â”‚  else â†’ é»‘è‰²(0)                     â”‚                   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“                                                    â”‚
â”‚   äºŒå€¼åŒ–æ©ç                                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹**ï¼ˆæ‘˜è‡ªæœ¬é¡¹ç›® `follow_line.py`ï¼‰ï¼š

```python
def extract_white_lanes(self, image):
    """æå–ç™½è‰²è½¦é“çº¿ - ä¼ ç»ŸHSVæ–¹æ³•"""
    # è½¬æ¢åˆ°HSVé¢œè‰²ç©ºé—´
    hsv = cv2.cvtColor(image, cv2.COLOR_BGR2HSV)
    
    # ç¡¬ç¼–ç çš„HSVé˜ˆå€¼ â† é—®é¢˜æ ¹æºï¼
    hsv_white_lower = np.array([0, 0, 185])    # ç™½è‰²ä¸‹é™
    hsv_white_upper = np.array([180, 40, 255])  # ç™½è‰²ä¸Šé™
    
    # é¢œè‰²é˜ˆå€¼åˆ†å‰²
    white_mask = cv2.inRange(hsv, hsv_white_lower, hsv_white_upper)
    
    # å½¢æ€å­¦æ“ä½œå»å™ª
    kernel = np.ones((5, 5), np.uint8)
    white_mask = cv2.morphologyEx(white_mask, cv2.MORPH_CLOSE, kernel)
    white_mask = cv2.morphologyEx(white_mask, cv2.MORPH_OPEN, kernel)
    
    return white_mask
```

**ä¼˜ç‚¹**ï¼š
- âœ… è®¡ç®—ç®€å•ï¼ŒCPUå³å¯å®æ—¶è¿è¡Œ
- âœ… æ— éœ€è®­ç»ƒæ•°æ®
- âœ… åŸç†ç›´è§‚æ˜“æ‡‚

**ç¼ºç‚¹**ï¼š
- âŒ å¯¹å…‰ç…§å˜åŒ–æå…¶æ•æ„Ÿ
- âŒ æ‘„åƒå¤´ç™½å¹³è¡¡æ¼‚ç§»ç›´æ¥å¯¼è‡´å¤±æ•ˆ
- âŒ é˜ˆå€¼éœ€è¦é’ˆå¯¹ç‰¹å®šç¯å¢ƒæ‰‹åŠ¨è°ƒå‚
- âŒ éš¾ä»¥å¤„ç†å¤æ‚èƒŒæ™¯å¹²æ‰°

---

#### U-Netæ·±åº¦å­¦ä¹ æ–¹æ³•

**åŸç†**ï¼šé€šè¿‡å¤§é‡æ ‡æ³¨æ•°æ®è®­ç»ƒç¥ç»ç½‘ç»œï¼Œè®©æ¨¡å‹è‡ªåŠ¨å­¦ä¹ "ä»€ä¹ˆæ˜¯è½¦é“çº¿"çš„è¯­ä¹‰ç‰¹å¾ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   U-Netæ–¹æ³•å¤„ç†æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   åŸå§‹å›¾åƒ (RGB, 224Ã—224)                                   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“                                                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              U-Net ç¥ç»ç½‘ç»œ                         â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â”‚   ç¼–ç å™¨ (Encoder)          è§£ç å™¨ (Decoder)        â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”                           â”Œâ”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ â”€â”€â†’ ç‰¹å¾æå–              â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚     (å­¦ä¹ å½¢çŠ¶ã€çº¹ç†ã€      â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚      ä½ç½®ã€ä¸Šä¸‹æ–‡)   â”€â”€â†’  â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚                           â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”˜                           â””â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â”‚     â†“                               â†‘              â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”     è·³è·ƒè¿æ¥ (Skip)       â”Œâ”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”˜                           â””â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â”‚     â†“                               â†‘              â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”                           â”Œâ”€â”€â”€â”            â”‚   â”‚
â”‚   â”‚   â”‚   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   â”‚            â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”˜                           â””â”€â”€â”€â”˜            â”‚   â”‚
â”‚   â”‚         Bottleneck (æœ€æ·±ç‰¹å¾)                      â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“                                                    â”‚
â”‚   åƒç´ çº§æ¦‚ç‡å›¾ (æ¯ä¸ªåƒç´ æ˜¯è½¦é“çº¿çš„æ¦‚ç‡ 0~1)                  â”‚
â”‚        â”‚                                                    â”‚
â”‚        â†“  é˜ˆå€¼å¤„ç† (>0.5)                                   â”‚
â”‚   äºŒå€¼åŒ–æ©ç                                                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ç¤ºä¾‹**ï¼ˆæ‘˜è‡ªæœ¬é¡¹ç›® `unet_ros_node.py`ï¼‰ï¼š

```python
def predict(self, image, threshold=0.5):
    """U-Netæ¨ç† - æ·±åº¦å­¦ä¹ æ–¹æ³•"""
    # é¢„å¤„ç†ï¼šè°ƒæ•´å°ºå¯¸ï¼Œæ·»åŠ batchç»´åº¦
    input_data, original_shape = self.preprocess_image(image)
    
    # ç¥ç»ç½‘ç»œæ¨ç† (RKNN NPUåŠ é€Ÿ)
    outputs = self.model.run(inputs=[input_data])
    
    # åå¤„ç†
    mask = outputs[0]
    
    # Sigmoidæ¿€æ´»ï¼ˆå°†logitsè½¬ä¸ºæ¦‚ç‡ï¼‰
    if mask.max() > 1.0 or mask.min() < 0.0:
        mask = 1 / (1 + np.exp(-mask))
    
    # é˜ˆå€¼äºŒå€¼åŒ–ï¼šæ¦‚ç‡ > 0.5 åˆ¤å®šä¸ºè½¦é“çº¿
    binary_mask = (mask > threshold).astype(np.uint8) * 255
    
    # æ¢å¤åŸå§‹å°ºå¯¸
    binary_mask = cv2.resize(binary_mask, (original_shape[1], original_shape[0]))
    
    return binary_mask
```

**ä¼˜ç‚¹**ï¼š
- âœ… å…‰ç…§é²æ£’ï¼šè®­ç»ƒæ•°æ®åŒ…å«å¤šç§å…‰ç…§æ¡ä»¶
- âœ… é¢œè‰²è‡ªé€‚åº”ï¼šä¸ä¾èµ–å›ºå®šé¢œè‰²é˜ˆå€¼
- âœ… è¯­ä¹‰ç†è§£ï¼šå­¦ä¹ è½¦é“çº¿çš„æœ¬è´¨ç‰¹å¾è€Œéè¡¨é¢é¢œè‰²
- âœ… å¤æ‚èƒŒæ™¯å¤„ç†èƒ½åŠ›å¼º

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦æ ‡æ³¨è®­ç»ƒæ•°æ®
- âš ï¸ éœ€è¦GPU/NPUç¡¬ä»¶åŠ é€Ÿ
- âš ï¸ æ¨¡å‹è®­ç»ƒéœ€è¦ä¸€å®šæ—¶é—´

---

### æ ¸å¿ƒå·®å¼‚ï¼šä¸ºä»€ä¹ˆU-Netèƒ½å…‹æœç™½å¹³è¡¡é—®é¢˜ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   HSVæ–¹æ³•çš„å¤±æ•ˆæœºåˆ¶                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ­£å¸¸ç™½è‰²è½¦é“çº¿:  H=0,  S=5,  V=250  âœ… åœ¨é˜ˆå€¼èŒƒå›´å†…        â”‚
â”‚                                                             â”‚
â”‚  æ‘„åƒå¤´ç™½å¹³è¡¡åé»„å:                                        â”‚
â”‚  åŒä¸€è½¦é“çº¿å˜æˆ:  H=30, S=25, V=240  âŒ è¶…å‡ºé˜ˆå€¼èŒƒå›´ï¼       â”‚
â”‚                                                             â”‚
â”‚  æ‘„åƒå¤´ç™½å¹³è¡¡åè“å:                                        â”‚
â”‚  åŒä¸€è½¦é“çº¿å˜æˆ:  H=100, S=20, V=230 âŒ è¶…å‡ºé˜ˆå€¼èŒƒå›´ï¼       â”‚
â”‚                                                             â”‚
â”‚  â†’ æ£€æµ‹å®Œå…¨å¤±æ•ˆ                                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   U-Netçš„è§£å†³æ–¹æ¡ˆ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  U-Netå­¦ä¹ åˆ°çš„ç‰¹å¾:                                         â”‚
â”‚                                                             â”‚
â”‚  1. å½¢çŠ¶ç‰¹å¾ï¼šç»†é•¿çš„çº¿æ¡ç»“æ„           â† é¢œè‰²å˜åŒ–ä¸å½±å“     â”‚
â”‚  2. çº¹ç†ç‰¹å¾ï¼šä¸èƒŒæ™¯çš„è¾¹ç¼˜å·®å¼‚         â† é¢œè‰²å˜åŒ–ä¸å½±å“     â”‚
â”‚  3. ä½ç½®ç‰¹å¾ï¼šé€šå¸¸åœ¨å›¾åƒä¸‹åŠéƒ¨åˆ†       â† é¢œè‰²å˜åŒ–ä¸å½±å“     â”‚
â”‚  4. ä¸Šä¸‹æ–‡ç‰¹å¾ï¼šä¸¤ä¾§æ˜¯èµ›é“èƒŒæ™¯         â† é¢œè‰²å˜åŒ–ä¸å½±å“     â”‚
â”‚  5. å¤šæ ·æ€§ç‰¹å¾ï¼šè®­ç»ƒæ—¶è§è¿‡å„ç§é¢œè‰²åç§» â† å·²ç»å­¦ä¼šé€‚åº”      â”‚
â”‚                                                             â”‚
â”‚  â†’ å³ä½¿é¢œè‰²æ¼‚ç§»ï¼Œè¿™äº›ç‰¹å¾ä¾ç„¶å­˜åœ¨ï¼Œæ£€æµ‹ä¾ç„¶æœ‰æ•ˆ             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### æ€§èƒ½å¯¹æ¯”è¡¨

| å¯¹æ¯”ç»´åº¦ | HSVé¢œè‰²é˜ˆå€¼æ–¹æ³• | U-Netæ·±åº¦å­¦ä¹ æ–¹æ³• |
|:-------:|:-------------:|:----------------:|
| **åŸç†** | é¢œè‰²ç©ºé—´é˜ˆå€¼åˆ†å‰² | è¯­ä¹‰ç‰¹å¾å­¦ä¹  |
| **å…‰ç…§é²æ£’æ€§** | âŒ å·® | âœ… ä¼˜ç§€ |
| **ç™½å¹³è¡¡é€‚åº”æ€§** | âŒ å·®ï¼ˆç›´æ¥å¤±æ•ˆï¼‰ | âœ… ä¼˜ç§€ |
| **å¤æ‚èƒŒæ™¯å¤„ç†** | âŒ å·® | âœ… è‰¯å¥½ |
| **å‚æ•°è°ƒèŠ‚** | æ‰‹åŠ¨è°ƒèŠ‚HSVé˜ˆå€¼ | è‡ªåŠ¨ä»æ•°æ®å­¦ä¹  |
| **æ³›åŒ–èƒ½åŠ›** | âŒ å·®ï¼ˆæ¢åœºæ™¯éœ€é‡è°ƒï¼‰ | âœ… è‰¯å¥½ï¼ˆå¯è¿ç§»å­¦ä¹ ï¼‰ |
| **è®­ç»ƒæ•°æ®éœ€æ±‚** | âœ… æ— éœ€ | âš ï¸ éœ€è¦æ ‡æ³¨æ•°æ® |
| **è®¡ç®—èµ„æº** | âœ… CPUå³å¯ | âš ï¸ éœ€è¦GPU/NPU |
| **æ¨ç†é€Ÿåº¦** | ~100+ FPS (CPU) | ~30+ FPS (NPU) |
| **å®ç°å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ ä¸­ç­‰ |

---

### å¤±æ•ˆæ¡ˆä¾‹åˆ†æ

#### æ¡ˆä¾‹1ï¼šç™½å¹³è¡¡åé»„

```
åœºæ™¯ï¼šä¸‹åˆé˜³å…‰æ–œå°„ï¼Œæ‘„åƒå¤´è‡ªåŠ¨ç™½å¹³è¡¡åæš–è‰²è°ƒ

HSVæ–¹æ³•ï¼š
- åŸæœ¬Vé€šé“(äº®åº¦)å€¼ä¸º250çš„ç™½è‰²è½¦é“çº¿
- åé»„åHé€šé“ä»0å˜ä¸º20-40ï¼ŒSé€šé“ä»5å˜ä¸º20-30  
- è¶…å‡ºé¢„è®¾é˜ˆå€¼ [H:0-180, S:0-40, V:185-255]
- ç»“æœï¼šå¤§é¢ç§¯æ£€æµ‹ä¸¢å¤±

U-Netæ–¹æ³•ï¼š
- è®­ç»ƒæ•°æ®ä¸­åŒ…å«åé»„åœºæ™¯çš„æ ·æœ¬
- æ¨¡å‹å·²å­¦ä¼šåœ¨åé»„æ¡ä»¶ä¸‹è¯†åˆ«è½¦é“çº¿ç‰¹å¾
- ç»“æœï¼šæ­£å¸¸æ£€æµ‹
```

#### æ¡ˆä¾‹2ï¼šå±€éƒ¨é˜´å½±

```
åœºæ™¯ï¼šèµ›é“ä¸Šæœ‰éšœç¢ç‰©æŠ•å°„çš„é˜´å½±

HSVæ–¹æ³•ï¼š
- é˜´å½±åŒºåŸŸäº®åº¦Vå€¼ä»250é™è‡³120
- ä½äºé˜ˆå€¼ä¸‹é™185
- ç»“æœï¼šé˜´å½±åŒºåŸŸè½¦é“çº¿ä¸¢å¤±

U-Netæ–¹æ³•ï¼š
- è™½ç„¶äº®åº¦é™ä½ï¼Œä½†è½¦é“çº¿çš„å½¢çŠ¶ã€çº¹ç†ç‰¹å¾ä»åœ¨
- æ¨¡å‹é€šè¿‡ä¸Šä¸‹æ–‡ä¿¡æ¯æ¨æ–­é˜´å½±ä¸­ä¹Ÿæœ‰è½¦é“çº¿
- ç»“æœï¼šåŸºæœ¬å®Œæ•´æ£€æµ‹
```

#### æ¡ˆä¾‹3ï¼šåå…‰è¿‡æ›

```
åœºæ™¯ï¼šå¼ºå…‰ç…§å°„å¯¼è‡´è½¦é“çº¿åŒºåŸŸè¿‡æ›

HSVæ–¹æ³•ï¼š
- è¿‡æ›åŒºåŸŸRGBå€¼è¶‹è¿‘(255,255,255)
- å¯èƒ½è¯¯å°†å…¶ä»–è¿‡æ›åŒºåŸŸä¹Ÿåˆ¤å®šä¸ºè½¦é“çº¿
- ç»“æœï¼šå‡ºç°å¤§é‡è¯¯æ£€

U-Netæ–¹æ³•ï¼š
- æ¨¡å‹å­¦ä¹ çš„æ˜¯è½¦é“çº¿çš„æ•´ä½“è¯­ä¹‰ï¼Œä¸ä»…ä»…æ˜¯äº®åº¦
- èƒ½å¤ŸåŒºåˆ†"è½¦é“çº¿çš„ç™½"å’Œ"è¿‡æ›çš„ç™½"
- ç»“æœï¼šè¯¯æ£€è¾ƒå°‘
```

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        U-Netè½¦é“çº¿æ£€æµ‹ç³»ç»Ÿæ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   æ‘„åƒå¤´    â”‚    â”‚  é€è§†å˜æ¢   â”‚    â”‚   U-Net     â”‚    â”‚  å·¡çº¿æ§åˆ¶   â”‚  â”‚
â”‚  â”‚  Camera     â”‚â”€â”€â”€â†’â”‚  IPM       â”‚â”€â”€â”€â†’â”‚  æ¨ç†       â”‚â”€â”€â”€â†’â”‚  èŠ‚ç‚¹       â”‚  â”‚
â”‚  â”‚             â”‚    â”‚             â”‚    â”‚             â”‚    â”‚             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                  â”‚                  â”‚                  â”‚          â”‚
â”‚        â†“                  â†“                  â†“                  â†“          â”‚
â”‚  /image_rect_color   é¸Ÿç°å›¾å˜æ¢        /maskè¯é¢˜           /cmd_vel       â”‚
â”‚  (640Ã—480 BGR)       (1055Ã—685)       (äºŒå€¼æ©ç )          (é€Ÿåº¦æŒ‡ä»¤)      â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                              ç¡¬ä»¶å±‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         RK3588 å¼€å‘æ¿                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ CPU     â”‚  â”‚ GPU     â”‚  â”‚ NPU     â”‚  â”‚ å¤–è®¾æ¥å£            â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ A76+A55 â”‚  â”‚ Mali    â”‚  â”‚ 6 TOPS  â”‚  â”‚ USB/MIPI/UART/GPIO  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è½¯ä»¶æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       åº”ç”¨å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  line_follow        å·¡çº¿æ§åˆ¶èŠ‚ç‚¹                     â”‚   â”‚
â”‚  â”‚  parking            åœè½¦æ§åˆ¶èŠ‚ç‚¹                     â”‚   â”‚
â”‚  â”‚  final_game         æ¯”èµ›ä¸»æ§èŠ‚ç‚¹                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       æ„ŸçŸ¥å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  unet_ros_node      U-Netè½¦é“çº¿æ£€æµ‹èŠ‚ç‚¹ â† æœ¬é¡¹ç›®æ ¸å¿ƒ â”‚   â”‚
â”‚  â”‚  yolo_detector      YOLOç›®æ ‡æ£€æµ‹èŠ‚ç‚¹                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      ä¸­é—´ä»¶å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ROS Noetic         æœºå™¨äººæ“ä½œç³»ç»Ÿ                   â”‚   â”‚
â”‚  â”‚  cv_bridge          ROSä¸OpenCVå›¾åƒè½¬æ¢              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       æ¨ç†å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RKNN Runtime       NPUæ¨ç†è¿è¡Œæ—¶                    â”‚   â”‚
â”‚  â”‚  OpenCV 4.x         å›¾åƒå¤„ç†åº“                       â”‚   â”‚
â”‚  â”‚  NumPy              æ•°å€¼è®¡ç®—åº“                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       ç³»ç»Ÿå±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ubuntu 20.04       æ“ä½œç³»ç»Ÿ                         â”‚   â”‚
â”‚  â”‚  Linux Kernel 5.10  å†…æ ¸ (Rockchip BSP)              â”‚   â”‚
â”‚  â”‚  NPU Driver         NPUé©±åŠ¨ç¨‹åº                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       ç¡¬ä»¶å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  RK3588             ä¸»æ§èŠ¯ç‰‡ (8æ ¸CPU + 6TOPS NPU)    â”‚   â”‚
â”‚  â”‚  USB Camera         USBæ‘„åƒå¤´ (640Ã—480@30fps)        â”‚   â”‚
â”‚  â”‚  YDLidar            æ¿€å…‰é›·è¾¾ (é¿éšœç”¨)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å®Œæ•´æ•°æ®æµ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  USBæ‘„åƒå¤´                                                      åº•ç›˜é©±åŠ¨
     â”‚                                                              â†‘
     â†“                                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å›¾åƒ    â”‚     â”‚ unet_ros    â”‚     â”‚ line_follow â”‚     â”‚ ucar        â”‚
â”‚ é©±åŠ¨    â”‚â”€â”€â”€â”€â†’â”‚ _node       â”‚â”€â”€â”€â”€â†’â”‚ èŠ‚ç‚¹        â”‚â”€â”€â”€â”€â†’â”‚ _controller â”‚
â”‚         â”‚     â”‚             â”‚     â”‚             â”‚     â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                   â”‚                   â”‚
     â†“                â†“                   â†“                   â†“
/image_rect      /mask              è®¡ç®—åå·®           /cmd_vel
_color           (äºŒå€¼æ©ç )         PIDæ§åˆ¶            (Twist)
(BGRå›¾åƒ)


è¯¦ç»†å¤„ç†æµç¨‹:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

æ­¥éª¤1: å›¾åƒè·å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /image_rect_color â”‚  â† ROSè¯é¢˜ (sensor_msgs/Image)
â”‚ 640Ã—480, BGR     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤2: é€è§†å˜æ¢ (é€†é€è§†/IPM)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  src_points (æ¢¯å½¢)          dst_points (çŸ©å½¢)            â”‚
â”‚  [29,347]  [619,368]   â†’   [300,580] [755,580]          â”‚
â”‚  [202,238] [422,248]   â†’   [300,100] [755,100]          â”‚
â”‚                                                          â”‚
â”‚  cv2.warpPerspective() â†’ é¸Ÿç°å›¾ (1055Ã—685)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤3: å›¾åƒé¢„å¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ BGR â†’ RGB é¢œè‰²è½¬æ¢                                    â”‚
â”‚  â€¢ Resize: 1055Ã—685 â†’ 224Ã—224 (æ¨¡å‹è¾“å…¥å°ºå¯¸)            â”‚
â”‚  â€¢ æ·»åŠ batchç»´åº¦: (H,W,C) â†’ (1,H,W,C)                   â”‚
â”‚  â€¢ ä¿æŒuint8æ ¼å¼ (INT8é‡åŒ–æ¨¡å‹)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤4: U-Netç¥ç»ç½‘ç»œæ¨ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RKNN NPU åŠ é€Ÿ                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  è¾“å…¥: (1, 224, 224, 3) uint8                      â”‚ â”‚
â”‚  â”‚                 â†“                                  â”‚ â”‚
â”‚  â”‚         U-Net å‰å‘ä¼ æ’­                             â”‚ â”‚
â”‚  â”‚    (ç¼–ç å™¨ â†’ Bottleneck â†’ è§£ç å™¨)                  â”‚ â”‚
â”‚  â”‚                 â†“                                  â”‚ â”‚
â”‚  â”‚  è¾“å‡º: (1, 1, 224, 224) int8                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  æ¨ç†æ—¶é—´: ~30ms (çº¦30 FPS)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤5: åå¤„ç†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ INT8 â†’ Float32 ç±»å‹è½¬æ¢                              â”‚
â”‚  â€¢ Sigmoidæ¿€æ´»: logits â†’ æ¦‚ç‡ (0~1)                     â”‚
â”‚  â€¢ é˜ˆå€¼äºŒå€¼åŒ–: prob > 0.5 â†’ 255, else â†’ 0              â”‚
â”‚  â€¢ Resizeå›åŸå§‹å°ºå¯¸: 224Ã—224 â†’ 1055Ã—685                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤6: å‘å¸ƒç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     /mask        â”‚  â† ROSè¯é¢˜ (sensor_msgs/Image)
â”‚  1055Ã—685, mono8 â”‚     äºŒå€¼æ©ç : ç™½è‰²=è½¦é“çº¿, é»‘è‰²=èƒŒæ™¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤7: ä¸‹æ¸¸å¤„ç† (line_followèŠ‚ç‚¹)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â€¢ é€è¡Œæ‰«ææ£€æµ‹å·¦å³è½¦é“çº¿ç‚¹é›†                            â”‚
â”‚  â€¢ å¤šé¡¹å¼æ‹Ÿåˆå·¦å³è½¦é“çº¿                                  â”‚
â”‚  â€¢ è®¡ç®—è½¦é“ä¸­çº¿                                          â”‚
â”‚  â€¢ è®¡ç®—æ¨ªå‘åå·® (lateral_offset)                        â”‚
â”‚  â€¢ PIDæ§åˆ¶è®¡ç®—è§’é€Ÿåº¦                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
æ­¥éª¤8: å‘å¸ƒæ§åˆ¶æŒ‡ä»¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    /cmd_vel      â”‚  â† ROSè¯é¢˜ (geometry_msgs/Twist)
â”‚  linear.x, angular.z â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³é”®æ¨¡å—è¯´æ˜

| æ¨¡å— | æ–‡ä»¶ | åŠŸèƒ½ |
|-----|------|------|
| **U-Netæ¨ç†èŠ‚ç‚¹** | `unet_ros_node.py` | è®¢é˜…å›¾åƒï¼Œæ‰§è¡Œæ¨ç†ï¼Œå‘å¸ƒæ©ç  |
| **æ¨ç†å¼•æ“** | `unet.py` | U-Netæ¨¡å‹çš„å°è£…ï¼Œé¢„å¤„ç†/æ¨ç†/åå¤„ç† |
| **RKNNæ‰§è¡Œå™¨** | `py_utils/rknn_executor.py` | RKNNæ¨¡å‹åŠ è½½å’ŒNPUæ¨ç†æ¥å£ |
| **å·¡çº¿èŠ‚ç‚¹** | `line_follow/scripts/*.py` | æ¶ˆè´¹æ©ç ï¼Œè®¡ç®—æ§åˆ¶æŒ‡ä»¤ |
| **å¯åŠ¨æ–‡ä»¶** | `launch/mask.launch` | ä¸€é”®å¯åŠ¨U-NetèŠ‚ç‚¹ |

---

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

#### ç¡¬ä»¶è¦æ±‚

| ç»„ä»¶ | è¦æ±‚ | å¤‡æ³¨ |
|-----|------|------|
| ä¸»æ§æ¿ | RK3588/RK3588S | éœ€è¦NPUæ”¯æŒ |
| å†…å­˜ | â‰¥4GB | æ¨è8GB |
| æ‘„åƒå¤´ | USBæ‘„åƒå¤´ | æ”¯æŒ640Ã—480@30fps |
| å­˜å‚¨ | â‰¥16GB | ç”¨äºç³»ç»Ÿå’Œæ¨¡å‹ |

#### è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬ | å¤‡æ³¨ |
|-----|------|------|
| Ubuntu | 20.04 LTS | Rockchipå®˜æ–¹BSP |
| ROS | Noetic | å®Œæ•´æ¡Œé¢ç‰ˆ |
| Python | 3.8+ | ç³»ç»Ÿè‡ªå¸¦ |
| RKNN-Toolkit2 | 1.5.0+ | NPUæ¨ç†åº“ |
| OpenCV | 4.2+ | å›¾åƒå¤„ç† |

#### Pythonä¾èµ–

```txt
# requirements.txt
numpy>=1.19.0
opencv-python>=4.2.0
rknn-toolkit2>=1.5.0  # ä»…åœ¨RK3588ä¸Šéœ€è¦
```

### å®‰è£…æ­¥éª¤

#### 1. å…‹éš†ä»“åº“

```bash
# è¿›å…¥ROSå·¥ä½œç©ºé—´çš„srcç›®å½•
cd ~/catkin_ws/src

# å…‹éš†æœ¬é¡¹ç›®
git clone https://github.com/your-username/rknn_pkg.git

# è¿”å›å·¥ä½œç©ºé—´æ ¹ç›®å½•
cd ~/catkin_ws
```

#### 2. å®‰è£…ROSä¾èµ–

```bash
# å®‰è£…ä¾èµ–åŒ…
sudo apt-get update
sudo apt-get install -y \
    ros-noetic-cv-bridge \
    ros-noetic-image-transport \
    ros-noetic-sensor-msgs \
    python3-opencv \
    python3-numpy

# ä½¿ç”¨rosdepå®‰è£…å…¶ä»–ä¾èµ–
rosdep install --from-paths src --ignore-src -r -y
```

#### 3. å®‰è£…RKNN Runtimeï¼ˆä»…RK3588ï¼‰

```bash
# ä¸‹è½½RKNN Runtime
# è¯·ä»Rockchipå®˜æ–¹è·å–å¯¹åº”ç‰ˆæœ¬

# å®‰è£…PythonåŒ…
pip3 install rknn-toolkit2-lite-*.whl

# éªŒè¯å®‰è£…
python3 -c "from rknn.api import RKNN; print('RKNN OK')"
```

#### 4. ç¼–è¯‘ROSåŒ…

```bash
# ç¼–è¯‘
cd ~/catkin_ws
catkin_make

# æˆ–ä½¿ç”¨catkin build
catkin build rknn_pkg

# åˆ·æ–°ç¯å¢ƒ
source devel/setup.bash
```

#### 5. ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹

```bash
# æ¨¡å‹æ–‡ä»¶åº”æ”¾ç½®åœ¨ä»¥ä¸‹ä½ç½®
# ~/catkin_ws/src/rknn_pkg/model/lane_unet_803.rknn

# å¦‚æœæ²¡æœ‰æ¨¡å‹ï¼Œè¯·å‚è€ƒ"æ¨¡å‹è®­ç»ƒ"ç« èŠ‚è‡ªè¡Œè®­ç»ƒ
# æˆ–ä»Releaseé¡µé¢ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹
```

### å¿«é€Ÿè¿è¡Œ

#### æ–¹å¼1ï¼šä½¿ç”¨Launchæ–‡ä»¶ï¼ˆæ¨èï¼‰

```bash
# ç»ˆç«¯1: å¯åŠ¨æ‘„åƒå¤´èŠ‚ç‚¹ï¼ˆå¦‚æœè¿˜æ²¡å¯åŠ¨ï¼‰
roslaunch usb_cam usb_cam-test.launch

# ç»ˆç«¯2: å¯åŠ¨U-Netæ£€æµ‹èŠ‚ç‚¹
roslaunch rknn_pkg mask.launch
```

#### æ–¹å¼2ï¼šå•ç‹¬è¿è¡ŒèŠ‚ç‚¹

```bash
# ç¡®ä¿ROS Masterå·²å¯åŠ¨
roscore

# è¿è¡ŒU-NetèŠ‚ç‚¹
rosrun rknn_pkg unet_ros_node.py \
    _model_path:=/home/ucar/ucar_ws/src/rknn_pkg/model/lane_unet_803.rknn \
    _threshold:=0.5 \
    _input_topic:=/image_rect_color \
    _output_topic:=/mask
```

#### æ–¹å¼3ï¼šä¸å·¡çº¿èŠ‚ç‚¹è”åˆè¿è¡Œ

```bash
# å¯åŠ¨å®Œæ•´å·¡çº¿ç³»ç»Ÿ
roslaunch line_follow line_follower.launch
```

### éªŒè¯å®‰è£…

#### 1. æ£€æŸ¥è¯é¢˜

```bash
# æŸ¥çœ‹è¾“å…¥è¯é¢˜æ˜¯å¦å­˜åœ¨
rostopic list | grep image_rect_color

# æŸ¥çœ‹è¾“å‡ºè¯é¢˜
rostopic list | grep mask

# æŸ¥çœ‹è¯é¢˜é¢‘ç‡
rostopic hz /mask
# é¢„æœŸè¾“å‡º: average rate: 30.xx
```

#### 2. å¯è§†åŒ–æ£€æµ‹ç»“æœ

```bash
# ä½¿ç”¨rqt_image_viewæŸ¥çœ‹
rqt_image_view /mask

# æˆ–ä½¿ç”¨image_view
rosrun image_view image_view image:=/mask
```

#### 3. æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯

```bash
# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
rostopic echo /rosout | grep -i lane

# æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡ï¼ˆèŠ‚ç‚¹æ¯5ç§’è¾“å‡ºä¸€æ¬¡ï¼‰
# é¢„æœŸè¾“å‡º: Lane Segmentation - Frames: xxx, Avg FPS: 30.x
```

### ç›®å½•ç»“æ„

ç¡®ä¿ä½ çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š

```
rknn_pkg/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ package.xml
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ docs/                        # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ README.md               # æœ¬æ–‡æ¡£
â”‚   â””â”€â”€ assets/                 # å›¾ç‰‡èµ„æº
â”‚       â””â”€â”€ demo/
â”‚
â”œâ”€â”€ model/                       # æ¨¡å‹æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ lane_unet_803.rknn      # â† ä¸»è¦ä½¿ç”¨çš„æ¨¡å‹
â”‚   â”œâ”€â”€ lane_unet_final.rknn
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ launch/                      # Launchæ–‡ä»¶
â”‚   â””â”€â”€ mask.launch             # U-NetèŠ‚ç‚¹å¯åŠ¨æ–‡ä»¶
â”‚
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ src/                         # æºä»£ç 
â”‚   â”œâ”€â”€ unet_ros_node.py        # ROSèŠ‚ç‚¹ä¸»æ–‡ä»¶
â”‚   â”œâ”€â”€ unet.py                 # æ¨ç†å¼•æ“
â”‚   â””â”€â”€ py_utils/               # å·¥å…·æ¨¡å—
â”‚       â”œâ”€â”€ rknn_executor.py    # RKNNæ‰§è¡Œå™¨
â”‚       â”œâ”€â”€ onnx_executor.py    # ONNXæ‰§è¡Œå™¨
â”‚       â””â”€â”€ pytorch_executor.py # PyTorchæ‰§è¡Œå™¨
â”‚
â”œâ”€â”€ test_images/                 # æµ‹è¯•å›¾ç‰‡/è§†é¢‘
â”‚
â””â”€â”€ srv/                         # æœåŠ¡å®šä¹‰ï¼ˆå¦‚æœ‰ï¼‰
```

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# å¯åŠ¨æ£€æµ‹èŠ‚ç‚¹
roslaunch rknn_pkg mask.launch

# æŸ¥çœ‹æ£€æµ‹ç»“æœ
rqt_image_view /mask

# æŸ¥çœ‹è¯é¢˜åˆ—è¡¨
rostopic list

# æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
rosnode info /unet_ros_node

# åŠ¨æ€è°ƒæ•´å‚æ•°ï¼ˆå¦‚æœæ”¯æŒï¼‰
rosparam set /unet_ros_node/threshold 0.6

# å½•åˆ¶rosbagç”¨äºç¦»çº¿æµ‹è¯•
rosbag record /image_rect_color /mask -o lane_detection.bag

# å›æ”¾rosbagæµ‹è¯•
rosbag play lane_detection.bag
```

---

## æ•°æ®é›†å‡†å¤‡

### æ•°æ®é‡‡é›†

#### é‡‡é›†è®¾å¤‡

| è®¾å¤‡ | è§„æ ¼ | å¤‡æ³¨ |
|-----|------|------|
| æ‘„åƒå¤´ | USBæ‘„åƒå¤´ 640Ã—480@30fps | ä¸å®é™…éƒ¨ç½²ä¸€è‡´ |
| ä¸»æ§æ¿ | RK3588 | ç”¨äºå½•åˆ¶rosbag |
| èµ›é“ | è“è‰²åº•å¸ƒ+ç™½è‰²è½¦é“çº¿ | æ™ºèƒ½è½¦ç«èµ›æ ‡å‡†èµ›é“ |

#### é‡‡é›†åœºæ™¯è¦†ç›–

ä¸ºäº†è®­ç»ƒå‡ºé²æ£’çš„æ¨¡å‹ï¼Œéœ€è¦é‡‡é›†**å¤šæ ·åŒ–**çš„æ•°æ®ï¼š

| åœºæ™¯ç±»åˆ« | å…·ä½“åœºæ™¯ | æ•°é‡å»ºè®® | é‡è¦æ€§ |
|---------|---------|---------|-------|
| **å…‰ç…§æ¡ä»¶** | æ­£å¸¸å…‰ç…§ | 200+ | â­â­â­ |
| | å¼ºå…‰/è¿‡æ› | 100+ | â­â­â­ |
| | å¼±å…‰/åæš— | 100+ | â­â­â­ |
| | ä¾§å…‰/é˜´å½± | 100+ | â­â­ |
| **ç™½å¹³è¡¡** | æ­£å¸¸ | 200+ | â­â­â­ |
| | åé»„/æš–è‰²è°ƒ | 150+ | â­â­â­â­â­ |
| | åè“/å†·è‰²è°ƒ | 150+ | â­â­â­â­â­ |
| **è½¦é“å½¢æ€** | ç›´é“ | 150+ | â­â­â­ |
| | å°å¼¯é“ | 150+ | â­â­â­ |
| | å¤§å¼¯é“/Så¼¯ | 100+ | â­â­ |
| | äº¤å‰è·¯å£ | 50+ | â­â­ |
| **å¹²æ‰°å› ç´ ** | è½¦é“çº¿è„æ±¡ | 50+ | â­â­ |
| | éƒ¨åˆ†é®æŒ¡ | 50+ | â­â­ |

> âš ï¸ **å…³é”®æç¤º**ï¼š**ç™½å¹³è¡¡åç§»**çš„åœºæ™¯æ•°æ®æå…¶é‡è¦ï¼è¿™æ˜¯æœ¬é¡¹ç›®è¦è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼ŒåŠ¡å¿…é‡‡é›†è¶³å¤Ÿå¤šæ ·æœ¬ã€‚

#### é‡‡é›†æ–¹æ³•

**æ–¹æ³•1ï¼šå½•åˆ¶rosbagåæå–å¸§**

```bash
# 1. å¯åŠ¨æ‘„åƒå¤´
roslaunch usb_cam usb_cam-test.launch

# 2. å½•åˆ¶rosbagï¼ˆåœ¨ä¸åŒå…‰ç…§æ¡ä»¶ä¸‹å¤šæ¬¡å½•åˆ¶ï¼‰
rosbag record /image_rect_color -o dataset_normal_light.bag
rosbag record /image_rect_color -o dataset_bright_light.bag
rosbag record /image_rect_color -o dataset_yellow_wb.bag

# 3. ä»rosbagæå–å›¾åƒå¸§
# extract_frames.py
import rosbag
import cv2
from cv_bridge import CvBridge

bag = rosbag.Bag('dataset_normal_light.bag')
bridge = CvBridge()

for i, (topic, msg, t) in enumerate(bag.read_messages(topics=['/image_rect_color'])):
    if i % 5 == 0:  # æ¯5å¸§å–1å¸§ï¼Œé¿å…ç›¸ä¼¼å›¾åƒè¿‡å¤š
        cv_image = bridge.imgmsg_to_cv2(msg, "bgr8")
        cv2.imwrite(f'images/frame_{i:06d}.jpg', cv_image)

bag.close()
```

**æ–¹æ³•2ï¼šç›´æ¥æ‹æ‘„å›¾ç‰‡**

```bash
# ä½¿ç”¨OpenCVç›´æ¥é‡‡é›†
import cv2

cap = cv2.VideoCapture(0)
cap.set(cv2.CAP_PROP_FRAME_WIDTH, 640)
cap.set(cv2.CAP_PROP_FRAME_HEIGHT, 480)

frame_count = 0
while True:
    ret, frame = cap.read()
    cv2.imshow('Capture', frame)
    
    key = cv2.waitKey(1)
    if key == ord('s'):  # æŒ‰'s'ä¿å­˜
        cv2.imwrite(f'images/capture_{frame_count:06d}.jpg', frame)
        frame_count += 1
        print(f'Saved frame {frame_count}')
    elif key == ord('q'):
        break

cap.release()
```

---

### æ•°æ®æ ‡æ³¨

#### æ ‡æ³¨å·¥å…·æ¨è

| å·¥å…· | æ¨èåº¦ | ç‰¹ç‚¹ |
|-----|-------|------|
| **LabelMe** | â­â­â­â­â­ | å…è´¹ã€æ”¯æŒå¤šè¾¹å½¢æ ‡æ³¨ã€å¯¼å‡ºJSON |
| **CVAT** | â­â­â­â­ | åœ¨çº¿/æœ¬åœ°ã€å›¢é˜Ÿåä½œã€æ”¯æŒè§†é¢‘ |
| **Supervisely** | â­â­â­ | äº‘ç«¯ã€è‡ªåŠ¨åŒ–å·¥å…·ã€æ”¶è´¹ |
| **è‡ªå®šä¹‰è„šæœ¬** | â­â­â­ | æ‰¹é‡å¤„ç†ã€é’ˆå¯¹æ€§å¼º |

#### LabelMeæ ‡æ³¨æ•™ç¨‹

**1. å®‰è£…LabelMe**

```bash
pip install labelme
```

**2. å¯åŠ¨æ ‡æ³¨**

```bash
labelme images/  # æ‰“å¼€å›¾åƒç›®å½•
```

**3. æ ‡æ³¨æ­¥éª¤**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LabelMe æ ‡æ³¨ç•Œé¢                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚   1. ç‚¹å‡» "Create Polygons" åˆ›å»ºå¤šè¾¹å½¢                  â”‚
â”‚                                                         â”‚
â”‚   2. æ²¿ç€è½¦é“çº¿è¾¹ç¼˜ç‚¹å‡»ï¼Œå‹¾å‹’å‡ºè½¦é“çº¿åŒºåŸŸ               â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚      â”‚      â•±              â•²        â”‚                  â”‚
â”‚      â”‚     â•±   æ ‡æ³¨è¿™é‡Œ     â•²       â”‚  â† æ²¿è¾¹ç¼˜ç‚¹å‡»    â”‚
â”‚      â”‚    â•±________________â•²      â”‚                  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                         â”‚
â”‚   3. é—­åˆå¤šè¾¹å½¢åï¼Œè¾“å…¥æ ‡ç­¾å: "lane"                   â”‚
â”‚                                                         â”‚
â”‚   4. ä¿å­˜ï¼ˆè‡ªåŠ¨ç”ŸæˆåŒå.jsonæ–‡ä»¶ï¼‰                      â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**4. æ ‡æ³¨è§„èŒƒ**

```
âœ… æ­£ç¡®çš„æ ‡æ³¨:
   - ç´§è´´è½¦é“çº¿è¾¹ç¼˜
   - åŒ…å«å®Œæ•´çš„è½¦é“çº¿åŒºåŸŸ
   - æ ‡ç­¾ç»Ÿä¸€ä½¿ç”¨ "lane"

âŒ é”™è¯¯çš„æ ‡æ³¨:
   - æ ‡æ³¨åŒºåŸŸè¶…å‡ºè½¦é“çº¿èŒƒå›´
   - æ ‡æ³¨åŒºåŸŸä¸å®Œæ•´ï¼Œæœ‰ç¼ºå£
   - æ ‡ç­¾åç§°ä¸ç»Ÿä¸€ï¼ˆå¦‚ç”¨äº†"line"ã€"road"ç­‰ï¼‰
```

**5. æ‰¹é‡è½¬æ¢ä¸ºæ©ç å›¾åƒ**

```python
# labelme_to_mask.py
import os
import json
import numpy as np
import cv2
from labelme import utils

def labelme_json_to_mask(json_path, output_dir):
    """å°†LabelMeçš„JSONæ ‡æ³¨è½¬æ¢ä¸ºäºŒå€¼æ©ç å›¾åƒ"""
    with open(json_path, 'r') as f:
        data = json.load(f)
    
    # è·å–å›¾åƒå°ºå¯¸
    img_height = data['imageHeight']
    img_width = data['imageWidth']
    
    # åˆ›å»ºç©ºç™½æ©ç 
    mask = np.zeros((img_height, img_width), dtype=np.uint8)
    
    # éå†æ‰€æœ‰æ ‡æ³¨
    for shape in data['shapes']:
        if shape['label'] == 'lane':  # åªå¤„ç†è½¦é“çº¿æ ‡ç­¾
            points = np.array(shape['points'], dtype=np.int32)
            cv2.fillPoly(mask, [points], 255)  # å¡«å……ä¸ºç™½è‰²
    
    # ä¿å­˜æ©ç 
    base_name = os.path.splitext(os.path.basename(json_path))[0]
    mask_path = os.path.join(output_dir, f'{base_name}.png')
    cv2.imwrite(mask_path, mask)
    print(f'Saved: {mask_path}')

# æ‰¹é‡å¤„ç†
json_dir = 'images/'  # LabelMe JSONæ–‡ä»¶ç›®å½•
mask_dir = 'masks/'   # è¾“å‡ºæ©ç ç›®å½•
os.makedirs(mask_dir, exist_ok=True)

for filename in os.listdir(json_dir):
    if filename.endswith('.json'):
        labelme_json_to_mask(os.path.join(json_dir, filename), mask_dir)
```

---

### æ•°æ®é›†ç»“æ„

æœ€ç»ˆçš„æ•°æ®é›†åº”ç»„ç»‡ä¸ºä»¥ä¸‹ç»“æ„ï¼š

```
dataset/
â”œâ”€â”€ images/                      # åŸå§‹å›¾åƒ
â”‚   â”œâ”€â”€ train/                   # è®­ç»ƒé›† (80%)
â”‚   â”‚   â”œâ”€â”€ frame_000001.jpg
â”‚   â”‚   â”œâ”€â”€ frame_000002.jpg
â”‚   â”‚   â”œâ”€â”€ frame_000003.jpg
â”‚   â”‚   â””â”€â”€ ... (çº¦800-1000å¼ )
â”‚   â”‚
â”‚   â””â”€â”€ val/                     # éªŒè¯é›† (20%)
â”‚       â”œâ”€â”€ frame_000501.jpg
â”‚       â”œâ”€â”€ frame_000502.jpg
â”‚       â””â”€â”€ ... (çº¦200-250å¼ )
â”‚
â”œâ”€â”€ masks/                       # æ ‡æ³¨æ©ç  (ä¸imagesä¸€ä¸€å¯¹åº”)
â”‚   â”œâ”€â”€ train/
â”‚   â”‚   â”œâ”€â”€ frame_000001.png     # äºŒå€¼å›¾: 0=èƒŒæ™¯, 255=è½¦é“çº¿
â”‚   â”‚   â”œâ”€â”€ frame_000002.png
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ val/
â”‚       â”œâ”€â”€ frame_000501.png
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ dataset_info.yaml            # æ•°æ®é›†ä¿¡æ¯æ–‡ä»¶
```

**dataset_info.yaml ç¤ºä¾‹ï¼š**

```yaml
# æ•°æ®é›†é…ç½®æ–‡ä»¶
name: lane_detection_dataset
version: "1.0"
created: "2026-01-15"

# æ•°æ®é›†ç»Ÿè®¡
statistics:
  total_images: 1200
  train_images: 960
  val_images: 240
  
# ç±»åˆ«å®šä¹‰
classes:
  - name: background
    id: 0
    color: [0, 0, 0]        # é»‘è‰²
  - name: lane
    id: 1  
    color: [255, 255, 255]  # ç™½è‰²

# å›¾åƒä¿¡æ¯
image_info:
  width: 640
  height: 480
  format: "jpg"

# æ©ç ä¿¡æ¯  
mask_info:
  format: "png"
  encoding: "grayscale"     # ç°åº¦å›¾
  values:
    background: 0
    lane: 255
```

---

### æ•°æ®å¢å¼ºç­–ç•¥

æ•°æ®å¢å¼ºæ˜¯æå‡æ¨¡å‹é²æ£’æ€§çš„å…³é”®ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹å…‰ç…§å’Œé¢œè‰²å˜åŒ–ï¼š

#### æ¨èçš„å¢å¼ºæ–¹æ³•

```python
# data_augmentation.py
import albumentations as A
from albumentations.pytorch import ToTensorV2

# è®­ç»ƒæ—¶çš„æ•°æ®å¢å¼º
train_transform = A.Compose([
    # === å‡ ä½•å˜æ¢ ===
    A.HorizontalFlip(p=0.5),                    # æ°´å¹³ç¿»è½¬
    A.Rotate(limit=15, p=0.5),                  # éšæœºæ—‹è½¬Â±15Â°
    A.RandomCrop(height=224, width=224, p=1.0), # éšæœºè£å‰ª
    
    # === é¢œè‰²/å…‰ç…§å˜æ¢ (å…³é”®!) ===
    A.RandomBrightnessContrast(
        brightness_limit=0.3,   # äº®åº¦å˜åŒ–Â±30%
        contrast_limit=0.3,     # å¯¹æ¯”åº¦å˜åŒ–Â±30%
        p=0.7
    ),
    A.HueSaturationValue(
        hue_shift_limit=30,     # è‰²è°ƒåç§»Â±30 â† æ¨¡æ‹Ÿç™½å¹³è¡¡æ¼‚ç§»!
        sat_shift_limit=30,     # é¥±å’Œåº¦å˜åŒ–
        val_shift_limit=30,     # æ˜åº¦å˜åŒ–
        p=0.7
    ),
    A.ColorJitter(
        brightness=0.2,
        contrast=0.2, 
        saturation=0.2,
        hue=0.1,
        p=0.5
    ),
    
    # === æ¨¡ç³Š/å™ªå£° ===
    A.GaussianBlur(blur_limit=(3, 7), p=0.3),
    A.GaussNoise(var_limit=(10, 50), p=0.3),
    
    # === å½’ä¸€åŒ– ===
    A.Normalize(mean=[0.485, 0.456, 0.406], 
                std=[0.229, 0.224, 0.225]),
    ToTensorV2(),
])

# éªŒè¯æ—¶åªåšå¿…è¦çš„é¢„å¤„ç†
val_transform = A.Compose([
    A.Resize(height=224, width=224),
    A.Normalize(mean=[0.485, 0.456, 0.406],
                std=[0.229, 0.224, 0.225]),
    ToTensorV2(),
])
```

#### å¢å¼ºæ•ˆæœç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å¢å¼ºæ•ˆæœç¤ºæ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  åŸå›¾          äº®åº¦+30%        äº®åº¦-30%        è‰²è°ƒåç§»     â”‚
â”‚  â”Œâ”€â”€â”€â”         â”Œâ”€â”€â”€â”          â”Œâ”€â”€â”€â”          â”Œâ”€â”€â”€â”        â”‚
â”‚  â”‚   â”‚   â†’    â”‚â–‘â–‘â–‘â”‚    â†’     â”‚â–“â–“â–“â”‚    â†’     â”‚   â”‚        â”‚
â”‚  â”‚ â• â”‚         â”‚ â• â”‚          â”‚ â• â”‚          â”‚ â• â”‚        â”‚
â”‚  â””â”€â”€â”€â”˜         â””â”€â”€â”€â”˜          â””â”€â”€â”€â”˜          â””â”€â”€â”€â”˜        â”‚
â”‚  æ­£å¸¸          åäº®            åæš—           åé»„/åè“    â”‚
â”‚                                                             â”‚
â”‚  è¿™äº›å¢å¼ºåçš„å›¾åƒéƒ½å¯¹åº”åŒä¸€ä¸ªæ©ç æ ‡ç­¾ï¼                     â”‚
â”‚  â†’ æ¨¡å‹å­¦ä¼šåœ¨å„ç§æ¡ä»¶ä¸‹è¯†åˆ«è½¦é“çº¿                           â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å»ºè®®çš„æ•°æ®é‡

| åŸå§‹æ•°æ® | å¢å¼ºå | è¯´æ˜ |
|---------|-------|------|
| 1000å¼  | 5000-10000å¼  | æ¯å¼ åŸå›¾å¢å¼º5-10æ¬¡ |
| 500å¼  | 2500-5000å¼  | æœ€å°å¯ç”¨æ•°æ®é‡ |
| 2000å¼  | 10000-20000å¼  | æ¨èæ•°æ®é‡ |

> ğŸ’¡ **æç¤º**ï¼šæ•°æ®è´¨é‡æ¯”æ•°é‡æ›´é‡è¦ï¼100å¼ è¦†ç›–å„ç§åœºæ™¯çš„é«˜è´¨é‡æ ‡æ³¨ï¼Œèƒœè¿‡1000å¼ é‡å¤åœºæ™¯çš„æ ‡æ³¨ã€‚

---

## æ¨¡å‹è®­ç»ƒ

### U-Netç½‘ç»œç»“æ„

U-Netæ˜¯ä¸€ç§ç»å…¸çš„ç¼–ç å™¨-è§£ç å™¨ç»“æ„ç½‘ç»œï¼Œæœ€åˆç”¨äºåŒ»å­¦å›¾åƒåˆ†å‰²ï¼Œå› å…¶å‡ºè‰²çš„å°æ ·æœ¬å­¦ä¹ èƒ½åŠ›å’Œç²¾ç»†çš„è¾¹ç¼˜åˆ†å‰²æ•ˆæœï¼Œéå¸¸é€‚åˆè½¦é“çº¿æ£€æµ‹ä»»åŠ¡ã€‚

#### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          U-Net ç½‘ç»œç»“æ„å›¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  è¾“å…¥å›¾åƒ                                                      è¾“å‡ºæ©ç      â”‚
â”‚  224Ã—224Ã—3                                                    224Ã—224Ã—1    â”‚
â”‚      â”‚                                                            â†‘        â”‚
â”‚      â†“                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 64ch   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†’â”‚ 64ch   â”‚    â”‚
â”‚  â”‚224Ã—224 â”‚              è·³è·ƒè¿æ¥ (Skip Connection)          â”‚224Ã—224 â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                  â””â”€â”€â”€â”€â†‘â”€â”€â”€â”˜    â”‚
â”‚      â”‚ MaxPool                                          UpConv   â”‚        â”‚
â”‚      â†“                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 128ch  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†’â”‚ 128ch  â”‚    â”‚
â”‚  â”‚112Ã—112 â”‚              è·³è·ƒè¿æ¥ (Skip Connection)          â”‚112Ã—112 â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                  â””â”€â”€â”€â”€â†‘â”€â”€â”€â”˜    â”‚
â”‚      â”‚ MaxPool                                          UpConv   â”‚        â”‚
â”‚      â†“                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 256ch  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†’â”‚ 256ch  â”‚    â”‚
â”‚  â”‚ 56Ã—56  â”‚              è·³è·ƒè¿æ¥ (Skip Connection)          â”‚ 56Ã—56  â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                  â””â”€â”€â”€â”€â†‘â”€â”€â”€â”˜    â”‚
â”‚      â”‚ MaxPool                                          UpConv   â”‚        â”‚
â”‚      â†“                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ 512ch  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â†’â”‚ 512ch  â”‚    â”‚
â”‚  â”‚ 28Ã—28  â”‚              è·³è·ƒè¿æ¥ (Skip Connection)          â”‚ 28Ã—28  â”‚    â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                  â””â”€â”€â”€â”€â†‘â”€â”€â”€â”˜    â”‚
â”‚      â”‚ MaxPool                                          UpConv   â”‚        â”‚
â”‚      â†“                                                            â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                    Bottleneck (1024ch, 14Ã—14)                   â”‚      â”‚
â”‚  â”‚                        æœ€æ·±å±‚ç‰¹å¾æå–                            â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                             â”‚
â”‚  â† â”€ â”€ â”€ ç¼–ç å™¨ (Encoder) â”€ â”€ â”€ â†’ â† â”€ â”€ â”€ è§£ç å™¨ (Decoder) â”€ â”€ â”€ â†’        â”‚
â”‚         ç‰¹å¾æå– + ä¸‹é‡‡æ ·              ç‰¹å¾èåˆ + ä¸Šé‡‡æ ·                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¼–ç å™¨ç»“æ„ (Encoder)

ç¼–ç å™¨è´Ÿè´£**ç‰¹å¾æå–**ï¼Œé€šè¿‡å·ç§¯å’Œæ± åŒ–é€æ­¥å‡å°ç©ºé—´åˆ†è¾¨ç‡ï¼Œå¢åŠ ç‰¹å¾é€šé“æ•°ã€‚

```python
# ç¼–ç å™¨åŸºæœ¬å—
class EncoderBlock(nn.Module):
    """ç¼–ç å™¨çš„ä¸€ä¸ªé˜¶æ®µ"""
    def __init__(self, in_channels, out_channels):
        super().__init__()
        self.conv_block = nn.Sequential(
            # ç¬¬ä¸€ä¸ªå·ç§¯ï¼šé€šé“æ•°å˜æ¢
            nn.Conv2d(in_channels, out_channels, kernel_size=3, padding=1),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
            
            # ç¬¬äºŒä¸ªå·ç§¯ï¼šç‰¹å¾æå–
            nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
        )
        self.pool = nn.MaxPool2d(kernel_size=2, stride=2)  # ä¸‹é‡‡æ ·
    
    def forward(self, x):
        features = self.conv_block(x)  # ä¿å­˜ç”¨äºè·³è·ƒè¿æ¥
        pooled = self.pool(features)   # ä¼ é€’ç»™ä¸‹ä¸€å±‚
        return pooled, features
```

**ç¼–ç å™¨å„å±‚å‚æ•°ï¼š**

| å±‚çº§ | è¾“å…¥å°ºå¯¸ | è¾“å‡ºå°ºå¯¸ | é€šé“æ•° | æ“ä½œ |
|:---:|:-------:|:-------:|:-----:|:----:|
| Enc1 | 224Ã—224Ã—3 | 112Ã—112Ã—64 | 3â†’64 | ConvÃ—2 + MaxPool |
| Enc2 | 112Ã—112Ã—64 | 56Ã—56Ã—128 | 64â†’128 | ConvÃ—2 + MaxPool |
| Enc3 | 56Ã—56Ã—128 | 28Ã—28Ã—256 | 128â†’256 | ConvÃ—2 + MaxPool |
| Enc4 | 28Ã—28Ã—256 | 14Ã—14Ã—512 | 256â†’512 | ConvÃ—2 + MaxPool |

**ç¼–ç å™¨çš„ä½œç”¨ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æµ…å±‚ç‰¹å¾ (Enc1, Enc2):                                    â”‚
â”‚    â€¢ è¾¹ç¼˜ä¿¡æ¯ã€çº¹ç†ç»†èŠ‚                                    â”‚
â”‚    â€¢ è½¦é“çº¿çš„è½®å»“å’Œè¾¹ç•Œ                                    â”‚
â”‚    â€¢ åˆ†è¾¨ç‡é«˜ï¼Œå®šä½ç²¾ç¡®                                    â”‚
â”‚                                                            â”‚
â”‚  æ·±å±‚ç‰¹å¾ (Enc3, Enc4):                                    â”‚
â”‚    â€¢ è¯­ä¹‰ä¿¡æ¯ã€æŠ½è±¡ç‰¹å¾                                    â”‚
â”‚    â€¢ "è¿™æ˜¯è½¦é“çº¿"çš„é«˜çº§ç†è§£                                â”‚
â”‚    â€¢ æ„Ÿå—é‡å¤§ï¼Œä¸Šä¸‹æ–‡ä¸°å¯Œ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è§£ç å™¨ç»“æ„ (Decoder)

è§£ç å™¨è´Ÿè´£**ç‰¹å¾èåˆå’Œä¸Šé‡‡æ ·**ï¼Œé€æ­¥æ¢å¤ç©ºé—´åˆ†è¾¨ç‡ï¼Œç”Ÿæˆåƒç´ çº§é¢„æµ‹ã€‚

```python
# è§£ç å™¨åŸºæœ¬å—
class DecoderBlock(nn.Module):
    """è§£ç å™¨çš„ä¸€ä¸ªé˜¶æ®µ"""
    def __init__(self, in_channels, out_channels):
        super().__init__()
        # ä¸Šé‡‡æ ·ï¼ˆè½¬ç½®å·ç§¯ï¼‰
        self.up = nn.ConvTranspose2d(
            in_channels, out_channels, 
            kernel_size=2, stride=2
        )
        # å·ç§¯å—ï¼ˆå¤„ç†æ‹¼æ¥åçš„ç‰¹å¾ï¼‰
        self.conv_block = nn.Sequential(
            nn.Conv2d(out_channels * 2, out_channels, kernel_size=3, padding=1),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
            
            nn.Conv2d(out_channels, out_channels, kernel_size=3, padding=1),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
        )
    
    def forward(self, x, skip_features):
        x = self.up(x)                          # ä¸Šé‡‡æ ·
        x = torch.cat([x, skip_features], dim=1) # ä¸è·³è·ƒè¿æ¥æ‹¼æ¥
        x = self.conv_block(x)                  # å·ç§¯èåˆ
        return x
```

**è§£ç å™¨å„å±‚å‚æ•°ï¼š**

| å±‚çº§ | è¾“å…¥å°ºå¯¸ | è·³è·ƒè¿æ¥ | è¾“å‡ºå°ºå¯¸ | é€šé“æ•° |
|:---:|:-------:|:-------:|:-------:|:-----:|
| Dec4 | 14Ã—14Ã—1024 | 28Ã—28Ã—512 | 28Ã—28Ã—512 | 1024â†’512 |
| Dec3 | 28Ã—28Ã—512 | 56Ã—56Ã—256 | 56Ã—56Ã—256 | 512â†’256 |
| Dec2 | 56Ã—56Ã—256 | 112Ã—112Ã—128 | 112Ã—112Ã—128 | 256â†’128 |
| Dec1 | 112Ã—112Ã—128 | 224Ã—224Ã—64 | 224Ã—224Ã—64 | 128â†’64 |

#### è·³è·ƒè¿æ¥ (Skip Connections)

è·³è·ƒè¿æ¥æ˜¯U-Netçš„**æ ¸å¿ƒåˆ›æ–°**ï¼Œç›´æ¥å°†ç¼–ç å™¨çš„ç‰¹å¾ä¼ é€’ç»™å¯¹åº”çš„è§£ç å™¨å±‚ã€‚

```
ä¸ºä»€ä¹ˆéœ€è¦è·³è·ƒè¿æ¥ï¼Ÿ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é—®é¢˜ï¼šä¸‹é‡‡æ ·ä¸¢å¤±ç©ºé—´ä¿¡æ¯                                    â”‚
â”‚                                                             â”‚
â”‚  224Ã—224 â†’ 112Ã—112 â†’ 56Ã—56 â†’ 28Ã—28 â†’ 14Ã—14                 â”‚
â”‚     â†“         â†“         â†“        â†“        â†“                â”‚
â”‚   ç²¾ç¡®      ç•¥æ¨¡ç³Š    æ¨¡ç³Š     å¾ˆæ¨¡ç³Š   ä½ç½®ä¸¢å¤±            â”‚
â”‚                                                             â”‚
â”‚  å¦‚æœåªé ä¸Šé‡‡æ ·æ¢å¤ï¼Œè½¦é“çº¿è¾¹ç¼˜ä¼šå¾ˆæ¨¡ç³Šï¼                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è§£å†³ï¼šè·³è·ƒè¿æ¥ä¿ç•™ç²¾ç¡®ä½ç½®                                  â”‚
â”‚                                                             â”‚
â”‚  ç¼–ç å™¨ç‰¹å¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ è§£ç å™¨              â”‚
â”‚  (é«˜åˆ†è¾¨ç‡)         è·³è·ƒè¿æ¥            (éœ€è¦ç»†èŠ‚)          â”‚
â”‚                                                             â”‚
â”‚  â€¢ Enc1çš„è¾¹ç¼˜ä¿¡æ¯ â†’ Dec1ï¼Œæ¢å¤ç²¾ç¡®çš„è½¦é“çº¿è¾¹ç•Œ              â”‚
â”‚  â€¢ Enc2çš„çº¹ç†ä¿¡æ¯ â†’ Dec2ï¼Œæ¢å¤è½¦é“çº¿çš„ç»†èŠ‚                  â”‚
â”‚  â€¢ æ·±å±‚è¯­ä¹‰ + æµ…å±‚ç»†èŠ‚ = ç²¾ç¡®çš„åˆ†å‰²ç»“æœ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è·³è·ƒè¿æ¥çš„å®ç°ï¼š**

```python
# åœ¨forwardä¸­å®ç°è·³è·ƒè¿æ¥
def forward(self, x):
    # ç¼–ç å™¨ï¼šé€å±‚ä¸‹é‡‡æ ·ï¼Œä¿å­˜æ¯å±‚ç‰¹å¾
    x, enc1_features = self.encoder1(x)   # 224â†’112, ä¿å­˜224å°ºå¯¸ç‰¹å¾
    x, enc2_features = self.encoder2(x)   # 112â†’56,  ä¿å­˜112å°ºå¯¸ç‰¹å¾
    x, enc3_features = self.encoder3(x)   # 56â†’28,   ä¿å­˜56å°ºå¯¸ç‰¹å¾
    x, enc4_features = self.encoder4(x)   # 28â†’14,   ä¿å­˜28å°ºå¯¸ç‰¹å¾
    
    # Bottleneck
    x = self.bottleneck(x)                # 14Ã—14, æœ€æ·±ç‰¹å¾
    
    # è§£ç å™¨ï¼šé€å±‚ä¸Šé‡‡æ ·ï¼Œèåˆè·³è·ƒè¿æ¥
    x = self.decoder4(x, enc4_features)   # 14â†’28,  èåˆenc4
    x = self.decoder3(x, enc3_features)   # 28â†’56,  èåˆenc3
    x = self.decoder2(x, enc2_features)   # 56â†’112, èåˆenc2
    x = self.decoder1(x, enc1_features)   # 112â†’224,èåˆenc1
    
    # è¾“å‡ºå±‚
    x = self.output(x)                    # 224Ã—224Ã—1
    return x
```

#### å®Œæ•´çš„U-Netå®ç°

```python
import torch
import torch.nn as nn

class UNet(nn.Module):
    """ç”¨äºè½¦é“çº¿æ£€æµ‹çš„U-Netç½‘ç»œ"""
    
    def __init__(self, in_channels=3, out_channels=1, features=[64, 128, 256, 512]):
        super(UNet, self).__init__()
        
        self.encoder_blocks = nn.ModuleList()
        self.decoder_blocks = nn.ModuleList()
        self.pool = nn.MaxPool2d(kernel_size=2, stride=2)
        
        # ç¼–ç å™¨
        for feature in features:
            self.encoder_blocks.append(self._conv_block(in_channels, feature))
            in_channels = feature
        
        # Bottleneck
        self.bottleneck = self._conv_block(features[-1], features[-1] * 2)
        
        # è§£ç å™¨
        for feature in reversed(features):
            self.decoder_blocks.append(
                nn.ConvTranspose2d(feature * 2, feature, kernel_size=2, stride=2)
            )
            self.decoder_blocks.append(self._conv_block(feature * 2, feature))
        
        # è¾“å‡ºå±‚
        self.output = nn.Conv2d(features[0], out_channels, kernel_size=1)
    
    def _conv_block(self, in_channels, out_channels):
        """åŒå·ç§¯å—"""
        return nn.Sequential(
            nn.Conv2d(in_channels, out_channels, 3, padding=1, bias=False),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
            nn.Conv2d(out_channels, out_channels, 3, padding=1, bias=False),
            nn.BatchNorm2d(out_channels),
            nn.ReLU(inplace=True),
        )
    
    def forward(self, x):
        skip_connections = []
        
        # ç¼–ç å™¨å‰å‘ä¼ æ’­
        for encoder in self.encoder_blocks:
            x = encoder(x)
            skip_connections.append(x)
            x = self.pool(x)
        
        # Bottleneck
        x = self.bottleneck(x)
        
        # è§£ç å™¨å‰å‘ä¼ æ’­
        skip_connections = skip_connections[::-1]  # åè½¬é¡ºåº
        
        for idx in range(0, len(self.decoder_blocks), 2):
            x = self.decoder_blocks[idx](x)        # ä¸Šé‡‡æ ·
            skip = skip_connections[idx // 2]      # è·å–è·³è·ƒè¿æ¥
            x = torch.cat([skip, x], dim=1)        # æ‹¼æ¥
            x = self.decoder_blocks[idx + 1](x)    # å·ç§¯
        
        return self.output(x)

# åˆ›å»ºæ¨¡å‹
model = UNet(in_channels=3, out_channels=1)

# æµ‹è¯•
x = torch.randn(1, 3, 224, 224)
output = model(x)
print(f"è¾“å…¥å°ºå¯¸: {x.shape}")      # torch.Size([1, 3, 224, 224])
print(f"è¾“å‡ºå°ºå¯¸: {output.shape}") # torch.Size([1, 1, 224, 224])
```

#### æ¨¡å‹å‚æ•°ç»Ÿè®¡

| é¡¹ç›® | æ•°å€¼ |
|-----|------|
| æ€»å‚æ•°é‡ | ~31M |
| å¯è®­ç»ƒå‚æ•° | ~31M |
| æ¨¡å‹å¤§å° (FP32) | ~120MB |
| æ¨¡å‹å¤§å° (INT8é‡åŒ–å) | ~30MB |
| è¾“å…¥å°ºå¯¸ | 224Ã—224Ã—3 |
| è¾“å‡ºå°ºå¯¸ | 224Ã—224Ã—1 |

> ğŸ’¡ **è½»é‡åŒ–é€‰æ‹©**ï¼šå¦‚æœéœ€è¦æ›´å¿«çš„æ¨ç†é€Ÿåº¦ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ MobileNetV2 ä½œä¸ºç¼–ç å™¨éª¨å¹²ç½‘ç»œï¼Œæˆ–ä½¿ç”¨ U-Net++ / Attention U-Net ç­‰å˜ä½“ã€‚

### è®­ç»ƒé…ç½®

#### è¶…å‚æ•°è¯´æ˜

| è¶…å‚æ•° | æ¨èå€¼ | å–å€¼èŒƒå›´ | è¯´æ˜ |
|:------:|:-----:|:-------:|:-----|
| **å­¦ä¹ ç‡** | 1e-4 | 1e-5 ~ 1e-3 | åˆå§‹å­¦ä¹ ç‡ï¼Œé…åˆè°ƒåº¦å™¨ä½¿ç”¨ |
| **æ‰¹é‡å¤§å°** | 8 | 4 ~ 32 | è§†GPUæ˜¾å­˜è°ƒæ•´ï¼Œæ˜¾å­˜ä¸è¶³å¯å‡å° |
| **è®­ç»ƒè½®æ•°** | 100 | 50 ~ 200 | é…åˆæ—©åœç­–ç•¥ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ |
| **è¾“å…¥å°ºå¯¸** | 224Ã—224 | 128~512 | éœ€ä¸RKNNéƒ¨ç½²å°ºå¯¸ä¸€è‡´ |
| **ä¼˜åŒ–å™¨** | AdamW | Adam/AdamW/SGD | AdamWå¸¦æƒé‡è¡°å‡ï¼Œæ³›åŒ–æ›´å¥½ |
| **æƒé‡è¡°å‡** | 1e-4 | 1e-5 ~ 1e-3 | é˜²æ­¢è¿‡æ‹Ÿåˆçš„L2æ­£åˆ™åŒ– |
| **å­¦ä¹ ç‡è°ƒåº¦** | CosineAnnealing | Step/Cosine/Plateau | ä½™å¼¦é€€ç«æ•ˆæœè¾ƒå¥½ |
| **æ—©åœè€å¿ƒå€¼** | 15 | 10 ~ 20 | éªŒè¯é›†æ€§èƒ½ä¸æå‡æ—¶ç­‰å¾…çš„è½®æ•° |

#### å®Œæ•´è®­ç»ƒé…ç½®

```python
# config.py - è®­ç»ƒé…ç½®æ–‡ä»¶

import torch
from dataclasses import dataclass
from typing import Tuple

@dataclass
class TrainConfig:
    """è®­ç»ƒé…ç½®ç±»"""
    
    # ===== æ•°æ®é…ç½® =====
    data_root: str = "./dataset"           # æ•°æ®é›†æ ¹ç›®å½•
    image_size: Tuple[int, int] = (224, 224)  # è¾“å…¥å›¾åƒå°ºå¯¸
    num_workers: int = 4                    # æ•°æ®åŠ è½½çº¿ç¨‹æ•°
    pin_memory: bool = True                 # é”é¡µå†…å­˜åŠ é€Ÿ
    
    # ===== æ¨¡å‹é…ç½® =====
    in_channels: int = 3                    # è¾“å…¥é€šé“æ•° (RGB)
    out_channels: int = 1                   # è¾“å‡ºé€šé“æ•° (äºŒå€¼æ©ç )
    features: list = None                   # ç¼–ç å™¨é€šé“æ•°
    
    # ===== è®­ç»ƒè¶…å‚æ•° =====
    batch_size: int = 8                     # æ‰¹é‡å¤§å°
    epochs: int = 100                       # è®­ç»ƒè½®æ•°
    learning_rate: float = 1e-4             # åˆå§‹å­¦ä¹ ç‡
    weight_decay: float = 1e-4              # æƒé‡è¡°å‡ (L2æ­£åˆ™åŒ–)
    
    # ===== å­¦ä¹ ç‡è°ƒåº¦ =====
    scheduler: str = "cosine"               # è°ƒåº¦å™¨ç±»å‹: cosine/step/plateau
    warmup_epochs: int = 5                  # é¢„çƒ­è½®æ•°
    min_lr: float = 1e-6                    # æœ€å°å­¦ä¹ ç‡
    
    # ===== æ—©åœé…ç½® =====
    early_stopping: bool = True             # æ˜¯å¦å¯ç”¨æ—©åœ
    patience: int = 15                      # æ—©åœè€å¿ƒå€¼
    min_delta: float = 1e-4                 # æœ€å°æ”¹è¿›é˜ˆå€¼
    
    # ===== æŸå¤±å‡½æ•° =====
    loss_type: str = "bce_dice"             # æŸå¤±ç±»å‹: bce/dice/bce_dice
    bce_weight: float = 0.5                 # BCEæŸå¤±æƒé‡
    dice_weight: float = 0.5                # DiceæŸå¤±æƒé‡
    
    # ===== ä¿å­˜é…ç½® =====
    save_dir: str = "./checkpoints"         # æ¨¡å‹ä¿å­˜ç›®å½•
    save_best_only: bool = True             # åªä¿å­˜æœ€ä¼˜æ¨¡å‹
    save_every_n_epochs: int = 10           # æ¯Nè½®ä¿å­˜ä¸€æ¬¡
    
    # ===== å…¶ä»– =====
    seed: int = 42                          # éšæœºç§å­
    device: str = "cuda"                    # è®­ç»ƒè®¾å¤‡
    mixed_precision: bool = True            # æ··åˆç²¾åº¦è®­ç»ƒ (FP16)
    
    def __post_init__(self):
        if self.features is None:
            self.features = [64, 128, 256, 512]


# åˆ›å»ºé…ç½®å®ä¾‹
config = TrainConfig()
```

#### é…ç½®ä½¿ç”¨ç¤ºä¾‹

```python
# train.py - ä½¿ç”¨é…ç½®

from config import TrainConfig
import torch
import torch.optim as optim
from torch.optim.lr_scheduler import CosineAnnealingLR

# åŠ è½½é…ç½®
config = TrainConfig()

# è®¾ç½®éšæœºç§å­ï¼ˆä¿è¯å¯å¤ç°ï¼‰
torch.manual_seed(config.seed)
if torch.cuda.is_available():
    torch.cuda.manual_seed_all(config.seed)

# åˆ›å»ºæ¨¡å‹
model = UNet(
    in_channels=config.in_channels,
    out_channels=config.out_channels,
    features=config.features
).to(config.device)

# ä¼˜åŒ–å™¨
optimizer = optim.AdamW(
    model.parameters(),
    lr=config.learning_rate,
    weight_decay=config.weight_decay
)

# å­¦ä¹ ç‡è°ƒåº¦å™¨
scheduler = CosineAnnealingLR(
    optimizer,
    T_max=config.epochs - config.warmup_epochs,
    eta_min=config.min_lr
)

# æ•°æ®åŠ è½½å™¨
train_loader = DataLoader(
    train_dataset,
    batch_size=config.batch_size,
    shuffle=True,
    num_workers=config.num_workers,
    pin_memory=config.pin_memory
)
```

#### ä¸åŒåœºæ™¯çš„é…ç½®å»ºè®®

| åœºæ™¯ | æ‰¹é‡å¤§å° | å­¦ä¹ ç‡ | è½®æ•° | è¯´æ˜ |
|:----:|:-------:|:-----:|:----:|:-----|
| **å¿«é€ŸéªŒè¯** | 16 | 1e-3 | 20 | å¿«é€ŸéªŒè¯ä»£ç å’Œæ•°æ®æ˜¯å¦æ­£ç¡® |
| **å°æ•°æ®é›†** (<500å¼ ) | 4 | 1e-4 | 150 | å°æ‰¹é‡+é•¿è®­ç»ƒé˜²æ­¢è¿‡æ‹Ÿåˆ |
| **ä¸­ç­‰æ•°æ®é›†** (500-2000å¼ ) | 8 | 1e-4 | 100 | æ ‡å‡†é…ç½® |
| **å¤§æ•°æ®é›†** (>2000å¼ ) | 16-32 | 3e-4 | 80 | å¯é€‚å½“å¢å¤§å­¦ä¹ ç‡ |
| **å¾®è°ƒé¢„è®­ç»ƒ** | 4 | 1e-5 | 50 | å°å­¦ä¹ ç‡ä¿æŠ¤é¢„è®­ç»ƒæƒé‡ |

#### GPUæ˜¾å­˜ä¸æ‰¹é‡å¤§å°å¯¹ç…§

| GPUæ˜¾å­˜ | æ¨èæ‰¹é‡å¤§å° | å¤‡æ³¨ |
|:------:|:-----------:|:-----|
| 4GB | 2-4 | å¯èƒ½éœ€è¦æ¢¯åº¦ç´¯ç§¯ |
| 6GB | 4-8 | GTX 1060çº§åˆ« |
| 8GB | 8-16 | RTX 3060/3070çº§åˆ« |
| 12GB+ | 16-32 | RTX 3080/4080çº§åˆ« |

> âš ï¸ **æ˜¾å­˜ä¸è¶³çš„è§£å†³æ–¹æ¡ˆ**ï¼š
> 1. å‡å° `batch_size`
> 2. å‡å° `image_size`ï¼ˆå¦‚224â†’192ï¼‰
> 3. ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯ï¼ˆå°æ‰¹é‡å¤šæ¬¡ç´¯ç§¯ç­‰æ•ˆå¤§æ‰¹é‡ï¼‰
> 4. å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆ`mixed_precision: True`ï¼‰

### æŸå¤±å‡½æ•°

è¯­ä¹‰åˆ†å‰²ä»»åŠ¡ä¸­ï¼ŒæŸå¤±å‡½æ•°çš„é€‰æ‹©ç›´æ¥å½±å“æ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚æœ¬é¡¹ç›®é‡‡ç”¨ **BCE + Dice ç»„åˆæŸå¤±**ï¼Œå…¼é¡¾åƒç´ çº§ç²¾åº¦å’ŒåŒºåŸŸçº§å®Œæ•´æ€§ã€‚

#### æŸå¤±å‡½æ•°å¯¹æ¯”

| æŸå¤±å‡½æ•° | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|:-------:|:-----|:-----|:---------|
| **BCE** | åƒç´ çº§ç²¾ç¡®ï¼Œæ¢¯åº¦ç¨³å®š | ç±»åˆ«ä¸å¹³è¡¡æ—¶æ•ˆæœå·® | å¹³è¡¡æ•°æ®é›† |
| **Dice** | å¯¹ç±»åˆ«ä¸å¹³è¡¡é²æ£’ | å°ç›®æ ‡æ¢¯åº¦ä¸ç¨³å®š | ä¸å¹³è¡¡æ•°æ®é›† |
| **BCE+Dice** | å…¼é¡¾ä¸¤è€…ä¼˜ç‚¹ | éœ€è¦è°ƒèŠ‚æƒé‡ | **æ¨èä½¿ç”¨** |

---

#### BCE Loss (Binary Cross Entropy)

**åŸç†**ï¼šé€åƒç´ è®¡ç®—é¢„æµ‹æ¦‚ç‡ä¸çœŸå®æ ‡ç­¾çš„äº¤å‰ç†µã€‚

**æ•°å­¦å…¬å¼**ï¼š

$$
\mathcal{L}_{BCE} = -\frac{1}{N}\sum_{i=1}^{N}\left[y_i \cdot \log(p_i) + (1-y_i) \cdot \log(1-p_i)\right]
$$

å…¶ä¸­ï¼š
- $N$ æ˜¯åƒç´ æ€»æ•°
- $y_i \in \{0, 1\}$ æ˜¯ç¬¬ $i$ ä¸ªåƒç´ çš„çœŸå®æ ‡ç­¾
- $p_i \in [0, 1]$ æ˜¯ç¬¬ $i$ ä¸ªåƒç´ çš„é¢„æµ‹æ¦‚ç‡

**ä»£ç å®ç°**ï¼š

```python
import torch
import torch.nn as nn

class BCELoss(nn.Module):
    """äºŒå…ƒäº¤å‰ç†µæŸå¤±"""
    
    def __init__(self, pos_weight=None):
        super().__init__()
        # pos_weight: æ­£æ ·æœ¬æƒé‡ï¼Œç”¨äºå¤„ç†ç±»åˆ«ä¸å¹³è¡¡
        # å¦‚æœèƒŒæ™¯:è½¦é“çº¿ = 9:1ï¼Œåˆ™ pos_weight=9
        self.criterion = nn.BCEWithLogitsLoss(pos_weight=pos_weight)
    
    def forward(self, pred, target):
        """
        Args:
            pred: æ¨¡å‹è¾“å‡º (B, 1, H, W)ï¼Œæœªç»Sigmoid
            target: çœŸå®æ ‡ç­¾ (B, 1, H, W)ï¼Œå€¼ä¸º0æˆ–1
        """
        return self.criterion(pred, target.float())


# ä½¿ç”¨ç¤ºä¾‹
bce_loss = BCELoss(pos_weight=torch.tensor([5.0]).cuda())  # æ­£æ ·æœ¬æƒé‡=5
loss = bce_loss(pred, target)
```

**BCE Loss çš„é—®é¢˜**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç±»åˆ«ä¸å¹³è¡¡é—®é¢˜ç¤ºæ„                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å…¸å‹è½¦é“çº¿å›¾åƒä¸­ï¼š                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚  èƒŒæ™¯åƒç´ : ~95%   â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚  è½¦é“çº¿åƒç´ : ~5%  â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â•â•â•â•â•â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚                   â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                             â”‚
â”‚  å¦‚æœæ¨¡å‹æŠŠæ‰€æœ‰åƒç´ éƒ½é¢„æµ‹ä¸ºèƒŒæ™¯ï¼š                            â”‚
â”‚  - å‡†ç¡®ç‡ä»æœ‰95%ï¼                                          â”‚
â”‚  - BCE Lossè¾ƒå°ï¼Œæ¨¡å‹"å·æ‡’"ä¸å­¦ä¹ è½¦é“çº¿                     â”‚
â”‚                                                             â”‚
â”‚  â†’ éœ€è¦ Dice Loss è¡¥å……ï¼                                    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### Dice Loss

**åŸç†**ï¼šåŸºäº Dice ç³»æ•°ï¼Œè¡¡é‡é¢„æµ‹åŒºåŸŸä¸çœŸå®åŒºåŸŸçš„é‡å ç¨‹åº¦ã€‚

**æ•°å­¦å…¬å¼**ï¼š

$$
\mathcal{L}_{Dice} = 1 - \frac{2 \sum_{i=1}^{N} p_i \cdot y_i + \epsilon}{\sum_{i=1}^{N} p_i + \sum_{i=1}^{N} y_i + \epsilon}
$$

å…¶ä¸­ï¼š
- $p_i$ æ˜¯é¢„æµ‹æ¦‚ç‡
- $y_i$ æ˜¯çœŸå®æ ‡ç­¾
- $\epsilon$ æ˜¯å¹³æ»‘é¡¹ï¼Œé˜²æ­¢åˆ†æ¯ä¸º0ï¼ˆé€šå¸¸å–1e-6ï¼‰

**ç›´è§‰ç†è§£**ï¼š

```
Diceç³»æ•° = 2 Ã— |A âˆ© B| / (|A| + |B|)

      é¢„æµ‹åŒºåŸŸ A          çœŸå®åŒºåŸŸ B
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚           â”‚      â”‚           â”‚
    â”‚     â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”     â”‚
    â”‚     â”‚     â”‚  Aâˆ©B â”‚     â”‚     â”‚
    â”‚     â”‚     â”‚ é‡å  â”‚     â”‚     â”‚
    â”‚     â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜     â”‚
    â”‚           â”‚      â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

- å®Œå…¨é‡åˆ: Dice = 1, Loss = 0
- å®Œå…¨ä¸é‡åˆ: Dice = 0, Loss = 1
- éƒ¨åˆ†é‡åˆ: 0 < Dice < 1
```

**ä»£ç å®ç°**ï¼š

```python
class DiceLoss(nn.Module):
    """DiceæŸå¤± - å¯¹ç±»åˆ«ä¸å¹³è¡¡é²æ£’"""
    
    def __init__(self, smooth=1e-6):
        super().__init__()
        self.smooth = smooth
    
    def forward(self, pred, target):
        """
        Args:
            pred: æ¨¡å‹è¾“å‡º (B, 1, H, W)ï¼Œæœªç»Sigmoid
            target: çœŸå®æ ‡ç­¾ (B, 1, H, W)
        """
        # Sigmoidæ¿€æ´»
        pred = torch.sigmoid(pred)
        
        # å±•å¹³
        pred = pred.view(-1)
        target = target.view(-1).float()
        
        # è®¡ç®—Diceç³»æ•°
        intersection = (pred * target).sum()
        dice = (2. * intersection + self.smooth) / (
            pred.sum() + target.sum() + self.smooth
        )
        
        return 1 - dice


# ä½¿ç”¨ç¤ºä¾‹
dice_loss = DiceLoss()
loss = dice_loss(pred, target)
```

**Dice Loss çš„ä¼˜åŠ¿**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dice Loss å¦‚ä½•è§£å†³ç±»åˆ«ä¸å¹³è¡¡                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å‡è®¾å›¾åƒä¸­è½¦é“çº¿åªå 5%çš„åƒç´ ï¼š                              â”‚
â”‚                                                             â”‚
â”‚  BCEè§†è§’ï¼š                                                   â”‚
â”‚    - 95%èƒŒæ™¯é¢„æµ‹æ­£ç¡® â†’ æŸå¤±å¾ˆå° âœ—                           â”‚
â”‚    - æ¨¡å‹å€¾å‘äºå…¨éƒ¨é¢„æµ‹ä¸ºèƒŒæ™¯                                â”‚
â”‚                                                             â”‚
â”‚  Diceè§†è§’ï¼š                                                  â”‚
â”‚    - åªå…³æ³¨"é¢„æµ‹åŒºåŸŸ"å’Œ"çœŸå®åŒºåŸŸ"çš„é‡å                      â”‚
â”‚    - å¦‚æœé¢„æµ‹å…¨é»‘ â†’ äº¤é›†=0 â†’ Dice=0 â†’ Loss=1 (æœ€å¤§!)       â”‚
â”‚    - å¿…é¡»æ­£ç¡®é¢„æµ‹è½¦é“çº¿æ‰èƒ½é™ä½æŸå¤± âœ“                       â”‚
â”‚                                                             â”‚
â”‚  â†’ Diceå¼ºåˆ¶æ¨¡å‹å­¦ä¹ å°‘æ•°ç±»ç‰¹å¾                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### BCE + Dice ç»„åˆæŸå¤±ï¼ˆæ¨èï¼‰

**åŸç†**ï¼šç»“åˆ BCE çš„åƒç´ çº§ç²¾ç¡®æ€§å’Œ Dice çš„åŒºåŸŸçº§é²æ£’æ€§ã€‚

**æ•°å­¦å…¬å¼**ï¼š

$$
\mathcal{L}_{total} = \alpha \cdot \mathcal{L}_{BCE} + \beta \cdot \mathcal{L}_{Dice}
$$

é€šå¸¸å– $\alpha = \beta = 0.5$ï¼Œå³å„å 50%æƒé‡ã€‚

**å®Œæ•´å®ç°**ï¼š

```python
class BCEDiceLoss(nn.Module):
    """BCE + Dice ç»„åˆæŸå¤±ï¼ˆæ¨èç”¨äºè½¦é“çº¿æ£€æµ‹ï¼‰"""
    
    def __init__(self, bce_weight=0.5, dice_weight=0.5, 
                 pos_weight=None, smooth=1e-6):
        super().__init__()
        self.bce_weight = bce_weight
        self.dice_weight = dice_weight
        self.smooth = smooth
        
        # BCEæŸå¤±
        self.bce = nn.BCEWithLogitsLoss(pos_weight=pos_weight)
    
    def forward(self, pred, target):
        """
        Args:
            pred: æ¨¡å‹è¾“å‡º (B, 1, H, W)ï¼Œlogitsï¼ˆæœªç»Sigmoidï¼‰
            target: çœŸå®æ ‡ç­¾ (B, 1, H, W)ï¼Œå€¼ä¸º0æˆ–1
        Returns:
            ç»„åˆæŸå¤±å€¼
        """
        # === BCE Loss ===
        bce_loss = self.bce(pred, target.float())
        
        # === Dice Loss ===
        pred_sigmoid = torch.sigmoid(pred)
        pred_flat = pred_sigmoid.view(-1)
        target_flat = target.view(-1).float()
        
        intersection = (pred_flat * target_flat).sum()
        dice_coeff = (2. * intersection + self.smooth) / (
            pred_flat.sum() + target_flat.sum() + self.smooth
        )
        dice_loss = 1 - dice_coeff
        
        # === ç»„åˆæŸå¤± ===
        total_loss = self.bce_weight * bce_loss + self.dice_weight * dice_loss
        
        return total_loss, bce_loss, dice_loss  # è¿”å›å„é¡¹ç”¨äºç›‘æ§


# ä½¿ç”¨ç¤ºä¾‹
criterion = BCEDiceLoss(
    bce_weight=0.5, 
    dice_weight=0.5,
    pos_weight=torch.tensor([3.0]).cuda()  # è½¦é“çº¿æ­£æ ·æœ¬æƒé‡
)

# è®­ç»ƒå¾ªç¯ä¸­
pred = model(images)                        # (B, 1, H, W)
total_loss, bce, dice = criterion(pred, masks)
total_loss.backward()
```

#### Focal Lossï¼ˆå¯é€‰ï¼‰

å½“æ­£è´Ÿæ ·æœ¬æåº¦ä¸å¹³è¡¡æ—¶ï¼Œå¯è€ƒè™‘ Focal Lossï¼š

```python
class FocalLoss(nn.Module):
    """Focal Loss - èšç„¦éš¾åˆ†æ ·æœ¬"""
    
    def __init__(self, alpha=0.25, gamma=2.0):
        super().__init__()
        self.alpha = alpha  # å¹³è¡¡å› å­
        self.gamma = gamma  # èšç„¦å‚æ•°
    
    def forward(self, pred, target):
        pred_sigmoid = torch.sigmoid(pred)
        
        # è®¡ç®—äº¤å‰ç†µ
        ce_loss = F.binary_cross_entropy_with_logits(
            pred, target.float(), reduction='none'
        )
        
        # è®¡ç®—è°ƒåˆ¶å› å­ (1 - p_t)^gamma
        p_t = pred_sigmoid * target + (1 - pred_sigmoid) * (1 - target)
        focal_weight = (1 - p_t) ** self.gamma
        
        # åº”ç”¨alphaå¹³è¡¡
        alpha_t = self.alpha * target + (1 - self.alpha) * (1 - target)
        
        focal_loss = alpha_t * focal_weight * ce_loss
        
        return focal_loss.mean()
```

#### æŸå¤±å‡½æ•°é€‰æ‹©å»ºè®®

| æ•°æ®æƒ…å†µ | æ¨èæŸå¤±å‡½æ•° | é…ç½® |
|:-------:|:-----------:|:-----|
| ç±»åˆ«åŸºæœ¬å¹³è¡¡ | BCE | é»˜è®¤é…ç½® |
| è½»åº¦ä¸å¹³è¡¡ (è½¦é“çº¿10-30%) | BCE + Dice | å„0.5æƒé‡ |
| ä¸­åº¦ä¸å¹³è¡¡ (è½¦é“çº¿5-10%) | BCE + Dice | BCEå¸¦pos_weight |
| é‡åº¦ä¸å¹³è¡¡ (è½¦é“çº¿<5%) | Focal + Dice | gamma=2.0 |

> ğŸ’¡ **æœ¬é¡¹ç›®æ¨è**ï¼šä½¿ç”¨ `BCEDiceLoss`ï¼Œé…ç½® `bce_weight=0.5, dice_weight=0.5, pos_weight=3.0`

### è®­ç»ƒæµç¨‹

#### è®­ç»ƒæµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è®­ç»ƒæµç¨‹å›¾                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ•°æ®é›†  â”‚ â†’  â”‚ æ•°æ®    â”‚ â†’  â”‚ æ¨¡å‹    â”‚ â†’  â”‚ è®­ç»ƒ    â”‚ â†’  â”‚ æ¨¡å‹    â”‚  â”‚
â”‚  â”‚ å‡†å¤‡    â”‚    â”‚ åŠ è½½å™¨  â”‚    â”‚ åˆå§‹åŒ–  â”‚    â”‚ å¾ªç¯    â”‚    â”‚ ä¿å­˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚              â”‚              â”‚              â”‚              â”‚        â”‚
â”‚       â†“              â†“              â†“              â†“              â†“        â”‚
â”‚   images/       DataLoader      UNet()      for epoch      best.pth       â”‚
â”‚   masks/        + Augment       + GPU       in epochs:     last.pth       â”‚
â”‚                                              train()                       â”‚
â”‚                                              validate()                    â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´è®­ç»ƒä»£ç 

```python
# train.py - å®Œæ•´çš„è®­ç»ƒè„šæœ¬

import os
import torch
import torch.nn as nn
import torch.optim as optim
from torch.utils.data import Dataset, DataLoader
from torch.optim.lr_scheduler import CosineAnnealingWarmRestarts
import albumentations as A
from albumentations.pytorch import ToTensorV2
import cv2
import numpy as np
from tqdm import tqdm
import logging

# ===================== 1. æ•°æ®é›†å®šä¹‰ =====================

class LaneDataset(Dataset):
    """è½¦é“çº¿åˆ†å‰²æ•°æ®é›†"""
    
    def __init__(self, image_dir, mask_dir, transform=None):
        self.image_dir = image_dir
        self.mask_dir = mask_dir
        self.transform = transform
        
        # è·å–æ‰€æœ‰å›¾åƒæ–‡ä»¶å
        self.images = sorted([f for f in os.listdir(image_dir) 
                              if f.endswith(('.jpg', '.png'))])
    
    def __len__(self):
        return len(self.images)
    
    def __getitem__(self, idx):
        # è¯»å–å›¾åƒ
        img_name = self.images[idx]
        img_path = os.path.join(self.image_dir, img_name)
        image = cv2.imread(img_path)
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
        
        # è¯»å–æ©ç 
        mask_name = img_name.replace('.jpg', '.png')
        mask_path = os.path.join(self.mask_dir, mask_name)
        mask = cv2.imread(mask_path, cv2.IMREAD_GRAYSCALE)
        mask = (mask > 127).astype(np.float32)  # äºŒå€¼åŒ–
        
        # æ•°æ®å¢å¼º
        if self.transform:
            augmented = self.transform(image=image, mask=mask)
            image = augmented['image']
            mask = augmented['mask'].unsqueeze(0)  # (H,W) â†’ (1,H,W)
        
        return image, mask


# ===================== 2. æ•°æ®å¢å¼º =====================

def get_transforms(image_size=224):
    """è·å–è®­ç»ƒå’ŒéªŒè¯çš„æ•°æ®å¢å¼º"""
    
    train_transform = A.Compose([
        A.Resize(image_size, image_size),
        A.HorizontalFlip(p=0.5),
        A.Rotate(limit=15, p=0.5),
        A.RandomBrightnessContrast(brightness_limit=0.3, contrast_limit=0.3, p=0.7),
        A.HueSaturationValue(hue_shift_limit=30, sat_shift_limit=30, val_shift_limit=30, p=0.7),
        A.GaussianBlur(blur_limit=(3, 7), p=0.3),
        A.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
        ToTensorV2(),
    ])
    
    val_transform = A.Compose([
        A.Resize(image_size, image_size),
        A.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
        ToTensorV2(),
    ])
    
    return train_transform, val_transform


# ===================== 3. è®­ç»ƒå‡½æ•° =====================

def train_one_epoch(model, dataloader, criterion, optimizer, device, epoch):
    """è®­ç»ƒä¸€ä¸ªepoch"""
    model.train()
    total_loss = 0.0
    
    pbar = tqdm(dataloader, desc=f"Epoch {epoch} [Train]")
    for images, masks in pbar:
        images = images.to(device)
        masks = masks.to(device)
        
        # å‰å‘ä¼ æ’­
        optimizer.zero_grad()
        outputs = model(images)
        
        # è®¡ç®—æŸå¤±
        loss, bce, dice = criterion(outputs, masks)
        
        # åå‘ä¼ æ’­
        loss.backward()
        optimizer.step()
        
        total_loss += loss.item()
        pbar.set_postfix({'loss': f'{loss.item():.4f}'})
    
    return total_loss / len(dataloader)


def validate(model, dataloader, criterion, device, epoch):
    """éªŒè¯"""
    model.eval()
    total_loss = 0.0
    total_dice = 0.0
    
    with torch.no_grad():
        pbar = tqdm(dataloader, desc=f"Epoch {epoch} [Val]")
        for images, masks in pbar:
            images = images.to(device)
            masks = masks.to(device)
            
            outputs = model(images)
            loss, bce, dice = criterion(outputs, masks)
            
            # è®¡ç®—Diceç³»æ•°
            pred = torch.sigmoid(outputs) > 0.5
            dice_score = compute_dice(pred, masks)
            
            total_loss += loss.item()
            total_dice += dice_score.item()
    
    avg_loss = total_loss / len(dataloader)
    avg_dice = total_dice / len(dataloader)
    
    return avg_loss, avg_dice


def compute_dice(pred, target, smooth=1e-6):
    """è®¡ç®—Diceç³»æ•°"""
    pred = pred.view(-1).float()
    target = target.view(-1).float()
    intersection = (pred * target).sum()
    return (2. * intersection + smooth) / (pred.sum() + target.sum() + smooth)


# ===================== 4. ä¸»è®­ç»ƒå‡½æ•° =====================

def train(config):
    """ä¸»è®­ç»ƒå‡½æ•°"""
    
    # è®¾ç½®æ—¥å¿—
    logging.basicConfig(level=logging.INFO, 
                        format='%(asctime)s - %(levelname)s - %(message)s')
    logger = logging.getLogger(__name__)
    
    # è®¾ç½®è®¾å¤‡
    device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
    logger.info(f"Using device: {device}")
    
    # è®¾ç½®éšæœºç§å­
    torch.manual_seed(config['seed'])
    if torch.cuda.is_available():
        torch.cuda.manual_seed_all(config['seed'])
    
    # åˆ›å»ºæ•°æ®é›†å’Œæ•°æ®åŠ è½½å™¨
    train_transform, val_transform = get_transforms(config['image_size'])
    
    train_dataset = LaneDataset(
        image_dir=os.path.join(config['data_root'], 'images/train'),
        mask_dir=os.path.join(config['data_root'], 'masks/train'),
        transform=train_transform
    )
    
    val_dataset = LaneDataset(
        image_dir=os.path.join(config['data_root'], 'images/val'),
        mask_dir=os.path.join(config['data_root'], 'masks/val'),
        transform=val_transform
    )
    
    train_loader = DataLoader(train_dataset, batch_size=config['batch_size'],
                              shuffle=True, num_workers=4, pin_memory=True)
    val_loader = DataLoader(val_dataset, batch_size=config['batch_size'],
                            shuffle=False, num_workers=4, pin_memory=True)
    
    logger.info(f"Train samples: {len(train_dataset)}, Val samples: {len(val_dataset)}")
    
    # åˆ›å»ºæ¨¡å‹
    model = UNet(in_channels=3, out_channels=1).to(device)
    logger.info(f"Model parameters: {sum(p.numel() for p in model.parameters()):,}")
    
    # æŸå¤±å‡½æ•°
    criterion = BCEDiceLoss(bce_weight=0.5, dice_weight=0.5,
                            pos_weight=torch.tensor([3.0]).to(device))
    
    # ä¼˜åŒ–å™¨
    optimizer = optim.AdamW(model.parameters(), lr=config['learning_rate'],
                            weight_decay=config['weight_decay'])
    
    # å­¦ä¹ ç‡è°ƒåº¦å™¨
    scheduler = CosineAnnealingWarmRestarts(optimizer, T_0=10, T_mult=2)
    
    # è®­ç»ƒå¾ªç¯
    best_dice = 0.0
    patience_counter = 0
    
    os.makedirs(config['save_dir'], exist_ok=True)
    
    for epoch in range(1, config['epochs'] + 1):
        logger.info(f"\n{'='*50}")
        logger.info(f"Epoch {epoch}/{config['epochs']}")
        logger.info(f"Learning Rate: {optimizer.param_groups[0]['lr']:.6f}")
        
        # è®­ç»ƒ
        train_loss = train_one_epoch(model, train_loader, criterion, 
                                      optimizer, device, epoch)
        
        # éªŒè¯
        val_loss, val_dice = validate(model, val_loader, criterion, device, epoch)
        
        # æ›´æ–°å­¦ä¹ ç‡
        scheduler.step()
        
        # æ—¥å¿—
        logger.info(f"Train Loss: {train_loss:.4f}")
        logger.info(f"Val Loss: {val_loss:.4f}, Val Dice: {val_dice:.4f}")
        
        # ä¿å­˜æœ€ä½³æ¨¡å‹
        if val_dice > best_dice:
            best_dice = val_dice
            patience_counter = 0
            torch.save({
                'epoch': epoch,
                'model_state_dict': model.state_dict(),
                'optimizer_state_dict': optimizer.state_dict(),
                'best_dice': best_dice,
            }, os.path.join(config['save_dir'], 'best_model.pth'))
            logger.info(f"âœ“ Saved best model (Dice: {best_dice:.4f})")
        else:
            patience_counter += 1
        
        # æ—©åœ
        if patience_counter >= config['patience']:
            logger.info(f"Early stopping at epoch {epoch}")
            break
        
        # å®šæœŸä¿å­˜
        if epoch % 10 == 0:
            torch.save({
                'epoch': epoch,
                'model_state_dict': model.state_dict(),
            }, os.path.join(config['save_dir'], f'checkpoint_epoch{epoch}.pth'))
    
    # ä¿å­˜æœ€ç»ˆæ¨¡å‹
    torch.save(model.state_dict(), os.path.join(config['save_dir'], 'last_model.pth'))
    logger.info(f"\nTraining completed! Best Dice: {best_dice:.4f}")
    
    return model


# ===================== 5. è¿è¡Œè®­ç»ƒ =====================

if __name__ == '__main__':
    config = {
        'data_root': './dataset',
        'image_size': 224,
        'batch_size': 8,
        'epochs': 100,
        'learning_rate': 1e-4,
        'weight_decay': 1e-4,
        'patience': 15,
        'seed': 42,
        'save_dir': './checkpoints',
    }
    
    model = train(config)
```

#### è®­ç»ƒå‘½ä»¤

```bash
# 1. æ¿€æ´»ç¯å¢ƒ
conda activate lane_detection

# 2. å®‰è£…ä¾èµ–
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
pip install albumentations opencv-python tqdm

# 3. å‡†å¤‡æ•°æ®é›†ç›®å½•ç»“æ„
#    dataset/
#    â”œâ”€â”€ images/
#    â”‚   â”œâ”€â”€ train/
#    â”‚   â””â”€â”€ val/
#    â””â”€â”€ masks/
#        â”œâ”€â”€ train/
#        â””â”€â”€ val/

# 4. å¼€å§‹è®­ç»ƒ
python train.py

# 5. ä½¿ç”¨è‡ªå®šä¹‰é…ç½®è®­ç»ƒ
python train.py --data_root ./my_dataset --batch_size 16 --epochs 150
```

#### è®­ç»ƒè¿‡ç¨‹ç›‘æ§

**1. ç»ˆç«¯è¾“å‡ºç¤ºä¾‹ï¼š**

```
2026-02-09 10:30:00 - INFO - Using device: cuda
2026-02-09 10:30:01 - INFO - Train samples: 960, Val samples: 240
2026-02-09 10:30:01 - INFO - Model parameters: 31,037,633

==================================================
Epoch 1/100
Learning Rate: 0.000100
Epoch 1 [Train]: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 120/120 [02:30<00:00, loss=0.4523]
Epoch 1 [Val]:   100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 30/30 [00:25<00:00]
2026-02-09 10:33:00 - INFO - Train Loss: 0.4523
2026-02-09 10:33:00 - INFO - Val Loss: 0.3812, Val Dice: 0.6521
2026-02-09 10:33:00 - INFO - âœ“ Saved best model (Dice: 0.6521)

==================================================
Epoch 2/100
...
```

**2. ä½¿ç”¨ TensorBoard ç›‘æ§ï¼ˆå¯é€‰ï¼‰ï¼š**

```python
# æ·»åŠ åˆ°è®­ç»ƒä»£ç ä¸­
from torch.utils.tensorboard import SummaryWriter

writer = SummaryWriter('runs/lane_unet')

# åœ¨è®­ç»ƒå¾ªç¯ä¸­è®°å½•
writer.add_scalar('Loss/train', train_loss, epoch)
writer.add_scalar('Loss/val', val_loss, epoch)
writer.add_scalar('Dice/val', val_dice, epoch)
writer.add_scalar('LR', optimizer.param_groups[0]['lr'], epoch)

# æŸ¥çœ‹
# tensorboard --logdir runs/
```

#### è®­ç»ƒè¾“å‡ºæ–‡ä»¶

è®­ç»ƒå®Œæˆåï¼Œ`checkpoints/` ç›®å½•ä¸‹ä¼šç”Ÿæˆï¼š

```
checkpoints/
â”œâ”€â”€ best_model.pth       # éªŒè¯Diceæœ€é«˜çš„æ¨¡å‹ â† ç”¨äºéƒ¨ç½²
â”œâ”€â”€ last_model.pth       # æœ€åä¸€è½®çš„æ¨¡å‹æƒé‡
â”œâ”€â”€ checkpoint_epoch10.pth
â”œâ”€â”€ checkpoint_epoch20.pth
â””â”€â”€ ...
```

**åŠ è½½æ¨¡å‹ç”¨äºæ¨ç†ï¼š**

```python
# åŠ è½½æœ€ä½³æ¨¡å‹
model = UNet(in_channels=3, out_channels=1)
checkpoint = torch.load('checkpoints/best_model.pth')
model.load_state_dict(checkpoint['model_state_dict'])
model.eval()

print(f"Loaded model from epoch {checkpoint['epoch']}, Dice: {checkpoint['best_dice']:.4f}")
```

### è®­ç»ƒæŠ€å·§

æœ¬èŠ‚æ€»ç»“åœ¨è®­ç»ƒè½¦é“çº¿æ£€æµ‹æ¨¡å‹è¿‡ç¨‹ä¸­çš„å®ç”¨ç»éªŒå’Œè°ƒå‚æŠ€å·§ã€‚

#### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:---------|:---------|:---------|
| è®­ç»ƒLossä¸ä¸‹é™ | å­¦ä¹ ç‡å¤ªå¤§/å¤ªå° | å°è¯• 1e-5 ~ 1e-3 èŒƒå›´ |
| éªŒè¯Losséœ‡è¡ | æ‰¹é‡å¤§å°å¤ªå° | å¢å¤§batch_sizeæˆ–ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯ |
| è¿‡æ‹Ÿåˆ (è®­ç»ƒå¥½éªŒè¯å·®) | æ•°æ®é‡ä¸è¶³/å¢å¼ºä¸å¤Ÿ | å¢åŠ æ•°æ®å¢å¼ºå¼ºåº¦ |
| æ¬ æ‹Ÿåˆ (éƒ½å¾ˆå·®) | æ¨¡å‹å®¹é‡ä¸è¶³ | å¢åŠ ç‰¹å¾é€šé“æ•° |
| è¾¹ç¼˜æ¨¡ç³Š | Diceæƒé‡è¿‡é«˜ | å¢å¤§BCEæƒé‡æ¯”ä¾‹ |
| å°ç›®æ ‡ä¸¢å¤± | ä¸‹é‡‡æ ·è¿‡å¤š | ä½¿ç”¨æ›´å¤§è¾“å…¥å°ºå¯¸ |

---

#### æŠ€å·§1ï¼šå­¦ä¹ ç‡è°ƒä¼˜

å­¦ä¹ ç‡æ˜¯æœ€é‡è¦çš„è¶…å‚æ•°ï¼Œè°ƒæ•´å¾—å½“å¯ä»¥æ˜¾è‘—æå‡æ”¶æ•›é€Ÿåº¦å’Œæœ€ç»ˆæ•ˆæœã€‚

**å­¦ä¹ ç‡èŒƒå›´æµ‹è¯• (LR Range Test)**

```python
# lr_finder.py - å­¦ä¹ ç‡èŒƒå›´æµ‹è¯•
def find_lr(model, train_loader, criterion, optimizer, 
            init_lr=1e-8, final_lr=10, num_iter=100):
    """
    é€šè¿‡é€æ­¥å¢å¤§å­¦ä¹ ç‡ï¼Œæ‰¾åˆ°æœ€ä½³å­¦ä¹ ç‡èŒƒå›´
    """
    lrs = []
    losses = []
    lr = init_lr
    mult = (final_lr / init_lr) ** (1 / num_iter)
    
    model.train()
    for i, (images, masks) in enumerate(train_loader):
        if i >= num_iter:
            break
        
        # è®¾ç½®å­¦ä¹ ç‡
        for param_group in optimizer.param_groups:
            param_group['lr'] = lr
        
        # å‰å‘ä¼ æ’­
        images, masks = images.cuda(), masks.cuda()
        outputs = model(images)
        loss = criterion(outputs, masks)[0]
        
        # è®°å½•
        lrs.append(lr)
        losses.append(loss.item())
        
        # åå‘ä¼ æ’­
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
        
        lr *= mult
    
    # ç»˜å›¾
    import matplotlib.pyplot as plt
    plt.figure(figsize=(10, 6))
    plt.semilogx(lrs, losses)
    plt.xlabel('Learning Rate')
    plt.ylabel('Loss')
    plt.title('LR Range Test')
    plt.savefig('lr_range_test.png')
    plt.show()
    
    # æ¨èå­¦ä¹ ç‡ï¼šlossä¸‹é™æœ€å¿«å¤„çš„1/10
    min_loss_idx = losses.index(min(losses))
    recommended_lr = lrs[min_loss_idx] / 10
    print(f"Recommended LR: {recommended_lr:.2e}")
    return recommended_lr
```

**ç»“æœè§£è¯»**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å­¦ä¹ ç‡èŒƒå›´æµ‹è¯•ç»“æœç¤ºæ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚
â”‚  Loss                                                      â”‚
â”‚   â”‚                                                        â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚   â”‚          â•²                                             â”‚
â”‚   â”‚           â•²  â† é€‰æ‹©è¿™é‡Œï¼šä¸‹é™æœ€é™¡çš„ç‚¹ /10              â”‚
â”‚   â”‚            â•²                                           â”‚
â”‚   â”‚             â”€â”€â”€â”€                                       â”‚
â”‚   â”‚                 â•²                                      â”‚
â”‚   â”‚                  â•²_____/  â† å¼€å§‹å‘æ•£                   â”‚
â”‚   â”‚                                                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Learning Rateâ”‚
â”‚     1e-7   1e-5   1e-4   1e-3   1e-2   1e-1               â”‚
â”‚                     â†‘                                      â”‚
â”‚              æ¨èå­¦ä¹ ç‡åŒºé—´                                 â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### æŠ€å·§2ï¼šæ•°æ®å¢å¼ºç­–ç•¥

é’ˆå¯¹è½¦é“çº¿æ£€æµ‹çš„ç‰¹ç‚¹ï¼Œé‡ç‚¹å¢å¼º**é¢œè‰²/å…‰ç…§å˜åŒ–**ï¼š

```python
# é’ˆå¯¹ç™½å¹³è¡¡é—®é¢˜çš„å¢å¼ºç­–ç•¥ï¼ˆå…³é”®ï¼ï¼‰
augmentation_strategy = {
    # ä¼˜å…ˆçº§æœ€é«˜ï¼šé¢œè‰²å˜æ¢ï¼ˆè§£å†³ç™½å¹³è¡¡é—®é¢˜ï¼‰
    'HueSaturationValue': {
        'hue_shift_limit': 30,      # è‰²è°ƒåç§» â† æ¨¡æ‹Ÿç™½å¹³è¡¡æ¼‚ç§»
        'sat_shift_limit': 30,
        'val_shift_limit': 30,
        'p': 0.8                    # é«˜æ¦‚ç‡åº”ç”¨
    },
    
    # ä¼˜å…ˆçº§é«˜ï¼šäº®åº¦å¯¹æ¯”åº¦
    'RandomBrightnessContrast': {
        'brightness_limit': 0.4,
        'contrast_limit': 0.4,
        'p': 0.7
    },
    
    # ä¸­ç­‰ä¼˜å…ˆçº§ï¼šå‡ ä½•å˜æ¢
    'HorizontalFlip': {'p': 0.5},
    'Rotate': {'limit': 15, 'p': 0.5},
    
    # ä½ä¼˜å…ˆçº§ï¼šå™ªå£°æ¨¡ç³Š
    'GaussianBlur': {'blur_limit': 7, 'p': 0.3},
    'GaussNoise': {'var_limit': 50, 'p': 0.2},
}
```

**å¢å¼ºæ•ˆæœéªŒè¯**ï¼š

```python
# å¯è§†åŒ–å¢å¼ºæ•ˆæœ
import albumentations as A
import matplotlib.pyplot as plt

transform = A.Compose([
    A.HueSaturationValue(hue_shift_limit=30, sat_shift_limit=30, val_shift_limit=30, p=1.0),
])

# å±•ç¤ºåŒä¸€å¼ å›¾åƒçš„å¤šæ¬¡å¢å¼ºç»“æœ
fig, axes = plt.subplots(2, 5, figsize=(15, 6))
for i in range(10):
    augmented = transform(image=original_image)['image']
    axes[i//5, i%5].imshow(augmented)
    axes[i//5, i%5].axis('off')
plt.suptitle('HueSaturationValue Augmentation (æ¨¡æ‹Ÿç™½å¹³è¡¡åç§»)')
plt.savefig('augmentation_demo.png')
```

---

#### æŠ€å·§3ï¼šå¤„ç†ç±»åˆ«ä¸å¹³è¡¡

è½¦é“çº¿é€šå¸¸åªå å›¾åƒçš„ 5-15%ï¼Œç±»åˆ«ä¸¥é‡ä¸å¹³è¡¡ã€‚

**æ–¹æ³•1ï¼šæ­£æ ·æœ¬åŠ æƒ**

```python
# è®¡ç®—æ­£æ ·æœ¬æƒé‡
def calculate_pos_weight(mask_dir):
    """æ ¹æ®æ•°æ®é›†è®¡ç®—æ­£æ ·æœ¬æƒé‡"""
    total_pixels = 0
    positive_pixels = 0
    
    for mask_file in os.listdir(mask_dir):
        mask = cv2.imread(os.path.join(mask_dir, mask_file), 0)
        total_pixels += mask.size
        positive_pixels += (mask > 127).sum()
    
    pos_ratio = positive_pixels / total_pixels
    neg_ratio = 1 - pos_ratio
    pos_weight = neg_ratio / pos_ratio  # è´Ÿ/æ­£ æ¯”ä¾‹
    
    print(f"Positive ratio: {pos_ratio:.2%}")
    print(f"Recommended pos_weight: {pos_weight:.2f}")
    return pos_weight

# ä½¿ç”¨
pos_weight = calculate_pos_weight('dataset/masks/train')
# è¾“å‡º: Positive ratio: 8.5%, Recommended pos_weight: 10.76
# å®é™…ä½¿ç”¨æ—¶å¯é€‚å½“é™ä½ï¼Œå¦‚ pos_weight=3~5
```

**æ–¹æ³•2ï¼šé‡‡æ ·ç­–ç•¥**

```python
# è¿‡é‡‡æ ·å«æœ‰è½¦é“çº¿çš„å›¾åƒ
from torch.utils.data import WeightedRandomSampler

def get_sample_weights(dataset):
    """è®¡ç®—æ¯ä¸ªæ ·æœ¬çš„é‡‡æ ·æƒé‡"""
    weights = []
    for idx in range(len(dataset)):
        _, mask = dataset[idx]
        lane_ratio = mask.mean().item()
        # è½¦é“çº¿æ¯”ä¾‹è¶Šé«˜ï¼Œæƒé‡è¶Šå¤§
        weight = 1.0 + lane_ratio * 5
        weights.append(weight)
    return weights

weights = get_sample_weights(train_dataset)
sampler = WeightedRandomSampler(weights, len(weights), replacement=True)
train_loader = DataLoader(train_dataset, batch_size=8, sampler=sampler)
```

---

#### æŠ€å·§4ï¼šæ¸è¿›å¼è®­ç»ƒ

ä»ç®€å•åˆ°å¤æ‚ï¼Œé€æ­¥æå‡éš¾åº¦ï¼š

```python
# é˜¶æ®µ1ï¼šå°åˆ†è¾¨ç‡å¿«é€Ÿæ”¶æ•›
config_stage1 = {
    'image_size': 128,
    'epochs': 30,
    'learning_rate': 1e-3,
}

# é˜¶æ®µ2ï¼šä¸­ç­‰åˆ†è¾¨ç‡ç²¾è°ƒ
config_stage2 = {
    'image_size': 192,
    'epochs': 30,
    'learning_rate': 1e-4,
    'pretrained': 'stage1_best.pth',
}

# é˜¶æ®µ3ï¼šç›®æ ‡åˆ†è¾¨ç‡å¾®è°ƒ
config_stage3 = {
    'image_size': 224,
    'epochs': 20,
    'learning_rate': 1e-5,
    'pretrained': 'stage2_best.pth',
}
```

---

#### æŠ€å·§5ï¼šæ··åˆç²¾åº¦è®­ç»ƒ

ä½¿ç”¨ FP16 åŠ é€Ÿè®­ç»ƒï¼ŒèŠ‚çœæ˜¾å­˜ï¼š

```python
from torch.cuda.amp import autocast, GradScaler

scaler = GradScaler()

for images, masks in train_loader:
    optimizer.zero_grad()
    
    # æ··åˆç²¾åº¦å‰å‘ä¼ æ’­
    with autocast():
        outputs = model(images.cuda())
        loss = criterion(outputs, masks.cuda())[0]
    
    # ç¼©æ”¾æ¢¯åº¦å¹¶åå‘ä¼ æ’­
    scaler.scale(loss).backward()
    scaler.step(optimizer)
    scaler.update()
```

**æ•ˆæœ**ï¼š
- è®­ç»ƒé€Ÿåº¦æå‡ **30-50%**
- æ˜¾å­˜å ç”¨å‡å°‘ **30-40%**
- ç²¾åº¦å‡ ä¹æ— æŸå¤±

---

#### æŠ€å·§6ï¼šæ¨¡å‹é›†æˆï¼ˆå¯é€‰ï¼‰

è®­ç»ƒå¤šä¸ªæ¨¡å‹è¿›è¡Œé›†æˆï¼Œæå‡é²æ£’æ€§ï¼š

```python
# è®­ç»ƒæ—¶ä¿å­˜å¤šä¸ªcheckpoint
checkpoints = [
    'best_model.pth',      # æœ€ä½³Dice
    'epoch_80.pth',        # è®­ç»ƒä¸­æœŸ
    'epoch_100.pth',       # æœ€åä¸€è½®
]

# æ¨ç†æ—¶é›†æˆ
def ensemble_predict(models, image):
    """å¤šæ¨¡å‹é›†æˆé¢„æµ‹"""
    predictions = []
    for model in models:
        with torch.no_grad():
            pred = torch.sigmoid(model(image))
            predictions.append(pred)
    
    # å¹³å‡é›†æˆ
    ensemble_pred = torch.stack(predictions).mean(dim=0)
    return ensemble_pred > 0.5
```

---

#### è®­ç»ƒæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹æ­£å¼è®­ç»ƒå‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹äº‹é¡¹ï¼š

```
â–¡ æ•°æ®é›†
  â”œâ”€ â–¡ å›¾åƒå’Œæ©ç æ•°é‡ä¸€è‡´
  â”œâ”€ â–¡ æ©ç å€¼æ­£ç¡® (0å’Œ255æˆ–0å’Œ1)
  â”œâ”€ â–¡ è®­ç»ƒ/éªŒè¯é›†åˆ’åˆ†åˆç† (çº¦8:2)
  â””â”€ â–¡ è¦†ç›–å¤šç§å…‰ç…§å’Œç™½å¹³è¡¡æ¡ä»¶

â–¡ æ¨¡å‹
  â”œâ”€ â–¡ è¾“å…¥è¾“å‡ºå°ºå¯¸æ­£ç¡®
  â””â”€ â–¡ å‚æ•°é‡åœ¨å¯æ¥å—èŒƒå›´

â–¡ è®­ç»ƒé…ç½®
  â”œâ”€ â–¡ å­¦ä¹ ç‡åˆç† (é€šå¸¸1e-4)
  â”œâ”€ â–¡ æ‰¹é‡å¤§å°é€‚åˆæ˜¾å­˜
  â”œâ”€ â–¡ æ•°æ®å¢å¼ºåŒ…å«é¢œè‰²å˜æ¢
  â””â”€ â–¡ æ—©åœå’Œæ¨¡å‹ä¿å­˜å·²é…ç½®

â–¡ ç¡¬ä»¶
  â”œâ”€ â–¡ GPUå¯ç”¨ä¸”æ˜¾å­˜å……è¶³
  â””â”€ â–¡ ç£ç›˜ç©ºé—´è¶³å¤Ÿä¿å­˜checkpoint

â–¡ ç›‘æ§
  â”œâ”€ â–¡ TensorBoardæˆ–æ—¥å¿—å·²é…ç½®
  â””â”€ â–¡ éªŒè¯æŒ‡æ ‡(Dice/IoU)æœ‰è®°å½•
```

> ğŸ’¡ **ç»éªŒæ€»ç»“**ï¼š80%çš„é—®é¢˜æ¥è‡ªæ•°æ®ï¼Œ15%æ¥è‡ªå­¦ä¹ ç‡ï¼Œåªæœ‰5%éœ€è¦è°ƒæ•´æ¨¡å‹ç»“æ„ã€‚å…ˆæ£€æŸ¥æ•°æ®ï¼Œå†è°ƒå­¦ä¹ ç‡ï¼

## æ¨¡å‹éƒ¨ç½²

### æ¨¡å‹è½¬æ¢æµç¨‹

å°†è®­ç»ƒå¥½çš„ PyTorch æ¨¡å‹éƒ¨ç½²åˆ° RK3588 NPUï¼Œéœ€è¦ç»è¿‡ **PyTorch â†’ ONNX â†’ RKNN** çš„è½¬æ¢æµç¨‹ã€‚

#### è½¬æ¢æµç¨‹æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¨¡å‹è½¬æ¢éƒ¨ç½²æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PyTorch   â”‚    â”‚   ONNX    â”‚    â”‚   RKNN    â”‚    â”‚   RK3588 NPU     â”‚  â”‚
â”‚  â”‚ æ¨¡å‹      â”‚ â†’  â”‚   æ¨¡å‹    â”‚ â†’  â”‚   æ¨¡å‹    â”‚ â†’  â”‚   æ¨ç†           â”‚  â”‚
â”‚  â”‚ (.pth)    â”‚    â”‚  (.onnx)  â”‚    â”‚  (.rknn)  â”‚    â”‚                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                â”‚                â”‚                    â”‚             â”‚
â”‚       â†“                â†“                â†“                    â†“             â”‚
â”‚   FP32æƒé‡        æ ‡å‡†äº¤æ¢æ ¼å¼      INT8é‡åŒ–æ¨¡å‹        6 TOPSåŠ é€Ÿ        â”‚
â”‚   ~120MB           ~120MB            ~30MB             30+ FPS           â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                             â”‚
â”‚  è½¬æ¢ç¯å¢ƒ:         è½¬æ¢ç¯å¢ƒ:           è¿è¡Œç¯å¢ƒ:                            â”‚
â”‚  - PyTorch        - RKNN-Toolkit2     - RKNN Runtime (rknnlite)           â”‚
â”‚  - è®­ç»ƒæœåŠ¡å™¨      - x86 Linux/Win     - RK3588 å¼€å‘æ¿                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç¯å¢ƒå‡†å¤‡

**1. è½¬æ¢ç¯å¢ƒï¼ˆx86ä¸»æœºï¼‰**

```bash
# åˆ›å»ºè½¬æ¢ä¸“ç”¨ç¯å¢ƒ
conda create -n rknn python=3.8
conda activate rknn

# å®‰è£… PyTorchï¼ˆç”¨äºåŠ è½½æ¨¡å‹ï¼‰
pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

# å®‰è£… ONNX
pip install onnx onnxruntime onnx-simplifier

# å®‰è£… RKNN-Toolkit2ï¼ˆä»Rockchipå®˜æ–¹è·å–ï¼‰
# ä¸‹è½½åœ°å€: https://github.com/rockchip-linux/rknn-toolkit2
pip install rknn_toolkit2-1.5.0+xxx-cp38-cp38-linux_x86_64.whl
```

**2. è¿è¡Œç¯å¢ƒï¼ˆRK3588å¼€å‘æ¿ï¼‰**

```bash
# RKNN Runtime é€šå¸¸å·²é¢„è£…åœ¨Rockchipå®˜æ–¹å›ºä»¶ä¸­
# éªŒè¯å®‰è£…
python3 -c "from rknnlite.api import RKNNLite; print('RKNN Runtime OK')"
```

#### è½¬æ¢æµç¨‹è¯¦è§£

| æ­¥éª¤ | è¾“å…¥ | è¾“å‡º | å·¥å…· | è¯´æ˜ |
|:---:|:----:|:----:|:----:|:-----|
| **1** | best_model.pth | lane_unet.onnx | torch.onnx.export | å¯¼å‡ºæ ‡å‡†ONNXæ ¼å¼ |
| **2** | lane_unet.onnx | lane_unet_sim.onnx | onnx-simplifier | ä¼˜åŒ–ONNXå›¾ç»“æ„ |
| **3** | lane_unet_sim.onnx | lane_unet.rknn | RKNN-Toolkit2 | è½¬æ¢+INT8é‡åŒ– |
| **4** | lane_unet.rknn | - | RK3588 | æ¿ä¸Šæ¨ç†éªŒè¯ |

#### æ–‡ä»¶å¤¹ç»“æ„

```
model_convert/
â”œâ”€â”€ pytorch_model/
â”‚   â””â”€â”€ best_model.pth          # åŸå§‹PyTorchæ¨¡å‹
â”‚
â”œâ”€â”€ onnx_model/
â”‚   â”œâ”€â”€ lane_unet.onnx          # å¯¼å‡ºçš„ONNXæ¨¡å‹
â”‚   â””â”€â”€ lane_unet_sim.onnx      # ç®€åŒ–åçš„ONNXæ¨¡å‹
â”‚
â”œâ”€â”€ rknn_model/
â”‚   â””â”€â”€ lane_unet.rknn          # æœ€ç»ˆRKNNæ¨¡å‹ â† éƒ¨ç½²ç”¨
â”‚
â”œâ”€â”€ calibration_data/           # INT8é‡åŒ–æ ¡å‡†æ•°æ®
â”‚   â”œâ”€â”€ calib_0001.jpg
â”‚   â”œâ”€â”€ calib_0002.jpg
â”‚   â””â”€â”€ ... (50-100å¼ )
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ export_onnx.py          # å¯¼å‡ºONNXè„šæœ¬
â”‚   â”œâ”€â”€ convert_rknn.py         # è½¬æ¢RKNNè„šæœ¬
â”‚   â””â”€â”€ test_rknn.py            # éªŒè¯è„šæœ¬
â”‚
â””â”€â”€ requirements.txt
```

#### æ³¨æ„äº‹é¡¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è½¬æ¢è¿‡ç¨‹ä¸­çš„å¸¸è§å‘                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. ç®—å­å…¼å®¹æ€§                                               â”‚
â”‚     â”œâ”€ RKNNä¸æ”¯æŒæ‰€æœ‰ONNXç®—å­                               â”‚
â”‚     â”œâ”€ å¸¸è§é—®é¢˜ï¼šUpsample(mode='bilinear') â†’ ç”¨nearestæ›¿ä»£  â”‚
â”‚     â””â”€ å»ºè®®ï¼šç”¨ ConvTranspose2d æ›¿ä»£ Upsample               â”‚
â”‚                                                             â”‚
â”‚  2. è¾“å…¥æ ¼å¼                                                 â”‚
â”‚     â”œâ”€ PyTorch: NCHW (Batch, Channel, Height, Width)        â”‚
â”‚     â”œâ”€ RKNN: NHWC (Batch, Height, Width, Channel)           â”‚
â”‚     â””â”€ è½¬æ¢æ—¶éœ€æŒ‡å®š reorder_channel='0 1 2'                 â”‚
â”‚                                                             â”‚
â”‚  3. é‡åŒ–ç²¾åº¦                                                 â”‚
â”‚     â”œâ”€ INT8é‡åŒ–å¯èƒ½å¯¼è‡´ç²¾åº¦ä¸‹é™                              â”‚
â”‚     â”œâ”€ æ ¡å‡†æ•°æ®è¦æœ‰ä»£è¡¨æ€§ï¼ˆè¦†ç›–å„ç§åœºæ™¯ï¼‰                   â”‚
â”‚     â””â”€ éªŒè¯é‡åŒ–åæ¨¡å‹è¾“å‡ºæ˜¯å¦æ­£å¸¸                           â”‚
â”‚                                                             â”‚
â”‚  4. åŠ¨æ€å°ºå¯¸                                                 â”‚
â”‚     â”œâ”€ RKNNä¸æ”¯æŒåŠ¨æ€è¾“å…¥å°ºå¯¸                               â”‚
â”‚     â””â”€ å¯¼å‡ºONNXæ—¶å¿…é¡»å›ºå®šè¾“å…¥shape                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸€é”®è½¬æ¢è„šæœ¬

```bash
# convert_all.sh - å®Œæ•´è½¬æ¢æµç¨‹

#!/bin/bash
set -e

echo "Step 1: Export ONNX..."
python scripts/export_onnx.py \
    --weights pytorch_model/best_model.pth \
    --output onnx_model/lane_unet.onnx \
    --input_size 224

echo "Step 2: Simplify ONNX..."
python -m onnxsim \
    onnx_model/lane_unet.onnx \
    onnx_model/lane_unet_sim.onnx

echo "Step 3: Convert to RKNN..."
python scripts/convert_rknn.py \
    --onnx onnx_model/lane_unet_sim.onnx \
    --output rknn_model/lane_unet.rknn \
    --calibration calibration_data/

echo "Step 4: Verify RKNN..."
python scripts/test_rknn.py \
    --model rknn_model/lane_unet.rknn \
    --image test_images/test.jpg

echo "Done! Model saved to rknn_model/lane_unet.rknn"
```

### ONNXå¯¼å‡º

å°† PyTorch æ¨¡å‹å¯¼å‡ºä¸º ONNX æ ¼å¼ï¼Œè¿™æ˜¯è½¬æ¢åˆ° RKNN çš„å¿…è¦ä¸­é—´æ­¥éª¤ã€‚

#### å¯¼å‡ºè„šæœ¬

```python
# export_onnx.py - PyTorchæ¨¡å‹å¯¼å‡ºONNX

import torch
import torch.nn as nn
import argparse
import os

# å¯¼å…¥U-Netæ¨¡å‹å®šä¹‰ï¼ˆä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
from model import UNet  # ç¡®ä¿æ¨¡å‹å®šä¹‰å¯å¯¼å…¥


def export_onnx(weights_path, output_path, input_size=224, opset_version=12):
    """
    å¯¼å‡ºPyTorchæ¨¡å‹ä¸ºONNXæ ¼å¼
    
    Args:
        weights_path: PyTorchæƒé‡æ–‡ä»¶è·¯å¾„ (.pth)
        output_path: è¾“å‡ºONNXæ–‡ä»¶è·¯å¾„ (.onnx)
        input_size: è¾“å…¥å›¾åƒå°ºå¯¸ (æ­£æ–¹å½¢)
        opset_version: ONNX opsetç‰ˆæœ¬ (æ¨è11-13)
    """
    
    print(f"Loading PyTorch model from: {weights_path}")
    
    # 1. åˆ›å»ºæ¨¡å‹å¹¶åŠ è½½æƒé‡
    model = UNet(in_channels=3, out_channels=1)
    
    # åŠ è½½æƒé‡ï¼ˆå…¼å®¹ä¸åŒä¿å­˜æ ¼å¼ï¼‰
    checkpoint = torch.load(weights_path, map_location='cpu')
    if 'model_state_dict' in checkpoint:
        model.load_state_dict(checkpoint['model_state_dict'])
    else:
        model.load_state_dict(checkpoint)
    
    model.eval()
    print(f"Model loaded successfully")
    
    # 2. åˆ›å»ºç¤ºä¾‹è¾“å…¥
    # æ³¨æ„ï¼šRKNNä¸æ”¯æŒåŠ¨æ€å°ºå¯¸ï¼Œå¿…é¡»å›ºå®šè¾“å…¥shape
    dummy_input = torch.randn(1, 3, input_size, input_size)
    print(f"Input shape: {dummy_input.shape}")
    
    # 3. å¯¼å‡ºONNX
    print(f"Exporting to ONNX (opset={opset_version})...")
    
    torch.onnx.export(
        model,                          # æ¨¡å‹
        dummy_input,                    # ç¤ºä¾‹è¾“å…¥
        output_path,                    # è¾“å‡ºè·¯å¾„
        export_params=True,             # å¯¼å‡ºæƒé‡
        opset_version=opset_version,    # ONNX opsetç‰ˆæœ¬
        do_constant_folding=True,       # å¸¸é‡æŠ˜å ä¼˜åŒ–
        input_names=['input'],          # è¾“å…¥åç§°
        output_names=['output'],        # è¾“å‡ºåç§°
        # ä¸ä½¿ç”¨dynamic_axesï¼Œå›ºå®šå°ºå¯¸
    )
    
    print(f"ONNX model saved to: {output_path}")
    
    # 4. éªŒè¯ONNXæ¨¡å‹
    import onnx
    onnx_model = onnx.load(output_path)
    onnx.checker.check_model(onnx_model)
    print("ONNX model validation passed!")
    
    # 5. æ‰“å°æ¨¡å‹ä¿¡æ¯
    print(f"\n=== Model Info ===")
    print(f"Input:  {onnx_model.graph.input[0].name}, shape: [1, 3, {input_size}, {input_size}]")
    print(f"Output: {onnx_model.graph.output[0].name}, shape: [1, 1, {input_size}, {input_size}]")
    
    return output_path


def simplify_onnx(input_path, output_path=None):
    """
    ä½¿ç”¨onnx-simplifierç®€åŒ–ONNXæ¨¡å‹
    æ¶ˆé™¤å†—ä½™ç®—å­ï¼Œä¼˜åŒ–å›¾ç»“æ„
    """
    import onnx
    from onnxsim import simplify
    
    if output_path is None:
        output_path = input_path.replace('.onnx', '_sim.onnx')
    
    print(f"Simplifying ONNX model...")
    
    # åŠ è½½æ¨¡å‹
    model = onnx.load(input_path)
    
    # ç®€åŒ–
    model_sim, check = simplify(model)
    
    if check:
        onnx.save(model_sim, output_path)
        print(f"Simplified model saved to: {output_path}")
    else:
        print("Warning: Simplification failed, using original model")
        output_path = input_path
    
    return output_path


def verify_onnx(onnx_path, test_image_path=None):
    """
    éªŒè¯ONNXæ¨¡å‹æ¨ç†ç»“æœ
    """
    import onnxruntime as ort
    import numpy as np
    import cv2
    
    print(f"\nVerifying ONNX model...")
    
    # åˆ›å»ºæ¨ç†ä¼šè¯
    session = ort.InferenceSession(onnx_path)
    
    # è·å–è¾“å…¥ä¿¡æ¯
    input_info = session.get_inputs()[0]
    input_shape = input_info.shape
    print(f"Input: {input_info.name}, shape: {input_shape}")
    
    # å‡†å¤‡æµ‹è¯•æ•°æ®
    if test_image_path and os.path.exists(test_image_path):
        image = cv2.imread(test_image_path)
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
        image = cv2.resize(image, (input_shape[3], input_shape[2]))
        image = image.astype(np.float32) / 255.0
        image = np.transpose(image, (2, 0, 1))  # HWC â†’ CHW
        image = np.expand_dims(image, axis=0)   # æ·»åŠ batchç»´åº¦
    else:
        image = np.random.randn(*input_shape).astype(np.float32)
    
    # æ¨ç†
    outputs = session.run(None, {input_info.name: image})
    
    print(f"Output shape: {outputs[0].shape}")
    print(f"Output range: [{outputs[0].min():.4f}, {outputs[0].max():.4f}]")
    print("ONNX verification passed!")
    
    return outputs[0]


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Export PyTorch to ONNX')
    parser.add_argument('--weights', type=str, required=True, help='PyTorch weights path')
    parser.add_argument('--output', type=str, default='model.onnx', help='Output ONNX path')
    parser.add_argument('--input_size', type=int, default=224, help='Input image size')
    parser.add_argument('--simplify', action='store_true', help='Simplify ONNX model')
    parser.add_argument('--test_image', type=str, default=None, help='Test image for verification')
    args = parser.parse_args()
    
    # å¯¼å‡ºONNX
    onnx_path = export_onnx(args.weights, args.output, args.input_size)
    
    # ç®€åŒ–ï¼ˆå¯é€‰ï¼‰
    if args.simplify:
        onnx_path = simplify_onnx(onnx_path)
    
    # éªŒè¯
    verify_onnx(onnx_path, args.test_image)
```

#### ä½¿ç”¨æ–¹æ³•

```bash
# åŸºæœ¬å¯¼å‡º
python export_onnx.py --weights best_model.pth --output lane_unet.onnx

# å¯¼å‡ºå¹¶ç®€åŒ–
python export_onnx.py --weights best_model.pth --output lane_unet.onnx --simplify

# å¯¼å‡ºå¹¶éªŒè¯
python export_onnx.py --weights best_model.pth --output lane_unet.onnx \
    --simplify --test_image test.jpg
```

#### å¯¼å‡ºæ³¨æ„äº‹é¡¹

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:-----|:-----|:---------|
| Upsampleä¸æ”¯æŒ | RKNNå¯¹bilinearæ”¯æŒæœ‰é™ | ä½¿ç”¨`mode='nearest'`æˆ–`ConvTranspose2d` |
| åŠ¨æ€shapeæŠ¥é”™ | RKNNä¸æ”¯æŒåŠ¨æ€å°ºå¯¸ | å¯¼å‡ºæ—¶ä¸è®¾ç½®`dynamic_axes` |
| ç®—å­ä¸æ”¯æŒ | ä½¿ç”¨äº†ç‰¹æ®Šç®—å­ | é‡å†™ä¸ºåŸºç¡€ç®—å­ç»„åˆ |
| ç²¾åº¦å·®å¼‚ | FP32â†’FP16è½¬æ¢ | éªŒè¯è¾“å‡ºèŒƒå›´æ˜¯å¦æ­£å¸¸ |

### RKNNè½¬æ¢

å°†ç®€åŒ–åçš„ ONNX æ¨¡å‹è½¬æ¢ä¸º RKNN æ ¼å¼ï¼Œå¹¶è¿›è¡Œ INT8 é‡åŒ–ä»¥å……åˆ†åˆ©ç”¨ NPU åŠ é€Ÿã€‚

#### è½¬æ¢è„šæœ¬

```python
# convert_rknn.py - ONNXè½¬RKNNï¼ˆå«INT8é‡åŒ–ï¼‰

import os
import numpy as np
import cv2
from rknn.api import RKNN
import argparse


def prepare_calibration_data(calibration_dir, input_size=224, num_samples=100):
    """
    å‡†å¤‡INT8é‡åŒ–æ ¡å‡†æ•°æ®
    
    æ ¡å‡†æ•°æ®è¦æ±‚ï¼š
    1. æ•°é‡ï¼š50-200å¼ ï¼ˆæ¨è100å¼ ï¼‰
    2. è¦†ç›–ï¼šåŒ…å«å„ç§å…‰ç…§ã€ç™½å¹³è¡¡åœºæ™¯
    3. æ ¼å¼ï¼šä¸å®é™…æ¨ç†è¾“å…¥ä¸€è‡´
    """
    calibration_data = []
    
    image_files = sorted([f for f in os.listdir(calibration_dir) 
                          if f.endswith(('.jpg', '.png'))])[:num_samples]
    
    print(f"Preparing {len(image_files)} calibration images...")
    
    for img_file in image_files:
        img_path = os.path.join(calibration_dir, img_file)
        
        # è¯»å–å¹¶é¢„å¤„ç†ï¼ˆä¸æ¨ç†æ—¶ä¸€è‡´ï¼‰
        image = cv2.imread(img_path)
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
        image = cv2.resize(image, (input_size, input_size))
        
        # æ³¨æ„ï¼šRKNNçš„è¾“å…¥é€šå¸¸æ˜¯uint8ï¼Œä¸éœ€è¦å½’ä¸€åŒ–
        # å½’ä¸€åŒ–åœ¨RKNNå†…éƒ¨é€šè¿‡mean/stdé…ç½®å®Œæˆ
        calibration_data.append(image)
    
    return calibration_data


def convert_onnx_to_rknn(onnx_path, rknn_output_path, calibration_dir,
                         target_platform='rk3588', quantize=True, input_size=224):
    """
    ONNXæ¨¡å‹è½¬æ¢ä¸ºRKNNæ ¼å¼
    
    Args:
        onnx_path: è¾“å…¥ONNXæ¨¡å‹è·¯å¾„
        rknn_output_path: è¾“å‡ºRKNNæ¨¡å‹è·¯å¾„
        calibration_dir: INT8é‡åŒ–æ ¡å‡†æ•°æ®ç›®å½•
        target_platform: ç›®æ ‡å¹³å° (rk3588/rk3566/rk3568)
        quantize: æ˜¯å¦è¿›è¡ŒINT8é‡åŒ–
        input_size: è¾“å…¥å›¾åƒå°ºå¯¸
    """
    
    # åˆ›å»ºRKNNå¯¹è±¡
    rknn = RKNN(verbose=True)
    
    print("=" * 60)
    print(f"ONNX to RKNN Conversion")
    print(f"  Input:  {onnx_path}")
    print(f"  Output: {rknn_output_path}")
    print(f"  Target: {target_platform}")
    print(f"  Quantize: {quantize}")
    print("=" * 60)
    
    # ===================== 1. é…ç½®æ¨¡å‹ =====================
    print("\n[1/5] Configuring model...")
    
    rknn.config(
        # å½’ä¸€åŒ–å‚æ•°ï¼ˆä¸è®­ç»ƒæ—¶ä¸€è‡´ï¼‰
        # ImageNeté¢„è®­ç»ƒçš„æ ‡å‡†åŒ–å‚æ•°
        mean_values=[[123.675, 116.28, 103.53]],  # RGBå‡å€¼ * 255
        std_values=[[58.395, 57.12, 57.375]],     # RGBæ ‡å‡†å·® * 255
        
        # é‡åŒ–é…ç½®
        quantized_dtype='asymmetric_quantized-8',  # INT8éå¯¹ç§°é‡åŒ–
        quantized_algorithm='normal',               # é‡åŒ–ç®—æ³•
        quantized_method='channel',                 # é€é€šé“é‡åŒ–
        
        # ç›®æ ‡å¹³å°
        target_platform=target_platform,
        
        # ä¼˜åŒ–é€‰é¡¹
        optimization_level=3,                       # ä¼˜åŒ–çº§åˆ« (0-3)
        
        # è¾“å‡ºé…ç½®
        output_optimize=1,                          # è¾“å‡ºä¼˜åŒ–
        single_core_mode=False,                     # å¤šæ ¸æ¨¡å¼
    )
    
    # ===================== 2. åŠ è½½ONNXæ¨¡å‹ =====================
    print("\n[2/5] Loading ONNX model...")
    
    ret = rknn.load_onnx(
        model=onnx_path,
        inputs=['input'],                           # è¾“å…¥èŠ‚ç‚¹åç§°
        input_size_list=[[1, 3, input_size, input_size]],  # è¾“å…¥å°ºå¯¸ NCHW
        outputs=['output'],                         # è¾“å‡ºèŠ‚ç‚¹åç§°
    )
    
    if ret != 0:
        print(f"Load ONNX failed! Error code: {ret}")
        return None
    
    print("ONNX model loaded successfully")
    
    # ===================== 3. æ„å»ºRKNNæ¨¡å‹ =====================
    print("\n[3/5] Building RKNN model...")
    
    if quantize:
        # å‡†å¤‡æ ¡å‡†æ•°æ®
        calibration_data = prepare_calibration_data(
            calibration_dir, input_size, num_samples=100
        )
        
        # æ„å»ºæ¨¡å‹ï¼ˆå¸¦é‡åŒ–ï¼‰
        ret = rknn.build(
            do_quantization=True,
            dataset=calibration_data,  # æ ¡å‡†æ•°æ®
            rknn_batch_size=1,
        )
    else:
        # æ„å»ºæ¨¡å‹ï¼ˆä¸é‡åŒ–ï¼ŒFP16ï¼‰
        ret = rknn.build(
            do_quantization=False,
            rknn_batch_size=1,
        )
    
    if ret != 0:
        print(f"Build RKNN failed! Error code: {ret}")
        return None
    
    print("RKNN model built successfully")
    
    # ===================== 4. å¯¼å‡ºRKNNæ¨¡å‹ =====================
    print("\n[4/5] Exporting RKNN model...")
    
    ret = rknn.export_rknn(rknn_output_path)
    
    if ret != 0:
        print(f"Export RKNN failed! Error code: {ret}")
        return None
    
    print(f"RKNN model exported to: {rknn_output_path}")
    
    # ===================== 5. éªŒè¯ï¼ˆå¯é€‰ï¼‰=====================
    print("\n[5/5] Model info...")
    
    # è·å–SDKç‰ˆæœ¬
    sdk_version = rknn.get_sdk_version()
    print(f"RKNN SDK Version: {sdk_version}")
    
    # æ¨¡å‹å¤§å°
    model_size = os.path.getsize(rknn_output_path) / (1024 * 1024)
    print(f"Model size: {model_size:.2f} MB")
    
    # é‡Šæ”¾èµ„æº
    rknn.release()
    
    print("\n" + "=" * 60)
    print("Conversion completed successfully!")
    print("=" * 60)
    
    return rknn_output_path


def test_rknn_on_simulator(rknn_path, test_image_path, input_size=224):
    """
    åœ¨x86æ¨¡æ‹Ÿå™¨ä¸Šæµ‹è¯•RKNNæ¨¡å‹ï¼ˆå¼€å‘è°ƒè¯•ç”¨ï¼‰
    """
    from rknn.api import RKNN
    
    rknn = RKNN()
    
    # åŠ è½½RKNNæ¨¡å‹
    print("Loading RKNN model for simulation...")
    ret = rknn.load_rknn(rknn_path)
    if ret != 0:
        print(f"Load RKNN failed!")
        return
    
    # åˆå§‹åŒ–è¿è¡Œæ—¶ï¼ˆæ¨¡æ‹Ÿå™¨æ¨¡å¼ï¼‰
    ret = rknn.init_runtime(target=None)  # target=None è¡¨ç¤ºä½¿ç”¨æ¨¡æ‹Ÿå™¨
    if ret != 0:
        print(f"Init runtime failed!")
        return
    
    # å‡†å¤‡è¾“å…¥å›¾åƒ
    image = cv2.imread(test_image_path)
    image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
    image = cv2.resize(image, (input_size, input_size))
    
    # æ¨ç†
    outputs = rknn.inference(inputs=[image])
    
    # åå¤„ç†
    output = outputs[0]
    print(f"Output shape: {output.shape}")
    print(f"Output range: [{output.min():.4f}, {output.max():.4f}]")
    
    # å¯è§†åŒ–
    mask = (1 / (1 + np.exp(-output[0, 0])) > 0.5).astype(np.uint8) * 255
    cv2.imwrite('test_output.png', mask)
    print("Test output saved to: test_output.png")
    
    rknn.release()


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Convert ONNX to RKNN')
    parser.add_argument('--onnx', type=str, required=True, help='Input ONNX model path')
    parser.add_argument('--output', type=str, default='model.rknn', help='Output RKNN path')
    parser.add_argument('--calibration', type=str, required=True, help='Calibration data directory')
    parser.add_argument('--platform', type=str, default='rk3588', help='Target platform')
    parser.add_argument('--input_size', type=int, default=224, help='Input size')
    parser.add_argument('--no_quantize', action='store_true', help='Disable INT8 quantization')
    parser.add_argument('--test_image', type=str, default=None, help='Test image for verification')
    
    args = parser.parse_args()
    
    # è½¬æ¢æ¨¡å‹
    rknn_path = convert_onnx_to_rknn(
        onnx_path=args.onnx,
        rknn_output_path=args.output,
        calibration_dir=args.calibration,
        target_platform=args.platform,
        quantize=not args.no_quantize,
        input_size=args.input_size,
    )
    
    # æµ‹è¯•ï¼ˆå¯é€‰ï¼‰
    if rknn_path and args.test_image:
        test_rknn_on_simulator(rknn_path, args.test_image, args.input_size)
```

#### ä½¿ç”¨å‘½ä»¤

```bash
# åŸºæœ¬è½¬æ¢ï¼ˆINT8é‡åŒ–ï¼‰
python convert_rknn.py \
    --onnx lane_unet_sim.onnx \
    --output lane_unet.rknn \
    --calibration ./calibration_data/ \
    --platform rk3588

# ä¸é‡åŒ–ï¼ˆFP16ï¼Œæ¨¡å‹è¾ƒå¤§ä½†ç²¾åº¦æ›´é«˜ï¼‰
python convert_rknn.py \
    --onnx lane_unet_sim.onnx \
    --output lane_unet_fp16.rknn \
    --calibration ./calibration_data/ \
    --no_quantize

# è½¬æ¢å¹¶æµ‹è¯•
python convert_rknn.py \
    --onnx lane_unet_sim.onnx \
    --output lane_unet.rknn \
    --calibration ./calibration_data/ \
    --test_image test.jpg
```

#### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | è¯´æ˜ | æ¨èå€¼ |
|:-----|:-----|:-------|
| `mean_values` | RGBå‡å€¼Ã—255 | `[[123.675, 116.28, 103.53]]` (ImageNet) |
| `std_values` | RGBæ ‡å‡†å·®Ã—255 | `[[58.395, 57.12, 57.375]]` (ImageNet) |
| `quantized_dtype` | é‡åŒ–ç±»å‹ | `asymmetric_quantized-8` (INT8éå¯¹ç§°) |
| `quantized_algorithm` | é‡åŒ–ç®—æ³• | `normal` / `mmse` |
| `target_platform` | ç›®æ ‡å¹³å° | `rk3588` / `rk3566` / `rk3568` |
| `optimization_level` | ä¼˜åŒ–çº§åˆ« | `3` (æœ€é«˜ä¼˜åŒ–) |

#### æ ¡å‡†æ•°æ®å‡†å¤‡è¦ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  INT8é‡åŒ–æ ¡å‡†æ•°æ®è¦æ±‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  æ•°é‡è¦æ±‚:                                                   â”‚
â”‚    â€¢ æ¨è: 50-200å¼                                          â”‚
â”‚    â€¢ æœ€å°‘: 20å¼                                              â”‚
â”‚    â€¢ è¿‡å¤šåè€Œä¼šå¢åŠ è½¬æ¢æ—¶é—´                                  â”‚
â”‚                                                             â”‚
â”‚  åœºæ™¯è¦†ç›– (å…³é”®ï¼):                                          â”‚
â”‚    âœ… æ­£å¸¸å…‰ç…§       20%                                    â”‚
â”‚    âœ… å¼ºå…‰/è¿‡æ›      15%                                    â”‚
â”‚    âœ… å¼±å…‰/åæš—      15%                                    â”‚
â”‚    âœ… ç™½å¹³è¡¡åé»„     20%   â† é‡è¦ï¼                         â”‚
â”‚    âœ… ç™½å¹³è¡¡åè“     20%   â† é‡è¦ï¼                         â”‚
â”‚    âœ… é˜´å½±/é®æŒ¡      10%                                    â”‚
â”‚                                                             â”‚
â”‚  æ³¨æ„äº‹é¡¹:                                                   â”‚
â”‚    â€¢ ä½¿ç”¨è®­ç»ƒé›†æˆ–éªŒè¯é›†çš„å­é›†                               â”‚
â”‚    â€¢ æ ¡å‡†æ•°æ®é¢„å¤„ç†è¦ä¸æ¨ç†æ—¶ä¸€è‡´                           â”‚
â”‚    â€¢ ä¸è¦åªç”¨"å¥½"çš„å›¾ç‰‡ï¼Œè¦æœ‰å¤šæ ·æ€§                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è½¬æ¢å¤±è´¥æ’æŸ¥

| é”™è¯¯ä¿¡æ¯ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:---------|:---------|:---------|
| `Op not support` | ONNXç®—å­ä¸æ”¯æŒ | ç®€åŒ–ONNXæˆ–ä¿®æ”¹æ¨¡å‹ç»“æ„ |
| `Load ONNX failed` | ONNXæ–‡ä»¶æŸåæˆ–æ ¼å¼é—®é¢˜ | é‡æ–°å¯¼å‡ºONNX |
| `Build failed` | æ ¡å‡†æ•°æ®é—®é¢˜ | æ£€æŸ¥æ ¡å‡†æ•°æ®æ ¼å¼å’Œæ•°é‡ |
| `Out of memory` | å†…å­˜ä¸è¶³ | å‡å°‘æ ¡å‡†æ•°æ®æˆ–å¢åŠ å†…å­˜ |
| `Quantization failed` | æ•°æ®åˆ†å¸ƒå¼‚å¸¸ | æ£€æŸ¥æ ¡å‡†æ•°æ®æ˜¯å¦æœ‰å¼‚å¸¸å€¼ |

### INT8é‡åŒ–

INT8é‡åŒ–æ˜¯å°†æ¨¡å‹æƒé‡å’Œæ¿€æ´»å€¼ä» FP32ï¼ˆ32ä½æµ®ç‚¹ï¼‰å‹ç¼©åˆ° INT8ï¼ˆ8ä½æ•´æ•°ï¼‰çš„è¿‡ç¨‹ï¼Œå¯å¤§å¹…æå‡æ¨ç†é€Ÿåº¦å¹¶å‡å°‘å†…å­˜å ç”¨ã€‚

#### é‡åŒ–åŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INT8é‡åŒ–åŸç†                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  FP32 (32ä½æµ®ç‚¹)                     INT8 (8ä½æ•´æ•°)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ æŒ‡æ•°ä½ â”‚ å°¾æ•°ä½     â”‚            â”‚    æ•´æ•°å€¼           â”‚                â”‚
â”‚  â”‚ 8 bit  â”‚ 23 bit     â”‚     â†’     â”‚    8 bit            â”‚                â”‚
â”‚  â”‚        â”‚            â”‚   é‡åŒ–     â”‚    èŒƒå›´: -128~127   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚     32 bit, åŠ¨æ€èŒƒå›´å¤§                  8 bit, é€Ÿåº¦å¿«                       â”‚
â”‚                                                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•    â”‚
â”‚                                                                             â”‚
â”‚  é‡åŒ–å…¬å¼:                                                                  â”‚
â”‚                                                                             â”‚
â”‚     q = round(r / scale) + zero_point                                       â”‚
â”‚                                                                             â”‚
â”‚     å…¶ä¸­:                                                                   â”‚
â”‚     - r: åŸå§‹FP32å€¼                                                        â”‚
â”‚     - q: é‡åŒ–åINT8å€¼                                                      â”‚
â”‚     - scale: ç¼©æ”¾å› å­ = (r_max - r_min) / 255                              â”‚
â”‚     - zero_point: é›¶ç‚¹åç§»                                                 â”‚
â”‚                                                                             â”‚
â”‚  åé‡åŒ–å…¬å¼:                                                                â”‚
â”‚                                                                             â”‚
â”‚     r â‰ˆ (q - zero_point) Ã— scale                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é‡åŒ–ç±»å‹å¯¹æ¯”

| é‡åŒ–ç±»å‹ | è¯´æ˜ | ç²¾åº¦ | é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|:-------:|:-----|:----:|:----:|:---------|
| **FP32** | åŸå§‹æµ®ç‚¹ | â­â­â­â­â­ | â­ | è®­ç»ƒã€ç²¾åº¦éªŒè¯ |
| **FP16** | åŠç²¾åº¦æµ®ç‚¹ | â­â­â­â­ | â­â­â­ | GPUæ¨ç† |
| **INT8** | 8ä½æ•´æ•° | â­â­â­ | â­â­â­â­â­ | NPUéƒ¨ç½²ï¼ˆæ¨èï¼‰|
| **INT4** | 4ä½æ•´æ•° | â­â­ | â­â­â­â­â­ | æè‡´å‹ç¼© |

#### RKNNé‡åŒ–é…ç½®è¯¦è§£

```python
# é‡åŒ–é…ç½®ç¤ºä¾‹
rknn.config(
    # ======== é‡åŒ–ç±»å‹ ========
    quantized_dtype='asymmetric_quantized-8',  # INT8éå¯¹ç§°é‡åŒ–
    # å¯é€‰å€¼:
    # - 'asymmetric_quantized-8': INT8éå¯¹ç§°é‡åŒ–ï¼ˆæ¨èï¼‰
    # - 'dynamic_fixed_point-8': INT8åŠ¨æ€å®šç‚¹
    # - 'dynamic_fixed_point-16': INT16åŠ¨æ€å®šç‚¹
    
    # ======== é‡åŒ–ç®—æ³• ========
    quantized_algorithm='normal',
    # å¯é€‰å€¼:
    # - 'normal': æ ‡å‡†é‡åŒ–ï¼ˆé»˜è®¤ï¼‰
    # - 'mmse': æœ€å°å‡æ–¹è¯¯å·®é‡åŒ–ï¼ˆç²¾åº¦æ›´é«˜ï¼Œé€Ÿåº¦æ…¢ï¼‰
    # - 'kl_divergence': KLæ•£åº¦é‡åŒ–
    
    # ======== é‡åŒ–æ–¹æ³• ========
    quantized_method='channel',
    # å¯é€‰å€¼:
    # - 'layer': é€å±‚é‡åŒ–ï¼ˆé€Ÿåº¦å¿«ï¼‰
    # - 'channel': é€é€šé“é‡åŒ–ï¼ˆç²¾åº¦é«˜ï¼Œæ¨èï¼‰
    
    # ======== å½’ä¸€åŒ–å‚æ•° ========
    # è¿™äº›å‚æ•°å†³å®šäº†è¾“å…¥æ•°æ®å¦‚ä½•è¢«é¢„å¤„ç†
    mean_values=[[123.675, 116.28, 103.53]],   # ImageNet RGBå‡å€¼Ã—255
    std_values=[[58.395, 57.12, 57.375]],      # ImageNet RGBæ ‡å‡†å·®Ã—255
    # å¦‚æœè®­ç»ƒæ—¶æ²¡æœ‰å½’ä¸€åŒ–ï¼Œä½¿ç”¨:
    # mean_values=[[0, 0, 0]]
    # std_values=[[255, 255, 255]]
)
```

#### é‡åŒ–æ•ˆæœå¯¹æ¯”

| æŒ‡æ ‡ | FP32æ¨¡å‹ | INT8æ¨¡å‹ | å˜åŒ– |
|:----:|:--------:|:--------:|:----:|
| **æ¨¡å‹å¤§å°** | ~120 MB | ~30 MB | **-75%** |
| **æ¨ç†æ—¶é—´** | ~100 ms (CPU) | ~30 ms (NPU) | **-70%** |
| **å†…å­˜å ç”¨** | ~200 MB | ~60 MB | **-70%** |
| **Diceç²¾åº¦** | 0.92 | 0.90 | -2.2% |
| **åŠŸè€—** | ~10W | ~3W | **-70%** |

> ğŸ’¡ **ç»“è®º**ï¼šINT8é‡åŒ–å¸¦æ¥çº¦ 2% çš„ç²¾åº¦æŸå¤±ï¼Œä½†è·å¾— **3-4å€** çš„é€Ÿåº¦æå‡å’Œ **75%** çš„æ¨¡å‹å‹ç¼©ï¼Œéå¸¸å€¼å¾—ï¼

#### ç²¾åº¦æŸå¤±åˆ†æä¸ä¼˜åŒ–

**é‡åŒ–ç²¾åº¦æŸå¤±çš„æ¥æºï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é‡åŒ–è¯¯å·®æ¥æº                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. æˆªæ–­è¯¯å·®                                                 â”‚
â”‚     â””â”€ FP32çš„ç²¾åº¦èŒƒå›´è¿œå¤§äºINT8                             â”‚
â”‚     â””â”€ æå¤§/æå°å€¼è¢«æˆªæ–­                                     â”‚
â”‚                                                             â”‚
â”‚  2. èˆå…¥è¯¯å·®                                                 â”‚
â”‚     â””â”€ æµ®ç‚¹æ•°å¿…é¡»èˆå…¥åˆ°æœ€è¿‘æ•´æ•°                             â”‚
â”‚     â””â”€ å¤šå±‚ç´¯ç§¯ä¼šæ”¾å¤§è¯¯å·®                                    â”‚
â”‚                                                             â”‚
â”‚  3. åˆ†å¸ƒä¸åŒ¹é…                                               â”‚
â”‚     â””â”€ æ ¡å‡†æ•°æ®ä¸èƒ½ä»£è¡¨çœŸå®åˆ†å¸ƒ                             â”‚
â”‚     â””â”€ å¯¼è‡´scaleå’Œzero_pointä¸å‡†ç¡®                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç²¾åº¦ä¼˜åŒ–ç­–ç•¥ï¼š**

| ç­–ç•¥ | æ–¹æ³• | æ•ˆæœ |
|:-----|:-----|:-----|
| **å¢åŠ æ ¡å‡†æ•°æ®** | ä½¿ç”¨100+å¼ å¤šæ ·æ€§å›¾åƒ | æå‡1-2%ç²¾åº¦ |
| **é€é€šé“é‡åŒ–** | `quantized_method='channel'` | æå‡1-2%ç²¾åº¦ |
| **MMSEç®—æ³•** | `quantized_algorithm='mmse'` | æå‡0.5-1%ç²¾åº¦ |
| **æ··åˆç²¾åº¦** | æ•æ„Ÿå±‚ä¿æŒFP16 | æå‡2-3%ç²¾åº¦ |
| **é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ** | è®­ç»ƒæ—¶æ¨¡æ‹Ÿé‡åŒ– | æå‡3-5%ç²¾åº¦ |

#### é‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼ˆQATï¼Œå¯é€‰ï¼‰

å¦‚æœINT8é‡åŒ–ç²¾åº¦æŸå¤±è¿‡å¤§ï¼Œå¯ä»¥è¿›è¡Œé‡åŒ–æ„ŸçŸ¥è®­ç»ƒï¼š

```python
# é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ - åœ¨è®­ç»ƒæ—¶æ¨¡æ‹Ÿé‡åŒ–æ•ˆæœ
import torch.quantization as quant

# 1. å®šä¹‰é‡åŒ–é…ç½®
model.qconfig = quant.get_default_qat_qconfig('fbgemm')

# 2. å‡†å¤‡é‡åŒ–æ„ŸçŸ¥è®­ç»ƒ
model_prepared = quant.prepare_qat(model)

# 3. æ­£å¸¸è®­ç»ƒè‹¥å¹²epoch
for epoch in range(10):
    train_one_epoch(model_prepared, train_loader, ...)

# 4. è½¬æ¢ä¸ºé‡åŒ–æ¨¡å‹
model_quantized = quant.convert(model_prepared)

# 5. å¯¼å‡ºONNXï¼ˆåç»­è½¬RKNNï¼‰
torch.onnx.export(model_quantized, ...)
```

#### é‡åŒ–éªŒè¯è„šæœ¬

```python
# verify_quantization.py - éªŒè¯é‡åŒ–å‰åç²¾åº¦å·®å¼‚

import numpy as np
import cv2
import onnxruntime as ort
from rknn.api import RKNN


def compare_outputs(onnx_path, rknn_path, test_images, input_size=224):
    """æ¯”è¾ƒONNXå’ŒRKNNæ¨¡å‹çš„è¾“å‡ºå·®å¼‚"""
    
    # åŠ è½½ONNXæ¨¡å‹
    onnx_session = ort.InferenceSession(onnx_path)
    
    # åŠ è½½RKNNæ¨¡å‹
    rknn = RKNN()
    rknn.load_rknn(rknn_path)
    rknn.init_runtime(target=None)  # æ¨¡æ‹Ÿå™¨æ¨¡å¼
    
    errors = []
    
    for img_path in test_images:
        # å‡†å¤‡è¾“å…¥
        image = cv2.imread(img_path)
        image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
        image = cv2.resize(image, (input_size, input_size))
        
        # ONNXæ¨ç†
        onnx_input = image.astype(np.float32) / 255.0
        onnx_input = (onnx_input - [0.485, 0.456, 0.406]) / [0.229, 0.224, 0.225]
        onnx_input = np.transpose(onnx_input, (2, 0, 1))[None, ...]
        onnx_output = onnx_session.run(None, {'input': onnx_input.astype(np.float32)})[0]
        
        # RKNNæ¨ç†
        rknn_output = rknn.inference(inputs=[image])[0]
        
        # åé‡åŒ–RKNNè¾“å‡ºè¿›è¡Œæ¯”è¾ƒ
        rknn_output_float = rknn_output.astype(np.float32)
        
        # è®¡ç®—è¯¯å·®
        # å…ˆå°†ä¸¤è€…éƒ½è½¬ä¸ºæ¦‚ç‡
        onnx_prob = 1 / (1 + np.exp(-onnx_output))
        rknn_prob = 1 / (1 + np.exp(-rknn_output_float))
        
        mae = np.abs(onnx_prob - rknn_prob).mean()
        errors.append(mae)
        
        print(f"{img_path}: MAE = {mae:.6f}")
    
    avg_error = np.mean(errors)
    print(f"\nAverage MAE: {avg_error:.6f}")
    print(f"Max MAE: {max(errors):.6f}")
    
    if avg_error < 0.05:
        print("âœ“ Quantization quality: GOOD")
    elif avg_error < 0.10:
        print("âš  Quantization quality: ACCEPTABLE")
    else:
        print("âœ— Quantization quality: POOR - consider retraining or more calibration data")
    
    rknn.release()
    return avg_error


if __name__ == '__main__':
    test_images = ['test1.jpg', 'test2.jpg', 'test3.jpg']
    compare_outputs('lane_unet.onnx', 'lane_unet.rknn', test_images)
```

#### é‡åŒ–æ£€æŸ¥æ¸…å•

```
â–¡ æ ¡å‡†æ•°æ®å‡†å¤‡
  â”œâ”€ â–¡ æ•°é‡å……è¶³ (50-200å¼ )
  â”œâ”€ â–¡ åœºæ™¯å¤šæ · (å…‰ç…§ã€ç™½å¹³è¡¡ã€é®æŒ¡)
  â””â”€ â–¡ é¢„å¤„ç†ä¸æ¨ç†ä¸€è‡´

â–¡ é‡åŒ–é…ç½®
  â”œâ”€ â–¡ ä½¿ç”¨é€é€šé“é‡åŒ– (channel)
  â”œâ”€ â–¡ mean/stdå‚æ•°ä¸è®­ç»ƒä¸€è‡´
  â””â”€ â–¡ ç›®æ ‡å¹³å°æ­£ç¡® (rk3588)

â–¡ ç²¾åº¦éªŒè¯
  â”œâ”€ â–¡ æµ‹è¯•é›†Dice/IoUå˜åŒ– < 5%
  â”œâ”€ â–¡ è¾¹ç¼˜æ£€æµ‹æ— æ˜æ˜¾é€€åŒ–
  â””â”€ â–¡ å„åœºæ™¯è¡¨ç°ä¸€è‡´

â–¡ æ€§èƒ½éªŒè¯
  â”œâ”€ â–¡ æ¨ç†é€Ÿåº¦è¾¾åˆ°30+ FPS
  â”œâ”€ â–¡ å†…å­˜å ç”¨åœ¨å¯æ¥å—èŒƒå›´
  â””â”€ â–¡ æ¨¡å‹å¤§å° < 50MB
```

## ROSèŠ‚ç‚¹ä½¿ç”¨

### èŠ‚ç‚¹è¯´æ˜

`unet_ros_node.py` æ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒ ROS èŠ‚ç‚¹ï¼Œè´Ÿè´£æ¥æ”¶æ‘„åƒå¤´å›¾åƒã€æ‰§è¡Œ U-Net æ¨ç†ã€å‘å¸ƒåˆ†å‰²æ©ç ã€‚

#### èŠ‚ç‚¹æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     unet_ros_node èŠ‚ç‚¹æ¶æ„                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  /image_rect_color (sensor_msgs/Image)                                      â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â†“                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     LaneSegmentationROS èŠ‚ç‚¹                         â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  cv_bridge  â”‚    â”‚  é€è§†å˜æ¢   â”‚    â”‚   RKNNLaneInference    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  å›¾åƒè½¬æ¢   â”‚ â†’  â”‚   (IPM)     â”‚ â†’  â”‚   U-Net NPUæ¨ç†        â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚         â”‚                 â”‚                       â”‚                   â”‚   â”‚
â”‚  â”‚         â†“                 â†“                       â†“                   â”‚   â”‚
â”‚  â”‚     BGRå›¾åƒ          é¸Ÿç°å›¾            äºŒå€¼æ©ç  (224Ã—224)            â”‚   â”‚
â”‚  â”‚     640Ã—480         1055Ã—685                                          â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  åå¤„ç†: Sigmoid â†’ é˜ˆå€¼äºŒå€¼åŒ– â†’ Resize â†’ ROSæ¶ˆæ¯è½¬æ¢           â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                   â”‚
â”‚         â†“                                                                   â”‚
â”‚  /mask (sensor_msgs/Image, mono8)                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒç±»è¯´æ˜

**1. `RKNNLaneInference` - RKNNæ¨ç†å¼•æ“**

| æ–¹æ³• | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º |
|:-----|:-----|:-----|:-----|
| `__init__()` | åŠ è½½RKNNæ¨¡å‹åˆ°NPU | æ¨¡å‹è·¯å¾„ã€ç›®æ ‡å¹³å° | - |
| `preprocess_image()` | å›¾åƒé¢„å¤„ç† | BGRå›¾åƒ | (1,224,224,3) uint8 |
| `postprocess_output()` | åå¤„ç† | æ¨¡å‹è¾“å‡º | äºŒå€¼æ©ç  |
| `predict()` | å®Œæ•´æ¨ç†æµç¨‹ | å›¾åƒ, é˜ˆå€¼ | (æ©ç , æ¨ç†æ—¶é—´) |
| `release()` | é‡Šæ”¾NPUèµ„æº | - | - |

**2. `LaneSegmentationROS` - ROSèŠ‚ç‚¹å°è£…**

| æ–¹æ³• | åŠŸèƒ½ | è¯´æ˜ |
|:-----|:-----|:-----|
| `__init__()` | åˆå§‹åŒ–èŠ‚ç‚¹ | åŠ è½½å‚æ•°ã€åˆ›å»ºå‘å¸ƒ/è®¢é˜… |
| `image_callback()` | å›¾åƒå›è°ƒå‡½æ•° | é€è§†å˜æ¢â†’æ¨ç†â†’å‘å¸ƒ |
| `shutdown_callback()` | å…³é—­å›è°ƒ | é‡Šæ”¾èµ„æºã€æ‰“å°ç»Ÿè®¡ |
| `run()` | è¿è¡ŒèŠ‚ç‚¹ | è¿›å…¥spinå¾ªç¯ |

#### å¤„ç†æµç¨‹è¯¦è§£

```python
def image_callback(self, msg):
    """å›¾åƒå›è°ƒå¤„ç†æµç¨‹"""
    
    # 1. ROSæ¶ˆæ¯ â†’ OpenCVå›¾åƒ
    cv_image = self.bridge.imgmsg_to_cv2(msg, "bgr8")  # 640Ã—480 BGR
    
    # 2. é€è§†å˜æ¢ï¼ˆé€†é€è§†æ˜ å°„/IPMï¼‰
    #    å°†æ‘„åƒå¤´è§†è§’è½¬æ¢ä¸ºé¸Ÿç°å›¾
    #    src_points: åŸå›¾ä¸­è½¦é“çº¿åŒºåŸŸçš„å››ä¸ªè§’ç‚¹
    #    dst_points: ç›®æ ‡é¸Ÿç°å›¾ä¸­çš„çŸ©å½¢åŒºåŸŸ
    warped_image = cv2.warpPerspective(
        cv_image, 
        self.perspective_matrix,
        (1055, 685)  # è¾“å‡ºå°ºå¯¸
    )
    
    # 3. é¢œè‰²è½¬æ¢
    rgb_image = cv2.cvtColor(warped_image, cv2.COLOR_BGR2RGB)
    
    # 4. U-Netæ¨ç†
    #    å†…éƒ¨æµç¨‹: Resize(224Ã—224) â†’ NPUæ¨ç† â†’ Sigmoid â†’ é˜ˆå€¼ â†’ Resizeå›åŸå°ºå¯¸
    binary_mask, inference_time = self.inferencer.predict(rgb_image, 0.5)
    
    # 5. å‘å¸ƒROSæ¶ˆæ¯
    mask_msg = self.bridge.cv2_to_imgmsg(binary_mask, "mono8")
    mask_msg.header = msg.header  # ä¿æŒæ—¶é—´åŒæ­¥
    self.mask_pub.publish(mask_msg)
```

#### é€è§†å˜æ¢é…ç½®

èŠ‚ç‚¹å†…ç½®äº†é€è§†å˜æ¢ï¼ˆIPMï¼‰ï¼Œå°†æ‘„åƒå¤´è§†è§’è½¬æ¢ä¸ºé¸Ÿç°å›¾ï¼Œä¾¿äºåç»­çš„è½¦é“çº¿æ‹Ÿåˆã€‚

```python
# é€è§†å˜æ¢å‚æ•°ï¼ˆéœ€æ ¹æ®å®é™…æ‘„åƒå¤´å®‰è£…ä½ç½®è°ƒæ•´ï¼‰
src_points = np.float32([
    [29, 347],   # å·¦ä¸‹ç‚¹ (åŸå›¾ä¸­è½¦é“çº¿åŒºåŸŸ)
    [619, 368],  # å³ä¸‹ç‚¹
    [202, 238],  # å·¦ä¸Šç‚¹
    [422, 248]   # å³ä¸Šç‚¹
])

dst_points = np.float32([
    [300, 580],  # å·¦ä¸‹ç‚¹ (é¸Ÿç°å›¾ä¸­å¯¹åº”ä½ç½®)
    [755, 580],  # å³ä¸‹ç‚¹
    [300, 100],  # å·¦ä¸Šç‚¹
    [755, 100]   # å³ä¸Šç‚¹
])
```

```
åŸå›¾è§†è§’ (æ‘„åƒå¤´)              é¸Ÿç°å›¾è§†è§’ (IPMå˜æ¢å)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   â”‚         â”‚  |           |    â”‚
â”‚      /      \     â”‚         â”‚  |           |    â”‚
â”‚     /        \    â”‚    â†’    â”‚  |  è½¦é“çº¿   |    â”‚
â”‚    /          \   â”‚         â”‚  |           |    â”‚
â”‚   /____________\  â”‚         â”‚  |___________|    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    é€è§†å˜å½¢å­˜åœ¨                  å¹³è¡Œçº¿ä¿æŒå¹³è¡Œ
```

#### æ€§èƒ½ç»Ÿè®¡

èŠ‚ç‚¹æ¯5ç§’è‡ªåŠ¨è¾“å‡ºæ€§èƒ½ç»Ÿè®¡æ—¥å¿—ï¼š

```
[INFO] Lane Segmentation - Frames: 150, Avg FPS: 30.2, Last inference: 0.028s
```

| ç»Ÿè®¡é¡¹ | è¯´æ˜ |
|:------|:-----|
| Frames | å·²å¤„ç†çš„æ€»å¸§æ•° |
| Avg FPS | å¹³å‡å¸§ç‡ |
| Last inference | æœ€è¿‘ä¸€æ¬¡æ¨ç†è€—æ—¶ |

### è¯é¢˜æ¥å£

#### è®¢é˜…è¯é¢˜

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | é˜Ÿåˆ— | æè¿° |
|:---------|:---------|:----:|:-----|
| `/image_rect_color` | `sensor_msgs/Image` | 1 | è¾“å…¥å›¾åƒï¼ŒBGRæ ¼å¼ï¼Œé€šå¸¸ä¸º640Ã—480 |

#### å‘å¸ƒè¯é¢˜

| è¯é¢˜åç§° | æ¶ˆæ¯ç±»å‹ | é˜Ÿåˆ— | æè¿° |
|:---------|:---------|:----:|:-----|
| `/mask` | `sensor_msgs/Image` | 1 | è¾“å‡ºæ©ç ï¼Œmono8æ ¼å¼ï¼Œ1055Ã—685 |

#### è¯é¢˜è¯¦ç»†è¯´æ˜

**è¾“å…¥è¯é¢˜ `/image_rect_color`**

```yaml
# æ¶ˆæ¯æ ¼å¼: sensor_msgs/Image
header:
  seq: 12345
  stamp:
    secs: 1234567890
    nsecs: 123456789
  frame_id: "camera_link"
height: 480
width: 640
encoding: "bgr8"          # æˆ– "rgb8"
is_bigendian: 0
step: 1920                # width Ã— 3 (3é€šé“)
data: [...]               # åƒç´ æ•°æ®
```

| å±æ€§ | è¦æ±‚ | è¯´æ˜ |
|:-----|:-----|:-----|
| encoding | bgr8 / rgb8 | èŠ‚ç‚¹å†…éƒ¨ä¼šè½¬æ¢ä¸ºRGB |
| height | å»ºè®®480 | æ”¯æŒå…¶ä»–å°ºå¯¸ |
| width | å»ºè®®640 | æ”¯æŒå…¶ä»–å°ºå¯¸ |
| frame_rate | å»ºè®®30fps | æ›´é«˜å¸§ç‡NPUå¯èƒ½è·Ÿä¸ä¸Š |

**è¾“å‡ºè¯é¢˜ `/mask`**

```yaml
# æ¶ˆæ¯æ ¼å¼: sensor_msgs/Image
header:
  seq: 12345
  stamp:                  # ä¸è¾“å…¥å›¾åƒæ—¶é—´æˆ³ä¸€è‡´
    secs: 1234567890
    nsecs: 123456789
  frame_id: "camera_link" # ä¸è¾“å…¥å›¾åƒframe_idä¸€è‡´
height: 685               # é€è§†å˜æ¢åçš„é«˜åº¦
width: 1055               # é€è§†å˜æ¢åçš„å®½åº¦
encoding: "mono8"         # å•é€šé“ç°åº¦å›¾
is_bigendian: 0
step: 1055                # width Ã— 1
data: [...]               # 0=èƒŒæ™¯, 255=è½¦é“çº¿
```

| åƒç´ å€¼ | å«ä¹‰ |
|:------:|:-----|
| 0 | èƒŒæ™¯ï¼ˆéè½¦é“çº¿åŒºåŸŸï¼‰ |
| 255 | è½¦é“çº¿ï¼ˆæ£€æµ‹åˆ°çš„åŒºåŸŸï¼‰ |

#### è¯é¢˜å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ROSè¯é¢˜æ•°æ®æµ                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     /image_rect_color     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  usb_cam    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚  unet_ros_node      â”‚      â”‚
â”‚  â”‚  æ‘„åƒå¤´èŠ‚ç‚¹  â”‚     sensor_msgs/Image    â”‚  U-Netæ¨ç†èŠ‚ç‚¹       â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (640Ã—480, bgr8)       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                       â”‚                  â”‚
â”‚                                                       â”‚ /mask            â”‚
â”‚                                                       â”‚ sensor_msgs/Imageâ”‚
â”‚                                                       â”‚ (1055Ã—685, mono8)â”‚
â”‚                                                       â†“                  â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                            â”‚  line_follow        â”‚      â”‚
â”‚                                            â”‚  å·¡çº¿æ§åˆ¶èŠ‚ç‚¹        â”‚      â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                       â”‚                  â”‚
â”‚                                                       â”‚ /cmd_vel         â”‚
â”‚                                                       â”‚ geometry_msgs/   â”‚
â”‚                                                       â”‚ Twist            â”‚
â”‚                                                       â†“                  â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                            â”‚  ucar_controller    â”‚      â”‚
â”‚                                            â”‚  åº•ç›˜é©±åŠ¨èŠ‚ç‚¹        â”‚      â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æŸ¥çœ‹è¯é¢˜å‘½ä»¤

```bash
# åˆ—å‡ºæ‰€æœ‰è¯é¢˜
rostopic list

# æŸ¥çœ‹è¯é¢˜ä¿¡æ¯
rostopic info /mask

# æŸ¥çœ‹è¯é¢˜æ¶ˆæ¯ç±»å‹
rostopic type /mask
# è¾“å‡º: sensor_msgs/Image

# æŸ¥çœ‹è¯é¢˜å‘å¸ƒé¢‘ç‡
rostopic hz /mask
# è¾“å‡º: average rate: 30.xxx

# æŸ¥çœ‹è¯é¢˜å¸¦å®½
rostopic bw /mask
# è¾“å‡º: average: xxx.xx KB/s

# å¯è§†åŒ–è¯é¢˜å†…å®¹
rqt_image_view /mask
```

### å‚æ•°é…ç½®

èŠ‚ç‚¹æ”¯æŒé€šè¿‡ ROS å‚æ•°æœåŠ¡å™¨è¿›è¡Œé…ç½®ï¼Œæ‰€æœ‰å‚æ•°å‡æ”¯æŒåœ¨ launch æ–‡ä»¶ä¸­è®¾ç½®ã€‚

#### å‚æ•°åˆ—è¡¨

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|:-------|:-----|:-------|:-----|
| `~model_path` | string | `/home/ucar/ucar_ws/src/rknn_pkg/model/lane_unet_803.rknn` | RKNNæ¨¡å‹æ–‡ä»¶è·¯å¾„ |
| `~threshold` | float | `0.5` | äºŒå€¼åŒ–é˜ˆå€¼ï¼ˆ0.0-1.0ï¼‰ |
| `~target` | string | `rk3588` | ç›®æ ‡å¹³å°ï¼ˆrk3588/rk3566/rk3568ï¼‰ |
| `~device_id` | string | `0` | NPUè®¾å¤‡ID |
| `~input_topic` | string | `/image_rect_color` | è¾“å…¥å›¾åƒè¯é¢˜å |
| `~output_topic` | string | `/mask` | è¾“å‡ºæ©ç è¯é¢˜å |

#### å‚æ•°è¯¦ç»†è¯´æ˜

**`~model_path`** - RKNNæ¨¡å‹è·¯å¾„

```bash
# ä½¿ç”¨ç»å¯¹è·¯å¾„
_model_path:=/home/ucar/ucar_ws/src/rknn_pkg/model/lane_unet_803.rknn

# ä½¿ç”¨$(find ...)è¯­æ³•ï¼ˆæ¨èåœ¨launchä¸­ä½¿ç”¨ï¼‰
_model_path:=$(find rknn_pkg)/model/lane_unet_803.rknn
```

**`~threshold`** - äºŒå€¼åŒ–é˜ˆå€¼

| é˜ˆå€¼èŒƒå›´ | æ•ˆæœ | é€‚ç”¨åœºæ™¯ |
|:--------:|:-----|:---------|
| 0.3-0.4 | å®½æ¾ï¼Œæ£€æµ‹æ›´å¤šåŒºåŸŸ | è½¦é“çº¿è¾ƒç»†æˆ–å¼±å…‰ç¯å¢ƒ |
| 0.5 | å¹³è¡¡ï¼ˆé»˜è®¤ï¼‰ | å¤§å¤šæ•°åœºæ™¯ |
| 0.6-0.7 | ä¸¥æ ¼ï¼Œå‡å°‘è¯¯æ£€ | å¤æ‚èƒŒæ™¯æˆ–æœ‰å¹²æ‰°æ—¶ |

```
threshold = 0.3                    threshold = 0.5                    threshold = 0.7
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚               â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚               â”‚       â–ˆâ–ˆâ–ˆ       â”‚
â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚               â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â”‚               â”‚      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      â”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚               â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚               â”‚     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚               â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚               â”‚    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  æ›´å¤šæ£€æµ‹ï¼Œå¯èƒ½æœ‰å™ªç‚¹              å¹³è¡¡æ•ˆæœ                           æ›´ç²¾ç¡®ï¼Œå¯èƒ½æœ‰æ–­è£‚
```

**`~target`** - ç›®æ ‡å¹³å°

| å¹³å° | NPUç®—åŠ› | è¯´æ˜ |
|:-----|:--------|:-----|
| `rk3588` | 6 TOPS | æœ¬é¡¹ç›®é»˜è®¤å¹³å° |
| `rk3588s` | 6 TOPS | RK3588Så˜ä½“ |
| `rk3566` | 1 TOPS | ä½åŠŸè€—å¹³å° |
| `rk3568` | 1 TOPS | å·¥ä¸šçº§å¹³å° |

#### è¿è¡Œæ—¶å‚æ•°è®¾ç½®

```bash
# æ–¹å¼1ï¼šå‘½ä»¤è¡Œå‚æ•°
rosrun rknn_pkg unet_ros_node.py \
    _model_path:=/path/to/model.rknn \
    _threshold:=0.6 \
    _input_topic:=/camera/image_raw \
    _output_topic:=/lane/mask

# æ–¹å¼2ï¼šrosparamè®¾ç½®åè¿è¡Œ
rosparam set /unet_ros_node/threshold 0.6
rosrun rknn_pkg unet_ros_node.py

# æ–¹å¼3ï¼šä½¿ç”¨launchæ–‡ä»¶ï¼ˆæ¨èï¼‰
roslaunch rknn_pkg mask.launch threshold:=0.6
```

#### åŠ¨æ€è°ƒå‚ï¼ˆå¯é€‰æ‰©å±•ï¼‰

å¦‚éœ€æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´å‚æ•°ï¼Œå¯æ·»åŠ  `dynamic_reconfigure` æ”¯æŒï¼š

```python
# åœ¨èŠ‚ç‚¹ä¸­æ·»åŠ dynamic_reconfigureæ”¯æŒ
from dynamic_reconfigure.server import Server
from rknn_pkg.cfg import LaneDetectionConfig

def reconfigure_callback(config, level):
    self.threshold = config.threshold
    rospy.loginfo(f"Threshold updated to: {self.threshold}")
    return config

# åœ¨__init__ä¸­
self.srv = Server(LaneDetectionConfig, reconfigure_callback)
```

### Launchæ–‡ä»¶

#### åŸºç¡€Launchæ–‡ä»¶

```xml
<!-- launch/mask.launch -->
<launch>
    <!-- å‚æ•°å®šä¹‰ -->
    <arg name="model_path" default="$(find rknn_pkg)/model/lane_unet_803.rknn"/>
    <arg name="threshold" default="0.5"/>
    <arg name="target" default="rk3588"/>
    <arg name="device_id" default="0"/>
    <arg name="input_topic" default="/image_rect_color"/>
    <arg name="output_topic" default="/mask"/>
    
    <!-- U-Netè½¦é“çº¿æ£€æµ‹èŠ‚ç‚¹ -->
    <node name="unet_ros_node" pkg="rknn_pkg" type="unet_ros_node.py" output="screen">
        <param name="model_path" value="$(arg model_path)"/>
        <param name="threshold" value="$(arg threshold)"/>
        <param name="target" value="$(arg target)"/>
        <param name="device_id" value="$(arg device_id)"/>
        <param name="input_topic" value="$(arg input_topic)"/>
        <param name="output_topic" value="$(arg output_topic)"/>
    </node>
</launch>
```

#### å®Œæ•´ç³»ç»ŸLaunchæ–‡ä»¶

```xml
<!-- launch/lane_detection_system.launch -->
<launch>
    <!-- ===== å‚æ•°é…ç½® ===== -->
    <arg name="camera_device" default="/dev/video0"/>
    <arg name="model_path" default="$(find rknn_pkg)/model/lane_unet_803.rknn"/>
    <arg name="threshold" default="0.5"/>
    
    <!-- ===== æ‘„åƒå¤´èŠ‚ç‚¹ ===== -->
    <node name="usb_cam" pkg="usb_cam" type="usb_cam_node" output="screen">
        <param name="video_device" value="$(arg camera_device)"/>
        <param name="image_width" value="640"/>
        <param name="image_height" value="480"/>
        <param name="framerate" value="30"/>
        <param name="pixel_format" value="yuyv"/>
        <param name="camera_frame_id" value="camera_link"/>
        <remap from="/usb_cam/image_raw" to="/image_rect_color"/>
    </node>
    
    <!-- ===== U-Netè½¦é“çº¿æ£€æµ‹èŠ‚ç‚¹ ===== -->
    <node name="unet_ros_node" pkg="rknn_pkg" type="unet_ros_node.py" output="screen">
        <param name="model_path" value="$(arg model_path)"/>
        <param name="threshold" value="$(arg threshold)"/>
        <param name="target" value="rk3588"/>
        <param name="input_topic" value="/image_rect_color"/>
        <param name="output_topic" value="/mask"/>
    </node>
    
    <!-- ===== å¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰===== -->
    <node name="image_view" pkg="image_view" type="image_view" output="screen">
        <remap from="image" to="/mask"/>
    </node>
</launch>
```

#### Launchä½¿ç”¨å‘½ä»¤

```bash
# åŸºæœ¬å¯åŠ¨
roslaunch rknn_pkg mask.launch

# è‡ªå®šä¹‰é˜ˆå€¼
roslaunch rknn_pkg mask.launch threshold:=0.6

# ä½¿ç”¨ä¸åŒæ¨¡å‹
roslaunch rknn_pkg mask.launch model_path:=/path/to/other_model.rknn

# æ›´æ¢è¾“å…¥è¯é¢˜
roslaunch rknn_pkg mask.launch input_topic:=/camera/image_raw

# å®Œæ•´ç³»ç»Ÿå¯åŠ¨
roslaunch rknn_pkg lane_detection_system.launch
```

### ä¸ä¸‹æ¸¸èŠ‚ç‚¹é›†æˆ

#### é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å®Œæ•´å·¡çº¿ç³»ç»Ÿé›†æˆæ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ æ‘„åƒå¤´  â”‚    â”‚ unet_ros_nodeâ”‚    â”‚ line_follow  â”‚    â”‚ åº•ç›˜æ§åˆ¶    â”‚  â”‚
â”‚   â”‚         â”‚â”€â”€â”€â†’â”‚              â”‚â”€â”€â”€â†’â”‚              â”‚â”€â”€â”€â†’â”‚             â”‚  â”‚
â”‚   â”‚         â”‚    â”‚ U-Netæ¨ç†    â”‚    â”‚ è½¦é“çº¿æ‹Ÿåˆ   â”‚    â”‚ PIDæ§åˆ¶     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚                â”‚                    â”‚                   â”‚          â”‚
â”‚       â†“                â†“                    â†“                   â†“          â”‚
â”‚  /image_rect      /mask               /lane_info          /cmd_vel        â”‚
â”‚   _color          (äºŒå€¼æ©ç )          (è½¦é“ä¿¡æ¯)          (é€Ÿåº¦æŒ‡ä»¤)       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸‹æ¸¸èŠ‚ç‚¹æ¥æ”¶æ©ç ç¤ºä¾‹

```python
#!/usr/bin/env python3
# line_follow_node.py - æ¥æ”¶U-Netæ©ç å¹¶è¿›è¡Œå·¡çº¿æ§åˆ¶

import rospy
import cv2
import numpy as np
from sensor_msgs.msg import Image
from geometry_msgs.msg import Twist
from cv_bridge import CvBridge

class LineFollower:
    def __init__(self):
        rospy.init_node('line_follower')
        
        self.bridge = CvBridge()
        self.cmd_pub = rospy.Publisher('/cmd_vel', Twist, queue_size=1)
        
        # è®¢é˜…U-Netè¾“å‡ºçš„æ©ç 
        rospy.Subscriber('/mask', Image, self.mask_callback)
        
        # PIDå‚æ•°
        self.kp = 0.005
        self.ki = 0.0001
        self.kd = 0.001
        self.error_sum = 0
        self.last_error = 0
        
        rospy.loginfo("Line Follower initialized, waiting for /mask...")
    
    def mask_callback(self, msg):
        # å°†ROSæ¶ˆæ¯è½¬ä¸ºOpenCVå›¾åƒ
        mask = self.bridge.imgmsg_to_cv2(msg, "mono8")
        
        # è®¡ç®—è½¦é“çº¿ä¸­å¿ƒ
        center_x = self.find_lane_center(mask)
        
        if center_x is not None:
            # è®¡ç®—åå·®ï¼ˆå›¾åƒä¸­å¿ƒä¸ºå‚è€ƒï¼‰
            image_center = mask.shape[1] // 2
            error = center_x - image_center
            
            # PIDæ§åˆ¶
            self.error_sum += error
            error_diff = error - self.last_error
            
            angular_z = -(self.kp * error + 
                          self.ki * self.error_sum + 
                          self.kd * error_diff)
            
            self.last_error = error
            
            # å‘å¸ƒé€Ÿåº¦æŒ‡ä»¤
            cmd = Twist()
            cmd.linear.x = 0.3  # å‰è¿›é€Ÿåº¦
            cmd.angular.z = angular_z
            self.cmd_pub.publish(cmd)
    
    def find_lane_center(self, mask, scan_row=None):
        """åœ¨æŒ‡å®šè¡Œæ‰«æè½¦é“çº¿ï¼Œè¿”å›ä¸­å¿ƒxåæ ‡"""
        if scan_row is None:
            scan_row = int(mask.shape[0] * 0.7)  # é»˜è®¤æ‰«æ70%é«˜åº¦å¤„
        
        row = mask[scan_row, :]
        white_pixels = np.where(row > 127)[0]
        
        if len(white_pixels) > 10:
            # ç®€å•å–å¹³å‡ä½œä¸ºä¸­å¿ƒ
            return int(np.mean(white_pixels))
        return None

if __name__ == '__main__':
    try:
        follower = LineFollower()
        rospy.spin()
    except rospy.ROSInterruptException:
        pass
```

#### ä¸ç°æœ‰ line_follow èŠ‚ç‚¹é›†æˆ

æœ¬é¡¹ç›®çš„ `line_follow` åŒ…å·²æ”¯æŒä» `/mask` è¯é¢˜æ¥æ”¶åˆ†å‰²ç»“æœï¼š

```bash
# å¯åŠ¨U-NetèŠ‚ç‚¹
roslaunch rknn_pkg mask.launch

# å¯åŠ¨å·¡çº¿èŠ‚ç‚¹ï¼ˆä¼šè‡ªåŠ¨è®¢é˜…/maskï¼‰
roslaunch line_follow line_follower.launch use_unet_mask:=true
```

#### å¤šèŠ‚ç‚¹è”åˆLaunch

```xml
<!-- launch/full_system.launch -->
<launch>
    <!-- æ‘„åƒå¤´ -->
    <include file="$(find usb_cam)/launch/usb_cam-test.launch"/>
    
    <!-- U-Netè½¦é“çº¿æ£€æµ‹ -->
    <include file="$(find rknn_pkg)/launch/mask.launch"/>
    
    <!-- å·¡çº¿æ§åˆ¶ -->
    <include file="$(find line_follow)/launch/line_follower.launch">
        <arg name="use_unet_mask" value="true"/>
    </include>
    
    <!-- åº•ç›˜æ§åˆ¶ -->
    <include file="$(find ucar_controller)/launch/controller.launch"/>
</launch>
```

---

## æ€§èƒ½æŒ‡æ ‡

### ç²¾åº¦æŒ‡æ ‡

åœ¨è‡ªå»ºæ•°æ®é›†ä¸Šçš„æµ‹è¯•ç»“æœï¼š

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|:-----|:----:|:-----|
| **IoU** | 0.847 | äº¤å¹¶æ¯”ï¼Œè¡¡é‡é¢„æµ‹ä¸çœŸå€¼çš„é‡å åº¦ |
| **Dice** | 0.917 | Diceç³»æ•°ï¼Œå¯¹å°ç›®æ ‡æ›´æ•æ„Ÿ |
| **Precision** | 0.923 | ç²¾ç¡®ç‡ï¼Œé¢„æµ‹ä¸ºè½¦é“çº¿çš„æ­£ç¡®ç‡ |
| **Recall** | 0.911 | å¬å›ç‡ï¼Œå®é™…è½¦é“çº¿è¢«æ£€å‡ºçš„æ¯”ä¾‹ |
| **F1-Score** | 0.917 | ç²¾ç¡®ç‡å’Œå¬å›ç‡çš„è°ƒå’Œå¹³å‡ |
| **Pixel Accuracy** | 0.968 | åƒç´ çº§å‡†ç¡®ç‡ |

#### ä¸åŒåœºæ™¯ä¸‹çš„è¡¨ç°

```
ç²¾åº¦å¯¹æ¯”ï¼ˆIoUï¼‰
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    æ­£å¸¸å…‰ç…§    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   0.89   â”‚
    å¼±å…‰ç¯å¢ƒ    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         0.82   â”‚
    å¼ºå…‰ç¯å¢ƒ    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ     0.86   â”‚
    é˜´å½±é®æŒ¡    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ           0.80   â”‚
    é›¨å¤©æ½®æ¹¿    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ             0.78   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                0.0    0.2    0.4    0.6    0.8    1.0
```

| åœºæ™¯ | IoU | Dice | è¯´æ˜ |
|:-----|:---:|:----:|:-----|
| æ­£å¸¸å…‰ç…§ | 0.89 | 0.94 | ç†æƒ³æ¡ä»¶ä¸‹è¡¨ç°æœ€ä½³ |
| å¼±å…‰ç¯å¢ƒ | 0.82 | 0.90 | æ•°æ®å¢å¼ºæœ‰æ•ˆæå‡æš—å…‰èƒ½åŠ› |
| å¼ºå…‰ç¯å¢ƒ | 0.86 | 0.92 | è¿‡æ›åŒºåŸŸç•¥æœ‰å½±å“ |
| é˜´å½±é®æŒ¡ | 0.80 | 0.89 | éƒ¨åˆ†é˜´å½±è¾¹ç¼˜æœ‰è¯¯æ£€ |
| æ›²çº¿è½¦é“ | 0.85 | 0.92 | å¼¯é“æ£€æµ‹ç¨³å®š |

#### ä¸ä¼ ç»ŸHSVæ–¹æ³•å¯¹æ¯”

| æ–¹æ³• | IoU | ç¨³å®šæ€§ | å…‰ç…§é²æ£’æ€§ |
|:-----|:---:|:------:|:----------:|
| **U-Net (æœ¬é¡¹ç›®)** | **0.847** | **é«˜** | **å¼º** |
| HSVé˜ˆå€¼æ³• | 0.652 | ä½ | å¼± |
| è‡ªé€‚åº”HSV | 0.714 | ä¸­ | ä¸­ |
| Cannyè¾¹ç¼˜ | 0.583 | ä½ | ä¸­ |

### é€Ÿåº¦æŒ‡æ ‡

#### æ¨ç†å»¶è¿Ÿ

| å¹³å° | é‡åŒ–ç±»å‹ | æ¨ç†æ—¶é—´ | FPS | NPUåˆ©ç”¨ç‡ |
|:-----|:--------:|:--------:|:---:|:---------:|
| **RK3588 NPU** | INT8 | **8.2ms** | **122** | ~45% |
| RK3588 NPU | FP16 | 15.6ms | 64 | ~60% |
| RK3588 CPU | FP32 | 89ms | 11 | - |
| RK3566 NPU | INT8 | 32ms | 31 | ~70% |
| PC (RTX 2060) | FP32 | 4.1ms | 244 | ~15% |
| PC (i7-10700) | FP32 | 156ms | 6 | ~80% |

#### ç«¯åˆ°ç«¯å»¶è¿Ÿåˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç«¯åˆ°ç«¯å¤„ç†å»¶è¿Ÿåˆ†è§£ (ms)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   å›¾åƒé‡‡é›† â”€â”€â†’ é¢„å¤„ç† â”€â”€â†’ NPUæ¨ç† â”€â”€â†’ åå¤„ç† â”€â”€â†’ ROSå‘å¸ƒ â”€â”€â†’ æ˜¾ç¤º            â”‚
â”‚      â”‚          â”‚          â”‚          â”‚          â”‚          â”‚               â”‚
â”‚     3.2        2.1        8.2        1.5        0.8        3.0   (ms)       â”‚
â”‚      â”‚          â”‚          â”‚          â”‚          â”‚          â”‚               â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                              â”‚
â”‚   æ€»å»¶è¿Ÿ: 18.8ms (çº¦53 FPSç«¯åˆ°ç«¯)                                             â”‚
â”‚                                                                              â”‚
â”‚   å»¶è¿Ÿåˆ†å¸ƒ:                                                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚ é‡‡é›† â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                                    17.0%      â”‚            â”‚
â”‚   â”‚ é¢„å¤„ç† â–ˆâ–ˆâ–ˆâ–ˆâ–                                   11.2%      â”‚            â”‚
â”‚   â”‚ æ¨ç† â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                    43.6%      â”‚            â”‚
â”‚   â”‚ åå¤„ç† â–ˆâ–ˆâ–ˆ                                     8.0%       â”‚            â”‚
â”‚   â”‚ å‘å¸ƒ â–ˆâ–ˆ                                        4.3%       â”‚            â”‚
â”‚   â”‚ æ˜¾ç¤º â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                    16.0%      â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸åŒåˆ†è¾¨ç‡ä¸‹çš„æ€§èƒ½

| è¾“å…¥åˆ†è¾¨ç‡ | æ¨ç†æ—¶é—´ | FPS | å†…å­˜å ç”¨ |
|:----------:|:--------:|:---:|:--------:|
| 128Ã—128 | 3.8ms | 263 | 42MB |
| **224Ã—224** | **8.2ms** | **122** | **68MB** |
| 320Ã—320 | 16.5ms | 61 | 112MB |
| 480Ã—480 | 35.2ms | 28 | 198MB |

### èµ„æºå ç”¨

#### å†…å­˜å ç”¨

| èµ„æºç±»å‹ | å ç”¨é‡ | è¯´æ˜ |
|:---------|:------:|:-----|
| æ¨¡å‹æ–‡ä»¶ (.rknn) | 8.3 MB | INT8é‡åŒ–åå¤§å° |
| NPUå†…å­˜ | ~68 MB | è¿è¡Œæ—¶æ˜¾å­˜å ç”¨ |
| CPUå†…å­˜ | ~120 MB | Pythonè¿›ç¨‹å†…å­˜ |
| å…±äº«å†…å­˜ | ~45 MB | ROSå›¾åƒä¼ è¾“ |

#### CPUå ç”¨ç‡

```
ç³»ç»Ÿèµ„æºç›‘æ§ï¼ˆè¿è¡ŒU-NetèŠ‚ç‚¹æ—¶ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CPU:  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   15%    â”‚
â”‚ NPU:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   45%    â”‚
â”‚ RAM:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   28%    â”‚
â”‚ Temp: 52Â°C (æ­£å¸¸è¿è¡Œæ¸©åº¦)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| è¿›ç¨‹ | CPUå ç”¨ | è¯´æ˜ |
|:-----|:-------:|:-----|
| unet_ros_node.py | 8-12% | ä¸»è¦æ˜¯é¢„/åå¤„ç† |
| rknn_server | 3-5% | NPUé©±åŠ¨è¿›ç¨‹ |
| roscore | 1-2% | ROSä¸»èŠ‚ç‚¹ |
| åˆè®¡ | ~15% | å¯åŒæ—¶è¿è¡Œå…¶ä»–èŠ‚ç‚¹ |

#### åŠŸè€—ä¼°ç®—

| ç»„ä»¶ | åŠŸè€— | å æ¯” |
|:-----|:----:|:----:|
| NPU (INT8æ¨ç†) | ~1.5W | 30% |
| CPU (é¢„å¤„ç†) | ~0.8W | 16% |
| å†…å­˜ | ~0.5W | 10% |
| å…¶ä»– | ~2.2W | 44% |
| **æ€»è®¡** | **~5W** | 100% |

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

| ä¼˜åŒ–æ–¹å‘ | æ–¹æ³• | é¢„æœŸæå‡ |
|:---------|:-----|:--------:|
| åˆ†è¾¨ç‡ä¼˜åŒ– | é™è‡³128Ã—128 | +115% FPS |
| æ‰¹å¤„ç† | batch_size=2 | +30% ååé‡ |
| å¼‚æ­¥æ¨ç† | æµæ°´çº¿å¤„ç† | -40% å»¶è¿Ÿ |
| æ¨¡å‹å‰ªæ | é€šé“å‰ªæ50% | +50% FPS |

```python
# å¼‚æ­¥æ¨ç†ç¤ºä¾‹ï¼ˆå‡å°‘ç«¯åˆ°ç«¯å»¶è¿Ÿï¼‰
import threading
from queue import Queue

class AsyncInference:
    def __init__(self, model):
        self.model = model
        self.input_queue = Queue(maxsize=2)
        self.output_queue = Queue(maxsize=2)
        self.thread = threading.Thread(target=self._inference_loop)
        self.thread.daemon = True
        self.thread.start()
    
    def _inference_loop(self):
        while True:
            frame = self.input_queue.get()
            result = self.model.inference(frame)
            self.output_queue.put(result)
    
    def async_predict(self, frame):
        self.input_queue.put(frame)
    
    def get_result(self):
        return self.output_queue.get()
```

---

## å¸¸è§é—®é¢˜

### Q1: æ¨¡å‹æ¨ç†é€Ÿåº¦æ…¢ï¼Ÿ

**é—®é¢˜ç°è±¡**ï¼šæ¨ç†é€Ÿåº¦è¿œä½äºé¢„æœŸçš„122 FPSï¼Œå®é™…åªæœ‰åå‡ FPSç”šè‡³æ›´ä½ã€‚

**æ’æŸ¥æ­¥éª¤**ï¼š

#### 1. ç¡®è®¤æ˜¯å¦ä½¿ç”¨äº†NPU

```bash
# æŸ¥çœ‹NPUé©±åŠ¨æ˜¯å¦åŠ è½½
lsmod | grep rknpu

# é¢„æœŸè¾“å‡ºï¼š
# rknpu                 xxx  0
```

å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œéœ€è¦åŠ è½½NPUé©±åŠ¨ï¼š
```bash
sudo modprobe rknpu
```

#### 2. æ£€æŸ¥æ¨¡å‹é‡åŒ–ç±»å‹

```python
# æŸ¥çœ‹æ¨¡å‹ä¿¡æ¯
from rknn.api import RKNN
rknn = RKNN()
rknn.load_rknn('lane_unet_803.rknn')

# æ‰“å°æ¨¡å‹ä¿¡æ¯ï¼Œç¡®è®¤æ˜¯INT8é‡åŒ–
print(rknn.get_sdk_version())
```

| é‡åŒ–ç±»å‹ | é¢„æœŸFPS | å¸¸è§åŸå›  |
|:--------:|:-------:|:---------|
| INT8 | 120+ | æ­£å¸¸ |
| FP16 | 60-70 | è½¬æ¢æ—¶æœªæŒ‡å®šINT8 |
| FP32 | 10-15 | åœ¨CPUä¸Šè¿è¡Œ |

#### 3. æ£€æŸ¥æ˜¯å¦å¼€å¯äº†è°ƒè¯•æ¨¡å¼

```python
# é”™è¯¯ç¤ºä¾‹ - æ€§èƒ½æ¨¡å¼è¢«ç¦ç”¨
rknn.init_runtime(target='rk3588', perf_debug=True)  # âŒ ä¼šé™é€Ÿ

# æ­£ç¡®ç¤ºä¾‹
rknn.init_runtime(target='rk3588', perf_debug=False)  # âœ…
```

#### 4. æ£€æŸ¥NPUå ç”¨å†²çª

```bash
# æŸ¥çœ‹æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹å ç”¨NPU
ps aux | grep rknn

# å¦‚æœæœ‰å¤šä¸ªRKNNè¿›ç¨‹ï¼Œå¯èƒ½å­˜åœ¨èµ„æºç«äº‰
# è§£å†³æ–¹æ¡ˆï¼šåœæ­¢å…¶ä»–RKNNè¿›ç¨‹
```

#### 5. å›¾åƒé¢„å¤„ç†ä¼˜åŒ–

```python
# æ…¢é€Ÿé¢„å¤„ç† âŒ
img = cv2.imread(path)
img = cv2.resize(img, (224, 224))
img = img.astype(np.float32) / 255.0  # ä¸å¿…è¦çš„å½’ä¸€åŒ–

# å¿«é€Ÿé¢„å¤„ç† âœ…
img = cv2.imread(path)
img = cv2.resize(img, (224, 224), interpolation=cv2.INTER_LINEAR)
# é‡åŒ–æ¨¡å‹å·²åŒ…å«å½’ä¸€åŒ–ï¼Œç›´æ¥ä½¿ç”¨uint8
```

#### 6. æ€§èƒ½è¯Šæ–­ä»£ç 

```python
import time

class PerformanceProfiler:
    def __init__(self):
        self.times = {}
    
    def start(self, name):
        self.times[name] = time.time()
    
    def end(self, name):
        elapsed = (time.time() - self.times[name]) * 1000
        print(f"{name}: {elapsed:.2f}ms")
        return elapsed

# ä½¿ç”¨ç¤ºä¾‹
profiler = PerformanceProfiler()

profiler.start("preprocess")
# ... é¢„å¤„ç†ä»£ç  ...
profiler.end("preprocess")

profiler.start("inference")
# ... æ¨ç†ä»£ç  ...
profiler.end("inference")

profiler.start("postprocess")
# ... åå¤„ç†ä»£ç  ...
profiler.end("postprocess")
```

**å¸¸è§åŸå› æ€»ç»“**ï¼š

| åŸå›  | è§£å†³æ–¹æ¡ˆ | é¢„æœŸæå‡ |
|:-----|:---------|:--------:|
| ä½¿ç”¨FP16/FP32æ¨¡å‹ | é‡æ–°è½¬æ¢ä¸ºINT8 | 2-10å€ |
| NPUé©±åŠ¨æœªåŠ è½½ | `modprobe rknpu` | 10å€+ |
| å›¾åƒé‡å¤ç¼©æ”¾ | ç¼“å­˜é¢„å¤„ç†ç»“æœ | 20-30% |
| åŒæ­¥æ¨ç†é˜»å¡ | æ”¹ç”¨å¼‚æ­¥æ¨ç† | 30-50% |
| é¢‘ç¹æ‰“å°æ—¥å¿— | å…³é—­debugè¾“å‡º | 10-20% |

### Q2: æ£€æµ‹æ•ˆæœä¸ä½³ï¼Ÿ

**é—®é¢˜ç°è±¡**ï¼šè½¦é“çº¿æ£€æµ‹ä¸å®Œæ•´ã€æœ‰å¤§é‡å™ªç‚¹ã€æˆ–å®Œå…¨æ£€æµ‹ä¸åˆ°ã€‚

**æ’æŸ¥æ­¥éª¤**ï¼š

#### 1. æ£€æŸ¥è¾“å…¥å›¾åƒè´¨é‡

```python
# è¯Šæ–­è„šæœ¬ï¼šæ£€æŸ¥è¾“å…¥å›¾åƒ
import cv2
import numpy as np

def diagnose_input_image(img):
    """è¯Šæ–­è¾“å…¥å›¾åƒè´¨é‡"""
    print(f"å›¾åƒå°ºå¯¸: {img.shape}")
    print(f"æ•°æ®ç±»å‹: {img.dtype}")
    print(f"åƒç´ èŒƒå›´: [{img.min()}, {img.max()}]")
    print(f"å¹³å‡äº®åº¦: {img.mean():.1f}")
    
    # æ£€æŸ¥æ˜¯å¦è¿‡æš—æˆ–è¿‡äº®
    if img.mean() < 50:
        print("âš ï¸ è­¦å‘Š: å›¾åƒè¿‡æš—ï¼Œå¯èƒ½å½±å“æ£€æµ‹")
    elif img.mean() > 200:
        print("âš ï¸ è­¦å‘Š: å›¾åƒè¿‡äº®/è¿‡æ›")
    else:
        print("âœ… å›¾åƒäº®åº¦æ­£å¸¸")
    
    # æ£€æŸ¥æ˜¯å¦æ¨¡ç³Š
    laplacian = cv2.Laplacian(cv2.cvtColor(img, cv2.COLOR_BGR2GRAY), cv2.CV_64F)
    sharpness = laplacian.var()
    print(f"æ¸…æ™°åº¦æŒ‡æ ‡: {sharpness:.1f}")
    if sharpness < 100:
        print("âš ï¸ è­¦å‘Š: å›¾åƒå¯èƒ½æ¨¡ç³Š")

# ä½¿ç”¨
img = cv2.imread("test.jpg")
diagnose_input_image(img)
```

#### 2. è°ƒæ•´äºŒå€¼åŒ–é˜ˆå€¼

```
é˜ˆå€¼æ•ˆæœå¯¹æ¯”:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚  threshold=0.3          threshold=0.5          threshold=0.7               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚           â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚           â”‚   â–ˆâ–ˆâ–ˆâ–ˆ   â”‚                â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚           â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚           â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚                â”‚
â”‚  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚           â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚           â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚  æ£€æµ‹å¤šä½†å™ªç‚¹å¤š          å¹³è¡¡æ•ˆæœ                ç²¾ç¡®ä½†å¯èƒ½æ–­è£‚              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```bash
# å°è¯•ä¸åŒé˜ˆå€¼
rosrun rknn_pkg unet_ros_node.py _threshold:=0.3  # æ›´å®½æ¾
rosrun rknn_pkg unet_ros_node.py _threshold:=0.7  # æ›´ä¸¥æ ¼
```

#### 3. ç¡®è®¤æ¨¡å‹ä¸åœºæ™¯åŒ¹é…

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:-----|:---------|:---------|
| ç›´é“æ­£å¸¸ï¼Œå¼¯é“å·® | è®­ç»ƒæ•°æ®å¼¯é“å°‘ | å¢åŠ å¼¯é“æ•°æ®é‡æ–°è®­ç»ƒ |
| ç™½çº¿æ­£å¸¸ï¼Œé»„çº¿å·® | è®­ç»ƒé›†é¢œè‰²å•ä¸€ | æ·»åŠ å¤šé¢œè‰²è½¦é“çº¿æ•°æ® |
| å®¤å†…æ­£å¸¸ï¼Œå®¤å¤–å·® | å…‰ç…§å·®å¼‚å¤§ | æ•°æ®å¢å¼ºæˆ–æ··åˆè®­ç»ƒ |
| è¿‘å¤„æ­£å¸¸ï¼Œè¿œå¤„å·® | åˆ†è¾¨ç‡é™åˆ¶ | æé«˜è¾“å…¥åˆ†è¾¨ç‡ |

#### 4. æ£€æŸ¥é€è§†å˜æ¢å‚æ•°

å¦‚æœä½¿ç”¨äº†IPMï¼ˆé€†é€è§†å˜æ¢ï¼‰ï¼Œç¡®ä¿å‚æ•°ä¸å®é™…æ‘„åƒå¤´å®‰è£…åŒ¹é…ï¼š

```python
# æ£€æŸ¥é€è§†å˜æ¢ç‚¹æ˜¯å¦æ­£ç¡®
src_points = np.float32([
    [120, 180],   # å·¦ä¸Š
    [520, 180],   # å³ä¸Š
    [640, 400],   # å³ä¸‹
    [0, 400]      # å·¦ä¸‹
])

dst_points = np.float32([
    [0, 0],
    [224, 0],
    [224, 224],
    [0, 224]
])

# å¯è§†åŒ–å˜æ¢åŒºåŸŸ
img_with_roi = img.copy()
cv2.polylines(img_with_roi, [src_points.astype(int)], True, (0, 255, 0), 2)
cv2.imshow("ROI", img_with_roi)
```

#### 5. æ¨¡å‹è¾“å‡ºå¯è§†åŒ–è°ƒè¯•

```python
import matplotlib.pyplot as plt

def visualize_output(img, mask, threshold=0.5):
    """å¯è§†åŒ–æ¨¡å‹è¾“å‡º"""
    fig, axes = plt.subplots(1, 4, figsize=(16, 4))
    
    # åŸå›¾
    axes[0].imshow(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))
    axes[0].set_title("Input")
    
    # åŸå§‹æ¦‚ç‡å›¾
    axes[1].imshow(mask, cmap='jet')
    axes[1].set_title(f"Raw Output (max={mask.max():.3f})")
    
    # äºŒå€¼åŒ–ç»“æœ
    binary = (mask > threshold).astype(np.uint8) * 255
    axes[2].imshow(binary, cmap='gray')
    axes[2].set_title(f"Binary (th={threshold})")
    
    # å åŠ æ˜¾ç¤º
    overlay = img.copy()
    overlay[binary > 0] = [0, 255, 0]
    blended = cv2.addWeighted(img, 0.7, overlay, 0.3, 0)
    axes[3].imshow(cv2.cvtColor(blended, cv2.COLOR_BGR2RGB))
    axes[3].set_title("Overlay")
    
    plt.tight_layout()
    plt.savefig("debug_output.png")
    plt.show()
```

#### 6. å¸¸è§é—®é¢˜é€ŸæŸ¥

| ç°è±¡ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:-----|:-----|:---------|
| å®Œå…¨æ£€æµ‹ä¸åˆ° | è¾“å…¥æ ¼å¼é”™è¯¯ | æ£€æŸ¥BGR/RGBã€å°ºå¯¸ |
| å…¨å›¾å˜ç™½ | é˜ˆå€¼è¿‡ä½ | æé«˜thresholdåˆ°0.6+ |
| å¤§é‡å™ªç‚¹ | æ¨¡å‹æ¬ æ‹Ÿåˆæˆ–é˜ˆå€¼è¿‡ä½ | é‡æ–°è®­ç»ƒ/æé«˜é˜ˆå€¼ |
| è½¦é“çº¿æ–­æ–­ç»­ç»­ | é˜ˆå€¼è¿‡é«˜æˆ–å…‰ç…§ä¸å‡ | é™ä½é˜ˆå€¼/æ•°æ®å¢å¼º |
| æ£€æµ‹åç§» | é€è§†å˜æ¢å‚æ•°ä¸åŒ¹é… | é‡æ–°æ ‡å®šç›¸æœº |
| è¯¯æ£€å…¶ä»–çº¿æ¡ | è®­ç»ƒæ•°æ®ä¸å¤Ÿå¤šæ · | æ·»åŠ è´Ÿæ ·æœ¬è®­ç»ƒ |

#### 7. å¿«é€Ÿæµ‹è¯•è„šæœ¬

```python
#!/usr/bin/env python3
"""å¿«é€Ÿæµ‹è¯•æ¨¡å‹æ•ˆæœ"""
import cv2
import numpy as np
from rknnlite.api import RKNNLite

def quick_test(model_path, image_path, threshold=0.5):
    # åŠ è½½æ¨¡å‹
    rknn = RKNNLite()
    rknn.load_rknn(model_path)
    rknn.init_runtime(target='rk3588')
    
    # è¯»å–å¹¶é¢„å¤„ç†
    img = cv2.imread(image_path)
    img_resized = cv2.resize(img, (224, 224))
    
    # æ¨ç†
    outputs = rknn.inference(inputs=[img_resized])
    mask = outputs[0].squeeze()
    
    # è¾“å‡ºè¯Šæ–­ä¿¡æ¯
    print(f"è¾“å‡ºå½¢çŠ¶: {mask.shape}")
    print(f"è¾“å‡ºèŒƒå›´: [{mask.min():.4f}, {mask.max():.4f}]")
    print(f"å‡å€¼: {mask.mean():.4f}")
    print(f"é«˜äºé˜ˆå€¼çš„åƒç´ æ¯”ä¾‹: {(mask > threshold).mean()*100:.1f}%")
    
    # ä¿å­˜ç»“æœ
    binary = ((mask > threshold) * 255).astype(np.uint8)
    cv2.imwrite("test_result.png", binary)
    print("ç»“æœå·²ä¿å­˜åˆ° test_result.png")
    
    rknn.release()

if __name__ == "__main__":
    quick_test(
        model_path="/home/ucar/ucar_ws/src/rknn_pkg/model/lane_unet_803.rknn",
        image_path="test.jpg",
        threshold=0.5
    )
```

### Q3: RKNNè½¬æ¢å¤±è´¥ï¼Ÿ

**é—®é¢˜ç°è±¡**ï¼šONNXæ¨¡å‹è½¬æ¢ä¸ºRKNNæ ¼å¼æ—¶æŠ¥é”™ã€‚

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**ï¼š

#### é”™è¯¯1: ä¸æ”¯æŒçš„ç®—å­

```
E RKNN: [xx:xx:xx.xxx] Unsupported op: xxx
```

**åŸå› **ï¼šæ¨¡å‹åŒ…å«RKNN-Toolkitä¸æ”¯æŒçš„ç®—å­

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# æ–¹æ¡ˆ1: å¯¼å‡ºONNXæ—¶æŒ‡å®šè¾ƒä½çš„opsetç‰ˆæœ¬
torch.onnx.export(
    model, dummy_input, "model.onnx",
    opset_version=12,  # å°è¯•11ã€12ã€13
    ...
)

# æ–¹æ¡ˆ2: æ›¿æ¢ä¸æ”¯æŒçš„ç®—å­
# å¸¸è§ä¸æ”¯æŒç®—å­åŠæ›¿ä»£æ–¹æ¡ˆï¼š
```

| ä¸æ”¯æŒç®—å­ | æ›¿ä»£æ–¹æ¡ˆ |
|:-----------|:---------|
| `nn.SiLU` | `nn.ReLU` æˆ–è‡ªå®šä¹‰ `x * torch.sigmoid(x)` |
| `nn.Hardswish` | `x * F.relu6(x + 3) / 6` |
| `F.interpolate(mode='bicubic')` | æ”¹ç”¨ `mode='bilinear'` |
| `torch.einsum` | å±•å¼€ä¸ºçŸ©é˜µä¹˜æ³• |
| `nn.InstanceNorm` | æ”¹ç”¨ `nn.BatchNorm` |

```python
# SiLUæ›¿ä»£ç¤ºä¾‹
class SiLU(nn.Module):
    def forward(self, x):
        return x * torch.sigmoid(x)

# åœ¨æ¨¡å‹ä¸­æ›¿æ¢
# self.act = nn.SiLU()  # åŸå§‹
self.act = SiLU()       # æ›¿æ¢
```

#### é”™è¯¯2: å½¢çŠ¶æ¨æ–­å¤±è´¥

```
E RKNN: [xx:xx:xx.xxx] Shape inference failed
```

**åŸå› **ï¼šåŠ¨æ€shapeæˆ–æœªçŸ¥ç»´åº¦

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# å¯¼å‡ºæ—¶å›ºå®šè¾“å…¥å°ºå¯¸
dummy_input = torch.randn(1, 3, 224, 224)  # æ˜ç¡®æŒ‡å®šbatch=1

torch.onnx.export(
    model, dummy_input, "model.onnx",
    input_names=['input'],
    output_names=['output'],
    dynamic_axes=None,  # ä¸ä½¿ç”¨åŠ¨æ€ç»´åº¦
    ...
)
```

#### é”™è¯¯3: é‡åŒ–æ ¡å‡†å¤±è´¥

```
E RKNN: Quantization calibration failed
W RKNN: Accuracy may be affected
```

**åŸå› **ï¼šæ ¡å‡†æ•°æ®ä¸åˆé€‚æˆ–æ•°é‡ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# ç¡®ä¿æ ¡å‡†æ•°æ®å¤šæ ·ä¸”å…·æœ‰ä»£è¡¨æ€§
dataset = [
    'calibration/normal_01.jpg',
    'calibration/dark_01.jpg',
    'calibration/bright_01.jpg',
    'calibration/curve_01.jpg',
    # ... è‡³å°‘50-100å¼ è¦†ç›–å„ç§åœºæ™¯
]

# å°†è·¯å¾„å†™å…¥æ–‡æœ¬æ–‡ä»¶
with open('dataset.txt', 'w') as f:
    for img_path in dataset:
        f.write(img_path + '\n')

# ä½¿ç”¨æ—¶
rknn.config(
    quantized_dtype='asymmetric_quantized-8',
    quantized_algorithm='normal',  # æˆ– 'mmse'
    ...
)
rknn.build(do_quantization=True, dataset='dataset.txt')
```

#### é”™è¯¯4: å†…å­˜ä¸è¶³

```
E RKNN: Out of memory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# å¢åŠ ç³»ç»Ÿswap
sudo fallocate -l 8G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æˆ–åœ¨è½¬æ¢è„šæœ¬ä¸­é™åˆ¶å†…å­˜
export MALLOC_TRIM_THRESHOLD_=65536
python convert.py
```

#### é”™è¯¯5: ONNXæ¨¡å‹éªŒè¯å¤±è´¥

```
E RKNN: ONNX model check failed
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```python
# å…ˆç”¨onnxåº“æ ¡éªŒ
import onnx

model = onnx.load("model.onnx")
onnx.checker.check_model(model)

# ç®€åŒ–ONNXæ¨¡å‹
import onnxsim
model_simplified, check = onnxsim.simplify(model)
onnx.save(model_simplified, "model_simplified.onnx")

# ä½¿ç”¨ç®€åŒ–åçš„æ¨¡å‹è½¬æ¢
rknn.load_onnx(model='model_simplified.onnx')
```

#### è½¬æ¢è°ƒè¯•æ¸…å•

```
RKNNè½¬æ¢å¤±è´¥æ’æŸ¥æ¸…å•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¡ 1. RKNN-Toolkitç‰ˆæœ¬æ˜¯å¦åŒ¹é…ç›®æ ‡å¹³å°ï¼Ÿ                         â”‚
â”‚      - RK3588éœ€è¦ RKNN-Toolkit2 >= 1.5.0                       â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 2. ONNXæ¨¡å‹æ˜¯å¦å¯ä»¥æ­£å¸¸åŠ è½½ï¼Ÿ                                 â”‚
â”‚      - è¿è¡Œ onnx.checker.check_model()                         â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 3. æ˜¯å¦ä½¿ç”¨äº†onnx-simplifierï¼Ÿ                                â”‚
â”‚      - pip install onnx-simplifier                              â”‚
â”‚      - python -m onnxsim input.onnx output.onnx                 â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 4. opsetç‰ˆæœ¬æ˜¯å¦åˆé€‚ï¼Ÿ                                        â”‚
â”‚      - å»ºè®®ä½¿ç”¨opset 11-13                                      â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 5. æ˜¯å¦æœ‰ä¸æ”¯æŒçš„ç®—å­ï¼Ÿ                                       â”‚
â”‚      - æŸ¥çœ‹RKNNæ”¯æŒç®—å­åˆ—è¡¨                                     â”‚
â”‚      - æ›¿æ¢æˆ–ç®€åŒ–ä¸æ”¯æŒçš„ç®—å­                                   â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 6. æ ¡å‡†æ•°æ®é›†æ˜¯å¦è¶³å¤Ÿï¼Ÿ                                       â”‚
â”‚      - è‡³å°‘50å¼ ï¼Œè¦†ç›–å„ç§åœºæ™¯                                   â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 7. è½¬æ¢ç¯å¢ƒå†…å­˜æ˜¯å¦å……è¶³ï¼Ÿ                                     â”‚
â”‚      - å»ºè®®è‡³å°‘8GB RAM                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´è½¬æ¢è„šæœ¬ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰

```python
#!/usr/bin/env python3
"""å¸¦å®Œå–„é”™è¯¯å¤„ç†çš„RKNNè½¬æ¢è„šæœ¬"""
import os
import sys
from rknn.api import RKNN

def convert_to_rknn(onnx_path, rknn_path, dataset_path):
    rknn = RKNN(verbose=True)
    
    # Step 1: é…ç½®
    print("Step 1: Configuring...")
    ret = rknn.config(
        mean_values=[[127.5, 127.5, 127.5]],
        std_values=[[127.5, 127.5, 127.5]],
        target_platform='rk3588',
        quantized_dtype='asymmetric_quantized-8',
        optimization_level=3
    )
    if ret != 0:
        print(f"âŒ Config failed with code {ret}")
        return False
    
    # Step 2: åŠ è½½ONNX
    print("Step 2: Loading ONNX...")
    ret = rknn.load_onnx(model=onnx_path)
    if ret != 0:
        print(f"âŒ Load ONNX failed with code {ret}")
        print("æç¤º: å°è¯•ä½¿ç”¨onnx-simplifierç®€åŒ–æ¨¡å‹")
        return False
    
    # Step 3: æ„å»º
    print("Step 3: Building (this may take a while)...")
    ret = rknn.build(do_quantization=True, dataset=dataset_path)
    if ret != 0:
        print(f"âŒ Build failed with code {ret}")
        print("æç¤º: æ£€æŸ¥æ ¡å‡†æ•°æ®é›†æ˜¯å¦æ­£ç¡®")
        return False
    
    # Step 4: å¯¼å‡º
    print("Step 4: Exporting...")
    ret = rknn.export_rknn(rknn_path)
    if ret != 0:
        print(f"âŒ Export failed with code {ret}")
        return False
    
    print(f"âœ… è½¬æ¢æˆåŠŸ: {rknn_path}")
    
    # æ‰“å°æ¨¡å‹ä¿¡æ¯
    print("\næ¨¡å‹ä¿¡æ¯:")
    print(f"  æ–‡ä»¶å¤§å°: {os.path.getsize(rknn_path) / 1024 / 1024:.2f} MB")
    
    rknn.release()
    return True

if __name__ == "__main__":
    success = convert_to_rknn(
        onnx_path="lane_unet.onnx",
        rknn_path="lane_unet.rknn",
        dataset_path="dataset.txt"
    )
    sys.exit(0 if success else 1)
```

### Q4: ROSèŠ‚ç‚¹å¯åŠ¨æŠ¥é”™ï¼Ÿ

**é—®é¢˜ç°è±¡**ï¼šè¿è¡Œ `rosrun rknn_pkg unet_ros_node.py` æ—¶æŠ¥é”™ã€‚

**å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**ï¼š

#### é”™è¯¯1: æ¨¡å‹æ–‡ä»¶æ‰¾ä¸åˆ°

```
[ERROR] Model file not found: /path/to/model.rknn
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /home/ucar/ucar_ws/src/rknn_pkg/model/

# ç¡®è®¤è·¯å¾„æ­£ç¡®
rosrun rknn_pkg unet_ros_node.py _model_path:=/home/ucar/ucar_ws/src/rknn_pkg/model/lane_unet_803.rknn

# æˆ–ä½¿ç”¨$(find ...)è¯­æ³•
roslaunch rknn_pkg mask.launch model_path:=$(rospack find rknn_pkg)/model/lane_unet_803.rknn
```

#### é”™è¯¯2: RKNNè¿è¡Œæ—¶åˆå§‹åŒ–å¤±è´¥

```
E RKNNLITE: rknn_init failed, ret=-1
```

**åŸå› åŠè§£å†³æ–¹æ¡ˆ**ï¼š

| é”™è¯¯ç  | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|:------:|:-----|:---------|
| -1 | é€šç”¨é”™è¯¯ | æ£€æŸ¥æ¨¡å‹æ–‡ä»¶å®Œæ•´æ€§ |
| -2 | å†…å­˜ä¸è¶³ | é‡Šæ”¾å…¶ä»–è¿›ç¨‹å†…å­˜ |
| -3 | NPUé©±åŠ¨é—®é¢˜ | `sudo modprobe rknpu` |
| -4 | æ¨¡å‹ä¸å…¼å®¹ | é‡æ–°è½¬æ¢æ¨¡å‹ |

```bash
# æ£€æŸ¥NPUé©±åŠ¨
lsmod | grep rknpu

# é‡æ–°åŠ è½½é©±åŠ¨
sudo rmmod rknpu
sudo modprobe rknpu

# æ£€æŸ¥NPUè®¾å¤‡
ls -la /dev/dri/
```

#### é”™è¯¯3: cv_bridgeå¯¼å…¥å¤±è´¥

```
ImportError: No module named cv_bridge
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ–¹æ¡ˆ1: å®‰è£…cv_bridge
sudo apt install ros-noetic-cv-bridge

# æ–¹æ¡ˆ2: ä»æºç ç¼–è¯‘ï¼ˆå¦‚æœä¸OpenCVç‰ˆæœ¬ä¸å…¼å®¹ï¼‰
cd ~/catkin_ws/src
git clone https://github.com/ros-perception/vision_opencv.git
cd ..
catkin_make

# æ–¹æ¡ˆ3: ä½¿ç”¨Python3
sudo apt install python3-opencv
pip3 install opencv-python
```

#### é”™è¯¯4: è¯é¢˜è®¢é˜…ä¸åˆ°æ•°æ®

```
[WARN] No messages received on /image_rect_color
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥è¯é¢˜æ˜¯å¦å­˜åœ¨
rostopic list | grep image

# æ£€æŸ¥è¯é¢˜æ•°æ®
rostopic hz /image_rect_color
rostopic echo /image_rect_color --noarr | head -20

# å¦‚æœè¯é¢˜åä¸åŒï¼ŒæŒ‡å®šæ­£ç¡®çš„è¾“å…¥è¯é¢˜
rosrun rknn_pkg unet_ros_node.py _input_topic:=/camera/image_raw

# æ£€æŸ¥æ‘„åƒå¤´èŠ‚ç‚¹æ˜¯å¦è¿è¡Œ
rosnode list | grep cam
```

#### é”™è¯¯5: Pythonæƒé™/è·¯å¾„é—®é¢˜

```
/usr/bin/env: 'python3': No such file or directory
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥Python3ä½ç½®
which python3

# è½¯é“¾æ¥
sudo ln -s /usr/bin/python3 /usr/bin/python

# æˆ–ä¿®æ”¹è„šæœ¬ç¬¬ä¸€è¡Œ
#!/usr/bin/python3  # ä½¿ç”¨ç»å¯¹è·¯å¾„

# ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
chmod +x /home/ucar/ucar_ws/src/rknn_pkg/src/unet_ros_node.py
```

#### é”™è¯¯6: rknnliteæ¨¡å—æ‰¾ä¸åˆ°

```
ModuleNotFoundError: No module named 'rknnlite'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š

```bash
# æ£€æŸ¥æ˜¯å¦å®‰è£…
pip3 list | grep rknn

# å®‰è£…rknn-toolkit-lite2ï¼ˆæ¿ç«¯æ¨ç†ï¼‰
pip3 install rknn-toolkit-lite2

# æˆ–ä»å®˜æ–¹åŒ…å®‰è£…
# ä¸‹è½½: https://github.com/rockchip-linux/rknn-toolkit2
cd rknn-toolkit-lite2/packages/
pip3 install rknn_toolkit_lite2-*-cp38-cp38-linux_aarch64.whl
```

#### å¯åŠ¨è°ƒè¯•æ¸…å•

```
ROSèŠ‚ç‚¹å¯åŠ¨æ’æŸ¥æ¸…å•:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¡ 1. roscoreæ˜¯å¦è¿è¡Œï¼Ÿ                                          â”‚
â”‚      - roscore                                                  â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 2. å·¥ä½œç©ºé—´æ˜¯å¦sourceï¼Ÿ                                        â”‚
â”‚      - source ~/ucar_ws/devel/setup.bash                        â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 3. è„šæœ¬æ˜¯å¦å¯æ‰§è¡Œï¼Ÿ                                            â”‚
â”‚      - chmod +x unet_ros_node.py                                â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 4. æ¨¡å‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Ÿ                                          â”‚
â”‚      - ls -la $(rospack find rknn_pkg)/model/                   â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 5. è¾“å…¥è¯é¢˜æ˜¯å¦æœ‰æ•°æ®ï¼Ÿ                                        â”‚
â”‚      - rostopic hz /image_rect_color                            â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 6. Pythonä¾èµ–æ˜¯å¦å®‰è£…ï¼Ÿ                                        â”‚
â”‚      - pip3 list | grep -E "rknn|opencv|numpy"                  â”‚
â”‚                                                                 â”‚
â”‚ â–¡ 7. NPUé©±åŠ¨æ˜¯å¦åŠ è½½ï¼Ÿ                                           â”‚
â”‚      - lsmod | grep rknpu                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å®Œæ•´å¯åŠ¨æµç¨‹

```bash
# 1. å¯åŠ¨ROSæ ¸å¿ƒ
roscore &

# 2. Sourceå·¥ä½œç©ºé—´
source /home/ucar/ucar_ws/devel/setup.bash

# 3. å¯åŠ¨æ‘„åƒå¤´ï¼ˆå¦‚æœªå¯åŠ¨ï¼‰
roslaunch usb_cam usb_cam-test.launch &

# 4. éªŒè¯å›¾åƒè¯é¢˜
rostopic hz /image_rect_color
# åº”æ˜¾ç¤ºçº¦30Hz

# 5. å¯åŠ¨U-NetèŠ‚ç‚¹
rosrun rknn_pkg unet_ros_node.py

# 6. éªŒè¯è¾“å‡º
rostopic hz /mask
# åº”æ˜¾ç¤ºçº¦30Hz

# æˆ–ä¸€é”®å¯åŠ¨
roslaunch rknn_pkg mask.launch
```

#### æ—¥å¿—çº§åˆ«è°ƒæ•´

```python
# åœ¨èŠ‚ç‚¹ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
import rospy
rospy.init_node('unet_ros_node', log_level=rospy.DEBUG)

# æˆ–é€šè¿‡å‘½ä»¤è¡Œ
rosrun rknn_pkg unet_ros_node.py --ros-debug
```

```bash
# æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—
rosrun rqt_console rqt_console
```

---

## æ›´æ–°æ—¥å¿—

æ‰€æœ‰ç‰ˆæœ¬æ›´æ–°è®°å½•éµå¾ª [è¯­ä¹‰åŒ–ç‰ˆæœ¬](https://semver.org/lang/zh-CN/) è§„èŒƒã€‚

### v1.0.0 (2026-02-09) ğŸ‰

**é¦–æ¬¡æ­£å¼å‘å¸ƒ**

#### âœ¨ æ–°åŠŸèƒ½
- åŸºäºU-Netçš„è½¦é“çº¿è¯­ä¹‰åˆ†å‰²
- RKNN-Toolkit2æ¨¡å‹è½¬æ¢æ”¯æŒ
- INT8é‡åŒ–ï¼ŒRK3588 NPUåŠ é€Ÿæ¨ç†
- ROS NoeticèŠ‚ç‚¹é›†æˆ
- å®Œæ•´çš„è®­ç»ƒã€éƒ¨ç½²ã€ä½¿ç”¨æ–‡æ¡£

#### ğŸ“¦ åŒ…å«å†…å®¹
- é¢„è®­ç»ƒRKNNæ¨¡å‹ (`lane_unet_803.rknn`)
- ROSèŠ‚ç‚¹ (`unet_ros_node.py`)
- Launchæ–‡ä»¶åŠé…ç½®

#### ğŸ“Š æ€§èƒ½æŒ‡æ ‡
- IoU: 0.847
- æ¨ç†é€Ÿåº¦: 122 FPS (RK3588 NPU)
- æ¨¡å‹å¤§å°: 8.3 MB (INT8)

---

### ç‰ˆæœ¬è§„åˆ’

#### v1.1.0 (è®¡åˆ’ä¸­)
- [ ] æ”¯æŒå¤šè½¦é“çº¿åˆ†ç±»æ£€æµ‹
- [ ] æ·»åŠ ç½®ä¿¡åº¦è¾“å‡º
- [ ] ä¼˜åŒ–å¼±å…‰ç¯å¢ƒæ£€æµ‹æ•ˆæœ
- [ ] æ”¯æŒRK3566/RK3568å¹³å°

#### v1.2.0 (è®¡åˆ’ä¸­)
- [ ] æ·»åŠ è½¦é“çº¿æ‹ŸåˆåŠŸèƒ½
- [ ] æ”¯æŒæ›²ç‡ä¼°è®¡è¾“å‡º
- [ ] é›†æˆLaneNetæ¯”è¾ƒåŸºå‡†
- [ ] æ·»åŠ TensorRTéƒ¨ç½²æ”¯æŒ

#### v2.0.0 (é•¿æœŸè§„åˆ’)
- [ ] å¤šä»»åŠ¡å­¦ä¹ ï¼ˆè½¦é“çº¿+å¯è¡Œé©¶åŒºåŸŸï¼‰
- [ ] å®ä¾‹åˆ†å‰²æ”¯æŒ
- [ ] ç«¯åˆ°ç«¯è‡ªåŠ¨é©¾é©¶æ¥å£

---

### è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

```bash
# Fork æœ¬ä»“åº“å
git clone https://github.com/your-username/rknn_pkg.git
cd rknn_pkg

# åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
git checkout -b feature/your-feature

# æäº¤æ›´æ”¹
git add .
git commit -m "feat: add your feature"

# æ¨é€å¹¶åˆ›å»ºPR
git push origin feature/your-feature
```

**æäº¤ä¿¡æ¯è§„èŒƒ**ï¼š
- `feat:` æ–°åŠŸèƒ½
- `fix:` Bugä¿®å¤
- `docs:` æ–‡æ¡£æ›´æ–°
- `perf:` æ€§èƒ½ä¼˜åŒ–
- `refactor:` ä»£ç é‡æ„

---

## é¡¹ç›®ç»“æ„

```
rknn_pkg/
â”‚
â”œâ”€â”€ ğŸ“ docs/                          # æ–‡æ¡£ç›®å½•
â”‚   â””â”€â”€ README.md                     # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ ğŸ“ model/                         # æ¨¡å‹æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ lane_unet_803.rknn           # â­ ä¸»æ¨¡å‹ï¼ˆINT8é‡åŒ–ï¼Œæ¨èä½¿ç”¨ï¼‰
â”‚   â”œâ”€â”€ lane_unet.rknn               # åŸºç¡€ç‰ˆæœ¬æ¨¡å‹
â”‚   â”œâ”€â”€ lane_unet_final.rknn         # æœ€ç»ˆè®­ç»ƒç‰ˆæœ¬
â”‚   â”œâ”€â”€ lane_unet_large.rknn         # å¤§æ¨¡å‹ç‰ˆæœ¬ï¼ˆæ›´é«˜ç²¾åº¦ï¼‰
â”‚   â””â”€â”€ fp.rknn                      # FP16ç‰ˆæœ¬ï¼ˆç”¨äºç²¾åº¦å¯¹æ¯”ï¼‰
â”‚
â”œâ”€â”€ ğŸ“ src/                           # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ unet_ros_node.py             # â­ ROSèŠ‚ç‚¹ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ unet.py                      # U-Netæ¨ç†å¼•æ“å°è£…
â”‚   â”œâ”€â”€ rknpu_inference.py           # RKNNæ¨ç†åº•å±‚æ¥å£
â”‚   â”œâ”€â”€ tool.py                      # å·¥å…·å‡½æ•°ï¼ˆé¢„å¤„ç†ã€åå¤„ç†ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ py_utils/                 # Pythonå·¥å…·æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ rknn_executor.py         # RKNNæ‰§è¡Œå™¨å°è£…
â”‚   â”‚   â””â”€â”€ coco_utils.py            # æ•°æ®é›†å·¥å…·
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ test_code/                # æµ‹è¯•ä»£ç 
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ yolo_detector.py             # YOLOæ£€æµ‹å™¨ï¼ˆç”¨äºç›®æ ‡æ£€æµ‹ï¼‰
â”‚   â”œâ”€â”€ yolo_task.py                 # YOLOä»»åŠ¡èŠ‚ç‚¹
â”‚   â””â”€â”€ run.sh                       # å¿«é€Ÿå¯åŠ¨è„šæœ¬
â”‚
â”œâ”€â”€ ğŸ“ launch/                        # ROS Launchæ–‡ä»¶
â”‚   â”œâ”€â”€ mask.launch                  # â­ U-Netè½¦é“çº¿æ£€æµ‹å¯åŠ¨æ–‡ä»¶
â”‚   â”œâ”€â”€ yolo_debug.launch            # YOLOè°ƒè¯•å¯åŠ¨æ–‡ä»¶
â”‚   â””â”€â”€ ğŸ“ config/                   # Launché…ç½®
â”‚
â”œâ”€â”€ ğŸ“ srv/                           # ROSæœåŠ¡å®šä¹‰
â”‚   â””â”€â”€ *.srv                        # æœåŠ¡æ¶ˆæ¯ç±»å‹
â”‚
â”œâ”€â”€ ğŸ“ test_images/                   # æµ‹è¯•å›¾åƒ
â”‚   â””â”€â”€ *.jpg                        # æµ‹è¯•ç”¨è½¦é“çº¿å›¾åƒ
â”‚
â”œâ”€â”€ CMakeLists.txt                   # CMakeæ„å»ºé…ç½®
â”œâ”€â”€ package.xml                      # ROSåŒ…æè¿°æ–‡ä»¶
â”œâ”€â”€ test.py                          # ç‹¬ç«‹æµ‹è¯•è„šæœ¬
â””â”€â”€ README.md                        # åŒ…æ ¹ç›®å½•è¯´æ˜
```

### æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | åŠŸèƒ½ | é‡è¦æ€§ |
|:-----|:-----|:------:|
| `src/unet_ros_node.py` | ROSèŠ‚ç‚¹ï¼Œè®¢é˜…å›¾åƒå‘å¸ƒæ©ç  | â­â­â­ |
| `src/unet.py` | U-Netæ¨ç†å°è£…ï¼Œæ”¯æŒRKNNåŠ é€Ÿ | â­â­â­ |
| `model/lane_unet_803.rknn` | INT8é‡åŒ–æ¨¡å‹ï¼Œ122FPS | â­â­â­ |
| `launch/mask.launch` | ä¸€é”®å¯åŠ¨é…ç½® | â­â­ |
| `src/py_utils/rknn_executor.py` | RKNNåº•å±‚æ‰§è¡Œå™¨ | â­â­ |
| `src/tool.py` | å›¾åƒé¢„å¤„ç†/åå¤„ç†å·¥å…· | â­ |

### ç›®å½•ç”¨é€”

```
å¼€å‘æµç¨‹ä¸­çš„ç›®å½•ä½¿ç”¨:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   è®­ç»ƒé˜¶æ®µ          è½¬æ¢é˜¶æ®µ          éƒ¨ç½²é˜¶æ®µ                   â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                 â”‚
â”‚   [è®­ç»ƒä»£ç ]   â†’   [model/]    â†’   [src/]                       â”‚
â”‚   (å¤–éƒ¨)           å­˜æ”¾.rknn        ROSèŠ‚ç‚¹                      â”‚
â”‚                                                                 â”‚
â”‚   [æ•°æ®é›†]     â†’   [test_images/]  â†’  [launch/]                 â”‚
â”‚   (å¤–éƒ¨)           éªŒè¯å›¾åƒ           å¯åŠ¨é…ç½®                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¿«é€Ÿå®šä½

- **æƒ³è¿è¡ŒèŠ‚ç‚¹ï¼Ÿ** â†’ `roslaunch rknn_pkg mask.launch`
- **æƒ³ä¿®æ”¹æ¨ç†é€»è¾‘ï¼Ÿ** â†’ [src/unet_ros_node.py](../src/unet_ros_node.py)
- **æƒ³æ›´æ¢æ¨¡å‹ï¼Ÿ** â†’ ä¿®æ”¹ `model_path` å‚æ•°æŒ‡å‘ `model/` ä¸‹çš„å…¶ä»–æ¨¡å‹
- **æƒ³è°ƒæ•´å‚æ•°ï¼Ÿ** â†’ ç¼–è¾‘ [launch/mask.launch](../launch/mask.launch)

---

## è‡´è°¢

### ğŸ“ å­¦æœ¯æœºæ„

[![SYSU](https://img.shields.io/badge/Institution-SYSU-005826?style=flat-square&logo=cplusplus)](https://www.sysu.edu.cn/)
[![Python](https://img.shields.io/badge/Python-3.8%2B-3776AB?style=flat-square&logo=python&logoColor=white)](https://www.python.org/)
[![ROS](https://img.shields.io/badge/ROS-Noetic-22314E?style=flat-square&logo=ros&logoColor=white)](https://www.ros.org/)
[![RKNN](https://img.shields.io/badge/RKNN-Toolkit2-FF6600?style=flat-square)](https://github.com/rockchip-linux/rknn-toolkit2)

æ„Ÿè°¢**ä¸­å±±å¤§å­¦ (Sun Yat-sen University) æ™ºèƒ½å·¥ç¨‹å­¦é™¢** æä¾›çš„å­¦ä¹ èµ„æºå’Œç ”ç©¶ç¯å¢ƒã€‚

### ğŸ‘¤ ä½œè€…

<div align="left">
  <table>
    <tr>
      <td width="60px"><img src="https://github.com/masktrump19-sudo.png" width="50px" style="border-radius:50%"/></td>
      <td>
        <strong>Huang Yongqingï¼ˆé»„æ°¸åº†ï¼‰</strong><br>
        ä¸­å±±å¤§å­¦ (SYSU) Â· æ™ºèƒ½å·¥ç¨‹å­¦é™¢ Â· æ™ºèƒ½ç§‘å­¦ä¸æŠ€æœ¯ä¸“ä¸š<br>
        ğŸ“§ <a href="mailto:huangyq296@mail2.sysu.edu.cn">huangyq296@mail2.sysu.edu.cn</a><br>
        ğŸ™ <a href="https://github.com/masktrump19-sudo">@masktrump19-sudo</a>
      </td>
    </tr>
  </table>
</div>

### ğŸ™ ç‰¹åˆ«æ„Ÿè°¢

- **[U-Net](https://arxiv.org/abs/1505.04597)** - è¯­ä¹‰åˆ†å‰²ç½‘ç»œæ¶æ„çš„å¼€åˆ›æ€§å·¥ä½œ
- **[Rockchip](https://github.com/rockchip-linux/rknn-toolkit2)** - æä¾›ä¼˜ç§€çš„RKNN-Toolkit2å·¥å…·é“¾
- **[ROS Community](https://www.ros.org/)** - æœºå™¨äººæ“ä½œç³»ç»ŸåŠå…¶ä¸°å¯Œçš„ç”Ÿæ€
- **[OpenCV](https://opencv.org/)** - è®¡ç®—æœºè§†è§‰åŸºç¡€åº“
- **[PyTorch](https://pytorch.org/)** - æ·±åº¦å­¦ä¹ æ¡†æ¶
- **å…¨å›½å¤§å­¦ç”Ÿæ™ºèƒ½æ±½è½¦ç«èµ›ç»„å§”ä¼š** - æä¾›ç«èµ›å¹³å°å’ŒæŠ€æœ¯æŒ‡å¯¼
- **æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®æå‡ºå»ºè®®å’Œè´¡çŒ®ä»£ç çš„å¼€å‘è€…ä»¬**

---

## è®¸å¯è¯

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

æœ¬é¡¹ç›®é‡‡ç”¨ **MIT è®¸å¯è¯** å¼€æºã€‚

```
MIT License

Copyright (c) 2026 Huang Yongqing (é»„æ°¸åº†)

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
```

### ä½ å¯ä»¥è‡ªç”±åœ°ï¼š

| æƒåˆ© | è¯´æ˜ |
|:-----|:-----|
| âœ… å•†ä¸šä½¿ç”¨ | å¯ç”¨äºå•†ä¸šé¡¹ç›® |
| âœ… ä¿®æ”¹ | å¯ä»¥ä¿®æ”¹æºä»£ç  |
| âœ… åˆ†å‘ | å¯ä»¥åˆ†å‘å‰¯æœ¬ |
| âœ… ç§äººä½¿ç”¨ | å¯ç”¨äºç§äººé¡¹ç›® |

### æ¡ä»¶ï¼š

| æ¡ä»¶ | è¯´æ˜ |
|:-----|:-----|
| ğŸ“‹ è®¸å¯è¯å’Œç‰ˆæƒå£°æ˜ | éœ€åœ¨å‰¯æœ¬ä¸­åŒ…å«è®¸å¯è¯å’Œç‰ˆæƒå£°æ˜ |

### ç¬¬ä¸‰æ–¹ä¾èµ–è®¸å¯è¯

| ç»„ä»¶ | è®¸å¯è¯ | é“¾æ¥ |
|:-----|:-------|:-----|
| PyTorch | BSD-3-Clause | [pytorch.org](https://pytorch.org/) |
| RKNN-Toolkit2 | Apache-2.0 | [GitHub](https://github.com/rockchip-linux/rknn-toolkit2) |
| OpenCV | Apache-2.0 | [opencv.org](https://opencv.org/) |
| ROS | BSD | [ros.org](https://www.ros.org/) |
| NumPy | BSD-3-Clause | [numpy.org](https://numpy.org/) |

---

## è”ç³»æ–¹å¼

<div align="left">
  <table>
    <tr>
      <td>ğŸ“§ <strong>Email</strong></td>
      <td><a href="mailto:huangyq296@mail2.sysu.edu.cn">huangyq296@mail2.sysu.edu.cn</a></td>
    </tr>
    <tr>
      <td>ğŸ™ <strong>GitHub</strong></td>
      <td><a href="https://github.com/masktrump19-sudo">@masktrump19-sudo</a></td>
    </tr>
    <tr>
      <td>ğŸ› <strong>Issues</strong></td>
      <td><a href="https://github.com/masktrump19-sudo/unet-lane-detection/issues">æŠ¥å‘ŠBugæˆ–æå‡ºå»ºè®®</a></td>
    </tr>
  </table>
</div>

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

1. **GitHub Issues** - æŠ€æœ¯é—®é¢˜ã€BugæŠ¥å‘Šã€åŠŸèƒ½å»ºè®®
2. **Email** - å­¦æœ¯åˆä½œã€æ·±å…¥è®¨è®º
3. **Pull Request** - ä»£ç è´¡çŒ® 

---

**å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª â­ Starï¼**
